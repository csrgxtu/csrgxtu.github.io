<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>csrgxtu</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-09-23T17:55:12.026Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Archer Reilly</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>How coroutine works internally [Drafting]</title>
    <link href="http://yoursite.com/2020/05/07/How-coroutine-works-internally/"/>
    <id>http://yoursite.com/2020/05/07/How-coroutine-works-internally/</id>
    <published>2020-05-07T02:47:51.000Z</published>
    <updated>2020-09-23T17:55:12.026Z</updated>
    
    <content type="html"><![CDATA[<p>Coroutines are generalization of subroutines. they are used for cooperative multitasking where a process voluntarily yield(give away) control periodically or when idle in order to enable multiple applications to be run simultaneously. compare to thread, coroutine is context-swtich in User space by programming language or by programmer itself, but thread is managed by OS. but anyway, do you know how Python implements coroutine? or how can it yield control away and lately resume back?</p><h3 id="A-simple-usage-example"><a href="#A-simple-usage-example" class="headerlink" title="A simple usage example"></a>A simple usage example</h3><h3 id="The-Internal"><a href="#The-Internal" class="headerlink" title="The Internal"></a>The Internal</h3><h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><p><a href="https://www.geeksforgeeks.org/coroutine-in-python/" target="_blank" rel="noopener">coroutine in python</a>  </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Coroutines are generalization of subroutines. they are used for cooperative multitasking where a process voluntarily yield(give away) con
      
    
    </summary>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
      <category term="coroutine" scheme="http://yoursite.com/tags/coroutine/"/>
    
  </entry>
  
  <entry>
    <title>Stop naming your modules utils [è½¬]</title>
    <link href="http://yoursite.com/2020/04/21/Stop-naming-your-modules-utils/"/>
    <id>http://yoursite.com/2020/04/21/Stop-naming-your-modules-utils/</id>
    <published>2020-04-21T08:39:53.000Z</published>
    <updated>2020-09-23T17:55:12.030Z</updated>
    
    <content type="html"><![CDATA[<p>çœ‹åˆ°è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œå†…å¿ƒæ˜¯å´©æºƒçš„ï¼Œé‡Œé¢è¯´çš„bad practiceæˆ‘ä»¬ç›®å‰é¡¹ç›®ä¸­éƒ½æœ‰ï¼Œä¸€ä¸ªä¸è½ã€‚å°±åƒå†™å‡ºäº†éPythonicçš„ä»£ç ï¼Œå®ƒæ²¡æœ‰validate Python Grammerï¼Œå¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä½†å°±æ˜¯ç»´æŠ¤èµ·æ¥è´¹åŠ²ã€‚æ‰€ä»¥è¯´åœ¨æ­£ç¡®çš„å‰æä¸‹ï¼Œæˆ‘ä»¬è¦å°½é‡åœ¨å·¥ç¨‹ä¸­åšåˆ°è¿™äº›Best Praciceè¯´åˆ°çš„ä¸œè¥¿ã€‚</p><a id="more"></a><p>æ€»ç»“åŸæ–‡å°±æ˜¯æˆ‘ä»¬ä¼šåœ¨æŸäº›æƒ…å†µä¸‹å°†ä¸€äº›é€šç”¨çš„æˆ–è€…æ— æ³•å½’ç±»çš„é€»è¾‘æ”¾åœ¨è¯¸å¦‚ï¼š<code>util</code>, <code>common</code>ç­‰æ¨¡å—ä¸­</p><ul><li>å•ä¸ªæ— æ³•å½’ç±»çš„functionæ”¾å…¥utilä¸­</li><li>å¤šä¸ªæ¨¡å—å…¬ç”¨çš„å°±æ”¾åœ¨äº†commonä¸­</li></ul><p>ç„¶ååç»­çš„programmerå› ä¸ºè¿™ä¸ªä¼šç»§ç»­å‘utilä¸­æ·»åŠ å¾ˆå¤šé€»è¾‘ï¼Œä¹…è€Œä¹…ä¹‹å…¶å˜çš„æ›´åŠ å¤šå…ƒåŒ–ï¼Œä¸ç¡®å®šã€‚å½“ä½ çœ‹åˆ°è¿™ä¸ªæ¨¡å—çš„æ—¶å€™ï¼Œä½ æ— æ³•ç¡®å®šå…¶å…·ä½“å®ç°äº†ä»€ä¹ˆåŠŸèƒ½ï¼Œåœ¨å…¶å®ƒé¡¹ç›®æ¨¡å—éœ€è¦ä½¿ç”¨util or commonä¸­çš„æ–¹æ³•çš„æ—¶å€™éœ€è¦å°†å…¶æ•´ä½“å¼•å…¥çš„é¡¹ç›®ä¸­ï¼Œå¢åŠ äº†ä»£ç å¤æ‚åº¦ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œæ ¹æ®Pythonçš„å“²å­¦ï¼šExplicit is better than implicitï¼Œæˆ‘ä»¬åº”è¯¥ä¿æŒé¡¹ç›®çš„ç®€ä»‹æ¸…æ™°ï¼Œå°½é‡é¿å…ä¸€äº›æ¨¡æ£±ä¸¤å¯çš„ä¸œè¥¿ã€‚</p><p>ä¸‹é¢æ˜¯åŸæ–‡ï¼š<br>Imagine the following situation: there is a software developer that is either adding new code or refactoring existing one by extracting a class/function. They have to place code somewhere, but it does not seem to fit anywhere. So what does a developer do? They create a new module â€“ utils.py.</p><h3 id="Why-utils-is-a-terrible-name"><a href="#Why-utils-is-a-terrible-name" class="headerlink" title="Why utils is a terrible name?"></a>Why utils is a terrible name?</h3><p>utils is arguably one of the worst names for a module because it is very blurry and imprecise. Such a name does not say what is the purpose of code inside. On the contrary, a utils module can as well contain almost anything. By naming a module utils, a software developer lays down perfect conditions for an incohesive code blob. Since the module name does not hint team members if something fits there or not, it is likely that unrelated code will eventually appear there, as more utils. More on it later.</p><p>Synonyms of utils, like helpers, commons, etc. are bad for the same reason.</p><h3 id="Why-people-do-this"><a href="#Why-people-do-this" class="headerlink" title="Why people do this?"></a>Why people do this?</h3><h4 id="Excuse-I-â€“-it-is-just-one-function"><a href="#Excuse-I-â€“-it-is-just-one-function" class="headerlink" title="Excuse I â€“ it is just one function"></a>Excuse I â€“ it is just one function</h4><p>Initially, yes â€“ it may be just one function. One function in a badly named module is not that wrong, isnâ€™t it?</p><p>It is. Similarly to the broken windows theory, one occurrence of misbehaviour invites more of them. One function or class in utils is a small problem, indeed. Hence, it should be refactored when it is easy. Once the utils module grows, it will require a lot more effort to split it. And surprise, surprise, no one will be willing to do that.</p><p>How bad it can get? Once, in one Python repository, I saw there were several utils.py modules. My favourite contained 13 various functions and one utility class. What were these functions doing? Everything, from validation to data normalization to saving to the database to sending HTTP requests to getting current datetime formatted accordingly to the format parameter (Yes, separate, loose functions).</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_post_request</span><span class="params">(url, data, logger)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_details</span><span class="params">(source_obj, override_data_from_source_obj: dict = None)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">normalize_address</span><span class="params">(address: str)</span> -&gt; str:</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>Thatâ€™s how programming hell looks like. utils.py quickly becomes a whirlpool for all code that does not fit other places. It smoothly leads us to excuse number 2â€¦</p><h4 id="Excuse-II-â€“-There-is-no-other-place-to-put-this-code"><a href="#Excuse-II-â€“-There-is-no-other-place-to-put-this-code" class="headerlink" title="Excuse II â€“ There is no other place to put this code"></a>Excuse II â€“ There is no other place to put this code</h4><p>Indeed, there may be no place that a new class/function fits. Reaction to create a new place for the code is good. However, a programmer needs to put more effort when thinking about the name. As we know, taking the easiest road with utils is a slippery slope.</p><p>We can do better by naming module by the purpose of functions living inside. If they will be creating other objects, letâ€™s name it factories.py. If their role is validation â€“ go for validators.py. Maybe we need a few functions that operate on phone numbers? See if they could not be a regular, stateful class PhoneNumber and just put it in a separate file â€“ phone_number.py.</p><p>A special case â€“ functions with business logic. There are many techniques for that, some of them are more sophisticated than others (e.g. the Clean Architecture) but letâ€™s consider a simple case. Assuming we have Django + DRF web application that contains business logic in serializers. We slowly migrate our API to version 2 and we need to put business logic extracted from V1 serializer in some other place, so that serializer V2 may reuse that. DO NOT PUT THIS IN utils.py. Try putting business logic in services.py module. Name service comes from an application service â€“ a single thing that the application does for the clients. If this was, for example, booking a flight, a service could be named flight_booking_service and would:</p><ul><li>authorize payment on customerâ€™s payment card</li><li>reserve a flight using 3rd party provider</li><li>send an email (or scheduled a Celery task to do so)</li></ul><h4 id="Excuse-III-I-need-a-place-for-company-commons"><a href="#Excuse-III-I-need-a-place-for-company-commons" class="headerlink" title="Excuse III I need a place for company commons"></a>Excuse III I need a place for company commons</h4><p>Letâ€™s say you are building a distributed application and there are chunks of code that needs to be reused in a majority or all microservices. It is a natural reaction to put them together in someplace, like a separate repository to be installed as a package. But please donâ€™t call it {company_name}-utils. I heard about a case of such a repository, but luckily for its maintainers, it was not that big. It contains code responsible for:</p><p>secrets handling, using public cloud services<br>logging configuration that uses specific public services<br>As I said, itâ€™s not that bad but it would be nice if they were more specific with the name, for example, cloud-toolkit or split that into two separate repositories/packages because frankly there are microservices that use only one of functionalities.</p><h4 id="Excuse-IIII-â€“-But-Django-does-that"><a href="#Excuse-IIII-â€“-But-Django-does-that" class="headerlink" title="Excuse IIII â€“ But Django does that"></a>Excuse IIII â€“ But Django does that</h4><p>Yes, there is a couple of utils packages in Django. Shame on them for using utils name. However, notice that at least some of them could be separated from the framework and bundled as optional dependencies. Also, at least they are grouped in cohesive sub-packages â€“ e.g. django.utils.timezone or django.utils.translation.</p><p>Unless you are writing a framework, stay away from utils. ğŸ˜‰</p><h4 id="Are-all-utils-bad"><a href="#Are-all-utils-bad" class="headerlink" title="Are all utils bad?"></a>Are all utils bad?</h4><p>Not exactly. Eventually, one may need a couple of auxiliary functions. In that case, organize such code in modules named by theme â€“ like datetimes, phone_numbers, etc. Such functions should be pure (in terms of functional programming).</p><p>Pure Functions â€“ do not have side effects, that is, they do not change the state of the program. Given the same input, a pure function will always produce the same output.</p><p><a href="https://stackabuse.com/functional-programming-in-python/" target="_blank" rel="noopener">https://stackabuse.com/functional-programming-in-python/</a></p><h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>Do not use utils as a name for your Python module neither put it into a class name. Try to be more specific about the role of code â€“ e.g. create a place for validators, services or factories. If the role criterion doesnâ€™t help and you really dealing with utils, try grouping code by its theme â€“</p><p>utils modules are dangerous, because they deteriorate over time. Each and another person that adds something that does not fit anywhere will happily add it to the utils module, increasing its incohesion. The disorder will grow over time, becoming greater and greater burden to work with.</p><p>If you see a newly created utils module in a code review, request it to be renamed. If you are tempted to add something to existing utils, create a new place for your code and move there everything from utils that fits a newly created module.</p><p>In the end, you will exercise your brain to become better at designing code.</p><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://breadcrumbscollector.tech/stop-naming-your-python-modules-utils/" target="_blank" rel="noopener">Stop naming your python module â€˜utilsâ€™</a><br><a href="http://www.adam-bien.com/roller/abien/entry/util_packages_are_evil" target="_blank" rel="noopener">Util package are evil</a>  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;çœ‹åˆ°è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œå†…å¿ƒæ˜¯å´©æºƒçš„ï¼Œé‡Œé¢è¯´çš„bad practiceæˆ‘ä»¬ç›®å‰é¡¹ç›®ä¸­éƒ½æœ‰ï¼Œä¸€ä¸ªä¸è½ã€‚å°±åƒå†™å‡ºäº†éPythonicçš„ä»£ç ï¼Œå®ƒæ²¡æœ‰validate Python Grammerï¼Œå¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä½†å°±æ˜¯ç»´æŠ¤èµ·æ¥è´¹åŠ²ã€‚æ‰€ä»¥è¯´åœ¨æ­£ç¡®çš„å‰æä¸‹ï¼Œæˆ‘ä»¬è¦å°½é‡åœ¨å·¥ç¨‹ä¸­åšåˆ°è¿™äº›Best Praciceè¯´åˆ°çš„ä¸œè¥¿ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Software Engeering" scheme="http://yoursite.com/tags/Software-Engeering/"/>
    
      <category term="Best practice" scheme="http://yoursite.com/tags/Best-practice/"/>
    
  </entry>
  
  <entry>
    <title>Python Dict: a new implementation by pure Python</title>
    <link href="http://yoursite.com/2020/04/21/Python-Dict-a-new-implementation-by-pure-Python/"/>
    <id>http://yoursite.com/2020/04/21/Python-Dict-a-new-implementation-by-pure-Python/</id>
    <published>2020-04-21T06:57:23.000Z</published>
    <updated>2020-09-23T17:55:12.030Z</updated>
    
    <content type="html"><![CDATA[<p>Python have builtin implementation for <code>dict</code>, which is used to store key-value and also provided other related operations. Due to it is an frequenctly used basic data type, here I will use pure Python implement an <code>dict</code>.</p><a id="more"></a><h3 id="Hash-map"><a href="#Hash-map" class="headerlink" title="Hash map"></a>Hash map</h3><p>As we learned from data structure, hash map is a data structure that can be used to store key-value and later retrieve value by key from it with almost constant O(1) time.</p><p>A hash map use a <code>hash</code> function to compute an index, also called hash code into an array of buckets or slots from which the desired value can be found.  </p><p>Ideally the hash function will assign each key to a unique bucket, but most hash table use an imperfect hash function, which might cuz hash collisions where the hash function will generates the same index for different keys.  </p><p>In a well-dimensioned hash map, the average cost for each look up is constant and also allow arbitrary insertions and deletions of key-value pairs in constant time.</p><p>Basically, it will have following complexity:</p><table><thead><tr><th align="center"></th><th>Avg</th><th>Worst</th></tr></thead><tbody><tr><td align="center">Space</td><td>O(n)</td><td>O(n)</td></tr><tr><td align="center">Search</td><td>O(1)</td><td>O(n)</td></tr><tr><td align="center">Insert</td><td>O(1)</td><td>O(n)</td></tr><tr><td align="center">Delete</td><td>O(1)</td><td>O(n)</td></tr></tbody></table><p>To summary, it will have an hash function, also need an storage. when hash collisions, need to solve the collisions somehow. for more detail, read the reference.</p><h3 id="Basic-version"><a href="#Basic-version" class="headerlink" title="Basic version"></a>Basic version</h3><p>So, basicly we need solve three things:</p><ul><li>a hash function that will take key as input and output an index</li><li>a storage which will be used to hold the key-value pairs</li><li>how to solve hash collision</li></ul><p>for first prolem, we can use Pythonâ€™s built-in method <code>hash</code> which will take input and output the index for us.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">hash</span>(...)</span><br><span class="line">    <span class="built_in">hash</span>(object) -&gt; <span class="built_in">integer</span></span><br><span class="line"></span><br><span class="line">    Return a <span class="built_in">hash</span> value <span class="keyword">for</span> the object.  Two objects with the same value have</span><br><span class="line">    the same <span class="built_in">hash</span> value.  The reverse is not necessarily <span class="literal">true</span>, but likely.</span><br></pre></td></tr></table></figure><p>for second problem, we use Pythonâ€™s <code>list</code> as the storage, we store the <code>[key, value]</code> into this list. we will hash key and get an index, use this index as the <code>list</code> index.</p><p>for third problem, if multiple key hashed into same index, we use a sub_list in <code>storage[index]</code> to chain multiple key-value pairs into that sub_list. here is a image which shows how to use chainning solve the collision:<br><img src="https://media.geeksforgeeks.org/wp-content/cdn-uploads/gq/2015/07/hashChaining1.png" alt="chainning collision solver"> </p><p>To set key-value and get value by key like defeault dict <code>data_map[&#39;name&#39;] = &#39;shopee&#39;</code> <code>data[&#39;name&#39;]</code>, we need implement magic methods <code>__setitem__</code> and <code>__getitem__</code>, here is the basic implementation:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">my implementation for dict</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dictionary</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    implementation for dict</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, size=<span class="number">1000</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        use list as storage, each element is also a list which is used</span></span><br><span class="line"><span class="string">        to solve hash conflict</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.storage = [[] <span class="keyword">for</span> _ <span class="keyword">in</span> range(size)]</span><br><span class="line">        self.size = size</span><br><span class="line">        self.length = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        set key value, if conflict, append to the sub list</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        storage_idx = hash(key) % self.size</span><br><span class="line">        <span class="keyword">for</span> ele <span class="keyword">in</span> self.storage[storage_idx]:</span><br><span class="line">            <span class="keyword">if</span> key == ele[<span class="number">0</span>]:  <span class="comment"># already exist, update it</span></span><br><span class="line">                ele[<span class="number">1</span>] = value</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.storage[storage_idx].append([key, value])</span><br><span class="line">            self.length += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get by key, if not found, raise key error</span></span><br><span class="line"><span class="string">        :raise: KeyError</span></span><br><span class="line"><span class="string">        :return: value</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        storage_idx = hash(key) % self.size</span><br><span class="line">        <span class="keyword">for</span> ele <span class="keyword">in</span> self.storage[storage_idx]:</span><br><span class="line">            <span class="keyword">if</span> ele[<span class="number">0</span>] == key:</span><br><span class="line">                <span class="keyword">return</span> ele[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">raise</span> KeyError(<span class="string">'Key &#123;&#125; dont exist'</span>.format(key))</span><br></pre></td></tr></table></figure><p>Here use ipython and test our <code>Dictionary</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ipython</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">In [1]: from dictionary import Dictionary</span><br><span class="line"></span><br><span class="line">In [2]: d = Dictionary()</span><br><span class="line"></span><br><span class="line">In [3]: d[<span class="string">'name'</span>] = <span class="string">'shopee'</span></span><br><span class="line"></span><br><span class="line">In [4]: d[<span class="string">'age'</span>] = 22</span><br><span class="line"></span><br><span class="line">In [5]: d[<span class="string">'name'</span>]</span><br><span class="line">Out[5]: <span class="string">'shopee'</span></span><br></pre></td></tr></table></figure><p>It is workable now, but not perfect yet, like we isnt implement other operations related to <code>dict</code> yet.</p><h3 id="More-magic-methods"><a href="#More-magic-methods" class="headerlink" title="More magic methods"></a>More magic methods</h3><p>The default dict also supports following:</p><ul><li>check if key in current dict</li><li>iterate over keys</li><li>iterate over values</li><li>iterate over key-value pairs</li><li>delete item by key</li><li>get length of current dict</li><li>string representation of current dict<br>to implement upper functionalities, we can use Pythonâ€™s magic methods, for example, for iterator related functionalities, we can use <code>__iter__</code>, for string representation functionality, we can use <code>__str__</code> or <code>__repr__</code>. for checking the key in current dict, we can use <code>__contains__</code>. here is the detailed implementation:</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">my implementation for dict</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dictionary</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    implementation for dict</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        delete key value from current dictionary instance</span></span><br><span class="line"><span class="string">        :param key: str</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        storage_idx = hash(key) % self.size</span><br><span class="line">        <span class="keyword">for</span> sub_lst <span class="keyword">in</span> self.storage[storage_idx]:</span><br><span class="line">            <span class="keyword">if</span> key == sub_lst[<span class="number">0</span>]:</span><br><span class="line">                self.storage[storage_idx].remove(sub_lst)</span><br><span class="line">                self.length -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">raise</span> KeyError(<span class="string">'Key &#123;&#125; dont exist'</span>.format(key))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__contains__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        check if key exist in current diction</span></span><br><span class="line"><span class="string">        :param key: str</span></span><br><span class="line"><span class="string">        :return: boolean</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        storage_idx = hash(key) % self.size</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> self.storage[storage_idx]:</span><br><span class="line">            <span class="keyword">if</span> item[<span class="number">0</span>] == key:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        return length</span></span><br><span class="line"><span class="string">        :return: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> self.length</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iterate_kv</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        return an iterator</span></span><br><span class="line"><span class="string">        :return: generator</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> sub_lst <span class="keyword">in</span> self.storage:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> sub_lst:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> sub_lst:</span><br><span class="line">                <span class="keyword">yield</span> item</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        return an iterator</span></span><br><span class="line"><span class="string">        :return: generator</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> key_var <span class="keyword">in</span> self.__iterate_kv():</span><br><span class="line">            <span class="keyword">yield</span> key_var[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">keys</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get all keys as list</span></span><br><span class="line"><span class="string">        :return: list</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> self.__iter__()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">values</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get all values as list</span></span><br><span class="line"><span class="string">        :return: list</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> key_var <span class="keyword">in</span> self.__iterate_kv():</span><br><span class="line">            <span class="keyword">yield</span> key_var[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">items</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get all k:v as list</span></span><br><span class="line"><span class="string">        :return: list</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> self.__iterate_kv()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get value by key</span></span><br><span class="line"><span class="string">        :param key: str</span></span><br><span class="line"><span class="string">        :return: value</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self.__getitem__(key)</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        str representation of the dictionary</span></span><br><span class="line"><span class="string">        :return: string</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        res = []</span><br><span class="line">        <span class="keyword">for</span> ele <span class="keyword">in</span> self.storage:</span><br><span class="line">            <span class="keyword">for</span> key_value <span class="keyword">in</span> ele:</span><br><span class="line">                <span class="keyword">if</span> isinstance(key_value[<span class="number">0</span>], str):</span><br><span class="line">                    key_str = <span class="string">'\'&#123;&#125;\''</span>.format(key_value[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    key_str = <span class="string">'&#123;&#125;'</span>.format(key_value[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">if</span> isinstance(key_value[<span class="number">1</span>], str):</span><br><span class="line">                    value_str = <span class="string">'\'&#123;&#125;\''</span>.format(key_value[<span class="number">1</span>])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    value_str = <span class="string">'&#123;&#125;'</span>.format(key_value[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">                res.append(<span class="string">'&#123;&#125;: &#123;&#125;'</span>.format(key_str, value_str))</span><br><span class="line">        key_value_pairs_str = <span class="string">'&#123;&#125;'</span>.format(<span class="string">', '</span>.join(res))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&#123;'</span> + key_value_pairs_str + <span class="string">'&#125;'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        string representation of the class instances</span></span><br><span class="line"><span class="string">        :return: string</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> self.__str__()</span><br></pre></td></tr></table></figure><p>To test it, we try to iterate the dict and check if it contains the key:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">In [6]: <span class="keyword">for</span> key <span class="keyword">in</span> d.keys():</span><br><span class="line">   ...:     <span class="built_in">print</span> <span class="string">'&#123;&#125; : &#123;&#125;'</span>.format(key, d.get(key))</span><br><span class="line">   ...:</span><br><span class="line">name : shopee</span><br><span class="line">age : 22</span><br><span class="line"></span><br><span class="line">In [7]: d</span><br><span class="line">Out[7]: &#123;<span class="string">'name'</span>: <span class="string">'shopee'</span>, <span class="string">'age'</span>: 22&#125;</span><br><span class="line"></span><br><span class="line">In [8]: <span class="string">'name'</span> <span class="keyword">in</span> d</span><br><span class="line">Out[8]: True</span><br></pre></td></tr></table></figure><h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>So, this is just a simple implementation of Python dict by using Pythonâ€™s list and hash built-ins. to extend, you can also implement <code>clean</code>, <code>update</code> etc. i am also curious how to replace the default <code>dict</code> in CPython with my own implementation?</p><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://en.wikipedia.org/wiki/Hash_table" target="_blank" rel="noopener">Hash table</a><br><a href="https://www.laurentluce.com/posts/python-dictionary-implementation/" target="_blank" rel="noopener">Python dictionary implementation</a><br><a href="https://github.com/python/cpython/blob/master/Objects/dictobject.c" target="_blank" rel="noopener">CPython dictobject.c</a><br><a href="https://old-panda.com/2018/12/16/python-magic-methods/" target="_blank" rel="noopener">Python magic methods</a>  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Python have builtin implementation for &lt;code&gt;dict&lt;/code&gt;, which is used to store key-value and also provided other related operations. Due to it is an frequenctly used basic data type, here I will use pure Python implement an &lt;code&gt;dict&lt;/code&gt;.&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
      <category term="Dict" scheme="http://yoursite.com/tags/Dict/"/>
    
  </entry>
  
  <entry>
    <title>Gevent: patch it and pray</title>
    <link href="http://yoursite.com/2020/04/16/Gevent-patch-it-and-pray/"/>
    <id>http://yoursite.com/2020/04/16/Gevent-patch-it-and-pray/</id>
    <published>2020-04-16T09:42:36.000Z</published>
    <updated>2020-09-23T17:55:12.026Z</updated>
    
    <content type="html"><![CDATA[<p>To speedup the IO related operations in our project, we use Gevent and patch_all in Django. but it also makes project more complicated, especially when a new maintainer trying to figure out how the multi-threading process works without knowing the patch. So Guido van Rossum once said: when you use gevent in your project, once after patch, god knows what will happen later. i.e Patch it and Pray!!! and also for other reasons, this way isnâ€™t a Pythonic way. here in this post, letâ€™s see how it works, why it is bad.</p><a id="more"></a><h3 id="Whatâ€™s-monkey-patch"><a href="#Whatâ€™s-monkey-patch" class="headerlink" title="Whatâ€™s monkey patch"></a>Whatâ€™s monkey patch</h3><p>In Python, monkey patch is simply the dynamic replacement of attributes at runtime. for instance, consider a class that has a method <code>get_data</code>. this method does an external lookup(on a database or web api, for example), and vrious other methods in the class call it. However, in a unit test, you donâ€™t want to depend on the external data source - so you dynamically replace the <code>get_data</code> method with a stub that returns fixed data.  </p><p>Becuase Python classes are mutable, and methods are just attributes of the class, you can do this as much as you like - and, in fact, you can even replace classes and functions in a module in exactly the same way. here is the example of Patch in Python, when in test/dev env, it will use <code>DataManagerPatcher.get_data</code> which will return mock data.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataManager</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get data from http api</span></span><br><span class="line"><span class="string">        :return: str</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        resp = requests.get(<span class="string">'https://google.com'</span>)</span><br><span class="line">        <span class="keyword">return</span> resp.content</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataManagerPatcher</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get data mock</span></span><br><span class="line"><span class="string">        :return: str</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;html&gt;&lt;/html&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">patch</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        path the get_data with mock method</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        DataManager.get_data = cls.get_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># if test/dev env, need use mock data</span></span><br><span class="line">    <span class="keyword">if</span> os.get(<span class="string">'env'</span>) <span class="keyword">in</span> [<span class="string">'DEV'</span>, <span class="string">'TEST'</span>]:</span><br><span class="line">        DataManagerPatcher.patch()</span><br><span class="line"></span><br><span class="line">    DataManager.get_data()</span><br></pre></td></tr></table></figure><p>But why monkey patch can work in Python like this? it is NameSpace. In python both attributes and methods are called attributes, they have name bind to object. and Python use namespaces to implement this scoping. it is a dict like data structure with each name as key and object as value. when you access an attribute, Python VM will lookup the namespace and call the corresponding object. if no name found, you got a <code>NameError</code> exception. also it following LEGB rules, which is :</p><p><img src="https://blog.confirm.ch/wp-content/uploads/2017/08/python_namespaces_legb.jpg" alt="LEGB">  </p><p>So, patch is achived by replace the name-object binding in current processâ€™s namespace. but use caution when monkey patching due to following reasons:  </p><ul><li>if anything else besides your test logic calls <code>get_data</code> as well, it will also call your monkey-patched replacement rather than the original â€“ which can be good or bad, just beware.</li><li>if some variable or attribute exists that also points to the <code>get_data</code> function by the time you replace it, this alias will not change its meaning and will continue to point to the original <code>get_data</code>. (Python already have that binding)</li></ul><h3 id="How-Gevent-work"><a href="#How-Gevent-work" class="headerlink" title="How Gevent work"></a>How Gevent work</h3><p>Gevent is a co-routine based Python networking library that uses greenlet to provide a high level synchronous API on top of the libev or libuv event loop which implements asynchronous I/O model. basicly, it use eventloop schedule co-routines, and co-routine will replase control when entring I/O to event loop. for more detail, here i recommend<br>Kavyaâ€™s <a href="https://www.youtube.com/watch?v=GunMToxbE0E&t=1536s" target="_blank" rel="noopener">A deep dive into how gevent works</a>.  </p><p>And with monkey-patching, gevent can replace the corresponding 3rd party lib method. your request eventually gose to Geventâ€™s corresonding method.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey; monkey.patch_all()</span><br><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(url)</span>:</span></span><br><span class="line">    print(<span class="string">'GET: %s'</span> % url)</span><br><span class="line">    resp = urllib2.urlopen(url)</span><br><span class="line">    data = resp.read()</span><br><span class="line">    print(<span class="string">'%d bytes received from %s.'</span> % (len(data), url))</span><br><span class="line"></span><br><span class="line">gevent.joinall([</span><br><span class="line">        gevent.spawn(f, <span class="string">'https://www.python.org/'</span>),</span><br><span class="line">        gevent.spawn(f, <span class="string">'https://www.yahoo.com/'</span>),</span><br><span class="line">        gevent.spawn(f, <span class="string">'https://github.com/'</span>),</span><br><span class="line">])</span><br></pre></td></tr></table></figure><h3 id="The-bad"><a href="#The-bad" class="headerlink" title="The bad"></a>The bad</h3><p>Why it is bad? for following reasons:</p><ul><li>Python3 already support asynchronous I/O model, you should use it instead of 3rd party lib: Gevent</li><li>Gevent only works on CPython, not support other Python intepreter like PyPy or Jthonâ€¦</li><li>Dynamic replace change the binding between name-object is a bad idea, it will confuse other people<br>it validates <em>The Zen of Python</em>:</li><li>Explicit is better than implicit</li><li>If the implementation is hard to explain, itâ€™s a bad idea.</li></ul><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://www.youtube.com/watch?v=GunMToxbE0E&t=1536s" target="_blank" rel="noopener">A deep dive into how gevent works</a><br><a href="https://zpzhou.com/archives/monkey_patch.html" target="_blank" rel="noopener">Monkey patch è§£æƒ‘</a><br><a href="https://blog.confirm.ch/python-namespaces/" target="_blank" rel="noopener">Python namespaces</a><br><a href="http://www.gevent.org/" target="_blank" rel="noopener">gevent.org</a>  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;To speedup the IO related operations in our project, we use Gevent and patch_all in Django. but it also makes project more complicated, especially when a new maintainer trying to figure out how the multi-threading process works without knowing the patch. So Guido van Rossum once said: when you use gevent in your project, once after patch, god knows what will happen later. i.e Patch it and Pray!!! and also for other reasons, this way isnâ€™t a Pythonic way. here in this post, letâ€™s see how it works, why it is bad.&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
      <category term="Gevent" scheme="http://yoursite.com/tags/Gevent/"/>
    
      <category term="Patch" scheme="http://yoursite.com/tags/Patch/"/>
    
  </entry>
  
  <entry>
    <title>Gunicorn, an inside view of it</title>
    <link href="http://yoursite.com/2020/04/10/Gunicorn-an-inside-view-of-it/"/>
    <id>http://yoursite.com/2020/04/10/Gunicorn-an-inside-view-of-it/</id>
    <published>2020-04-09T23:13:00.000Z</published>
    <updated>2020-09-23T17:55:12.026Z</updated>
    
    <content type="html"><![CDATA[<p>Gunicorn æ˜¯ä¸€ä¸ªPython Web Serverå®ç°ï¼Œå…¼å®¹WSGIåè®®ã€‚å…¶è¿ç§»è‡ªRubyä¸–ç•Œçš„Unicornã€‚åœ¨æˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæœ‰å¤§é‡ä½¿ç”¨Gunicornä½œä¸ºWeb æœåŠ¡å™¨ï¼Œæ‰€ä»¥æœ¬æ–‡åˆ†æGunicornçš„ç›¸å…³å‡ ä¸ªé—®é¢˜ï¼š Server modelï¼ŒAsync worker.</p><a id="more"></a><h3 id="Server-model"><a href="#Server-model" class="headerlink" title="Server model"></a>Server model</h3><p>å¦‚æœä½ å†™è¿‡socketç¼–ç¨‹ï¼Œåº”è¯¥çŸ¥é“socket serverä¸€èˆ¬æ˜¯å¦‚ä½•æ”¯æŒå¹¶å‘çš„ï¼Œæ¯”å¦‚åœ¨socket serverå¯åŠ¨åï¼Œä¼šå¯¹æ¯ä¸€ä¸ªè¿›æ¥çš„è¯·æ±‚forkä¸€ä¸ªæ–°çš„è¿›ç¨‹æˆ–è€…çº¿ç¨‹å»å¤„ç†å®ƒã€‚ä½†æ˜¯è¿™ç§å®ç°å­˜åœ¨é—®é¢˜ï¼Œæ¯”å¦‚é«˜å¹¶å‘é‡æƒ…å†µä¸‹ï¼Œsocket serverä¸å¾—ä¸åˆ›å»ºå¾ˆå¤šè¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œåˆ›å»ºè¿›ç¨‹æˆ–è€…çº¿ç¨‹éœ€è¦sys callï¼Œå¤§é‡çš„åˆ›å»ºæˆ–è€…é”€æ¯ä¼šä½¿ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ï¼Œè¿›è€Œå¤„ç†è¯·æ±‚èƒ½åŠ›ä¸‹é™ã€‚æé™æƒ…å†µæ˜¯å¯ä»¥åˆ›å»ºçš„è¿›ç¨‹çº¿ç¨‹æ•°é‡ä¼šè¾¾åˆ°OSçš„limitè¿›è€Œç¨‹åºå´©æºƒï¼Œæˆ–è€…å¤§é‡çš„è¿›ç¨‹çº¿ç¨‹ä¹‹é—´åˆ‡æ¢è€—è´¹å¤ªå¤šèµ„æºï¼ˆæˆ‘ä»¬çŸ¥é“OS è¿›ç¨‹ç®¡ç†å™¨åœ¨åšswitchæ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦ä¿å­˜å½“å‰è¿›ç¨‹çš„çŠ¶æ€åˆ°å†…å­˜æ•°æ®ç»“æ„ä¸­ï¼Œç„¶åå°†readyçš„è¿›ç¨‹ç›¸å…³èµ„æºloadè¿›å…¥ç›¸å…³å¤„ç†å™¨ï¼‰ã€‚  </p><p>ä¸€ç§æ”¹è¿›çš„æ–¹æ¡ˆæ˜¯æ± åŒ–å¤ç”¨ã€‚åˆ›å»ºå›ºå®šæ•°é‡çš„è¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œæ‰€æœ‰å¹¶å‘è¿›æ¥çš„è¯·æ±‚éƒ½è½®æµä½¿ç”¨æ± å­ä¸­çš„è¿›ç¨‹çº¿ç¨‹å¤„ç†ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œè¿›ç¨‹çº¿ç¨‹åªä¼šåˆ›å»ºä¸€æ¬¡ï¼Œåç»­ä¼šè¢«è¯·æ±‚å¤ç”¨ï¼Œåœ¨æ•´ä¸ªæœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸçš„æœ€åé˜¶æ®µæ‰ä¼šè¢«é”€æ¯ã€‚è¿™ç§ä¼˜åŒ–æ€æƒ³åœ¨å·¥ç¨‹ä¸­çš„å¾ˆå¤šåœ°æ–¹éƒ½æœ‰ä½¿ç”¨ï¼Œæ¯”å¦‚Web appåˆ°æ•°æ®åº“ä¼šæœ‰ä¸€ä¸ªè¿æ¥æ± ï¼ŒDjango celeryæ¨¡å‹ä¸­ä¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—æ± åŒ–å¾…å¤„ç†çš„ä»»åŠ¡ç­‰ç­‰ã€‚</p><p>å¦‚æœå¤§éƒ¨åˆ†è¯·æ±‚å¤„ç†æ¶‰åŠIOï¼Œé‚£ä¹ˆæ›´åŠ ä¼˜åŒ–çš„æ–¹æ¡ˆæ˜¯é€šè¿‡OSæä¾›çš„IOå¤ç”¨æœºåˆ¶ï¼ˆselect/poll/epollï¼‰æ¥å¤„ç†ã€‚åœ¨ä¸€ä¸ªæœåŠ¡ä¸»å¾ªç¯ä¸­ï¼ŒIO multiplexingä¼šè¿”å›å½“å‰å¯è¯»å¯å†™çš„socketï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥ä½¿ç”¨å¯¹åº”handlerå¤„ç†æ–¹æ³•å¤„ç†readã€write readyçš„socketã€‚è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯å•è¿›ç¨‹å³å¯æ”¯æŒå¾ˆé«˜çš„å¹¶å‘é‡ï¼Œä¸”æ²¡æœ‰è¿›ç¨‹åˆ›å»ºé”€æ¯ç­‰æ“ä½œï¼Œèµ„æºå ç”¨ç‡æ¯”è¾ƒä½ã€‚ä½†æ˜¯å®ƒä¸€å®šæ˜¯å¤„ç†IO bound taskæ‰ä¼šæœ‰è¿™ç§ä¼˜åŠ¿ã€‚</p><p>Gunicorn é‡‡ç”¨çš„æ˜¯æ± åŒ–å¤ç”¨çš„æŠ€å·§ï¼Œé€šè¿‡æœåŠ¡å¯åŠ¨æ—¶å€™ï¼Œæ ¹æ®ä½ çš„é…ç½®ä¿¡æ¯ï¼Œç”±masterè¿›ç¨‹æå‰åˆ›å»ºå¥½å¯¹åº”çš„workerè¿›ç¨‹ï¼Œç„¶ååç»­çš„è¯·æ±‚éƒ½ä¼šé€šè¿‡è½®æµå¤ç”¨è¢«è¿™äº›workerè¿›ç¨‹å¤„ç†ã€‚ä»å•ä¸ªsync workerè¿›ç¨‹çš„è§†è§’æ¥çœ‹ï¼Œåœ¨æŸä¸€ä¸ªæ—¶åˆ»ï¼Œå…¶åªèƒ½å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œå…¶å®ƒè¯·æ±‚è¦ä¹ˆè¢«å…¶å®ƒworkerå¤„ç†ä¸­ï¼Œè¦ä¹ˆåœ¨socketé˜Ÿåˆ—pendingä¸­ã€‚ä¸‹é¢æ˜¯ä¸€å¼ å…¶é€»è¾‘è§†å›¾ï¼š</p><p><img src="https://www.spirulasystems.com/wp-content/plugins/phastpress/phast.php?service=images&width=512&height=290&src=https%3A%2F%2Fwww.spirulasystems.com%2Fwp-content%2Fuploads%2F2015%2F01%2Fsync_worker_type1.png&cacheMarker=1557312233-22541&token=a271e359b84a7e6c" alt="sync worker"></p><p>æ€»ä½“ä¸Šï¼Œmasterè¿›ç¨‹è´Ÿè´£å¯åŠ¨workerè¿›ç¨‹å¹¶å¯¹å…¶ç®¡ç†ï¼ŒåŒ…æ‹¬åˆ›å»ºã€é”€æ¯ã€æ–°å¢ã€å‡å°‘ç­‰æ“ä½œã€‚workerè¿›ç¨‹è´Ÿè´£ç›‘å¬ç«¯å£å¤„ç†è¯·æ±‚ï¼Œå…¶åˆ›å»ºå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå®ä¾‹åŒ–é…ç½®å¥½çš„Python Web applicationï¼Œå°†æ¥å—çš„http è¯·æ±‚parseï¼Œç„¶åè°ƒç”¨web applicationå¤„ç†ï¼Œå¾—åˆ°è¿”å›ç»“æœåæ•´ç†æˆHttp Responseé€šè¿‡tcpè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://circus.readthedocs.org/en/0.5/_images/classical-stack.png" alt="master-worker">  </p><h4 id="source-code-analysis"><a href="#source-code-analysis" class="headerlink" title="source code analysis"></a>source code analysis</h4><p>The following code in Gunicorn show it show to start master and workers process. when you type following command in bash: <code>gunicorn -w 4 myapp:app</code>, gunicorn will enter <code>Arbiter.run</code> method, it first start the master by initialize <code>arbiter</code> class instance, like set pid and create socket. it then will create worker process with <code>Arbiter.spawn_worker</code> method, actually use os.fork to create or clone an child process. also in <code>Arbiter.manage_workers</code> you can see how master process manages worker process.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Arbiter</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Arbiter maintain the workers processes alive. It launches or</span></span><br><span class="line"><span class="string">    kills them if needed. It also manages application reloading</span></span><br><span class="line"><span class="string">    via SIGHUP/USR2.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"Main master loop."</span></span><br><span class="line">        self.start()</span><br><span class="line">        util._setproctitle(<span class="string">"master [%s]"</span> % self.proc_name)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.manage_workers()</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            self.log.info(<span class="string">"Unhandled exception in main loop"</span>,</span><br><span class="line">                          exc_info=<span class="literal">True</span>)</span><br><span class="line">            self.stop(<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">if</span> self.pidfile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                self.pidfile.unlink()</span><br><span class="line">            sys.exit(<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""\</span></span><br><span class="line"><span class="string">        Initialize the arbiter. Start listening and set pidfile if needed.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        self.init_signals()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.LISTENERS:</span><br><span class="line">            fds = <span class="literal">None</span></span><br><span class="line">            listen_fds = systemd.listen_fds()</span><br><span class="line">            <span class="keyword">if</span> listen_fds:</span><br><span class="line">                self.systemd = <span class="literal">True</span></span><br><span class="line">                fds = range(systemd.SD_LISTEN_FDS_START,</span><br><span class="line">                            systemd.SD_LISTEN_FDS_START + listen_fds)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> self.master_pid:</span><br><span class="line">                fds = []</span><br><span class="line">                <span class="keyword">for</span> fd <span class="keyword">in</span> os.environ.pop(<span class="string">'GUNICORN_FD'</span>).split(<span class="string">','</span>):</span><br><span class="line">                    fds.append(int(fd))</span><br><span class="line"></span><br><span class="line">            self.LISTENERS = sock.create_sockets(self.cfg, self.log, fds)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">manage_workers</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""\</span></span><br><span class="line"><span class="string">        Maintain the number of workers by spawning or killing</span></span><br><span class="line"><span class="string">        as required.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> len(self.WORKERS) &lt; self.num_workers:</span><br><span class="line">            self.spawn_workers()</span><br><span class="line"></span><br><span class="line">        workers = self.WORKERS.items()</span><br><span class="line">        workers = sorted(workers, key=<span class="keyword">lambda</span> w: w[<span class="number">1</span>].age)</span><br><span class="line">        <span class="keyword">while</span> len(workers) &gt; self.num_workers:</span><br><span class="line">            (pid, _) = workers.pop(<span class="number">0</span>)</span><br><span class="line">            self.kill_worker(pid, signal.SIGTERM)</span><br><span class="line"></span><br><span class="line">        active_worker_count = len(workers)</span><br><span class="line">        <span class="keyword">if</span> self._last_logged_active_worker_count != active_worker_count:</span><br><span class="line">            self._last_logged_active_worker_count = active_worker_count</span><br><span class="line">            self.log.debug(<span class="string">"&#123;0&#125; workers"</span>.format(active_worker_count),</span><br><span class="line">                           extra=&#123;<span class="string">"metric"</span>: <span class="string">"gunicorn.workers"</span>,</span><br><span class="line">                                  <span class="string">"value"</span>: active_worker_count,</span><br><span class="line">                                  <span class="string">"mtype"</span>: <span class="string">"gauge"</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spawn_worker</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.worker_age += <span class="number">1</span></span><br><span class="line">        worker = self.worker_class(self.worker_age, self.pid, self.LISTENERS,</span><br><span class="line">                                   self.app, self.timeout / <span class="number">2.0</span>,</span><br><span class="line">                                   self.cfg, self.log)</span><br><span class="line">        self.cfg.pre_fork(self, worker)</span><br><span class="line">        pid = os.fork()</span><br><span class="line">        <span class="keyword">if</span> pid != <span class="number">0</span>:</span><br><span class="line">            worker.pid = pid</span><br><span class="line">            self.WORKERS[pid] = worker</span><br><span class="line">            <span class="keyword">return</span> pid</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Do not inherit the temporary files of other workers</span></span><br><span class="line">        <span class="keyword">for</span> sibling <span class="keyword">in</span> self.WORKERS.values():</span><br><span class="line">            sibling.tmp.close()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Process Child</span></span><br><span class="line">        worker.pid = os.getpid()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            util._setproctitle(<span class="string">"worker [%s]"</span> % self.proc_name)</span><br><span class="line">            self.log.info(<span class="string">"Booting worker with pid: %s"</span>, worker.pid)</span><br><span class="line">            self.cfg.post_fork(self, worker)</span><br><span class="line">            worker.init_process()</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">except</span> SystemExit:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">except</span> AppImportError <span class="keyword">as</span> e:</span><br><span class="line">            self.log.debug(<span class="string">"Exception while loading the application"</span>,</span><br><span class="line">                           exc_info=<span class="literal">True</span>)</span><br><span class="line">            print(<span class="string">"%s"</span> % e, file=sys.stderr)</span><br><span class="line">            sys.stderr.flush()</span><br><span class="line">            sys.exit(self.APP_LOAD_ERROR)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            self.log.exception(<span class="string">"Exception in worker process"</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> worker.booted:</span><br><span class="line">                sys.exit(self.WORKER_BOOT_ERROR)</span><br><span class="line">            sys.exit(<span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self.log.info(<span class="string">"Worker exiting (pid: %s)"</span>, worker.pid)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                worker.tmp.close()</span><br><span class="line">                self.cfg.worker_exit(self, worker)</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                self.log.warning(<span class="string">"Exception during worker exit:\n%s"</span>,</span><br><span class="line">                                 traceback.format_exc())</span><br></pre></td></tr></table></figure><h3 id="Async-worker-type"><a href="#Async-worker-type" class="headerlink" title="Async worker type"></a>Async worker type</h3><p>Gunicornæ”¯æŒå¤šç§worker typeï¼Œä¾‹å¦‚Syncï¼ŒAsyncï¼ŒTonardoï¼ŒAsyncIOç±»å‹çš„workerã€‚Syncçš„workeræœ€ç®€å•ï¼Œåœ¨ä¸ŠèŠ‚å·²ç»é˜è¿°ã€‚  </p><p>Async workeræ˜¯é€šè¿‡Gevent or Eventletå®ç°ï¼ŒGevent &amp; Eventletéƒ½æ˜¯é€šè¿‡Greenletå®ç°ï¼Œ Greenletæ˜¯Pythonçš„ä¸€ä¸ªC extension moduleï¼Œå…¶æœ¬è´¨æ˜¯Cçš„co-routineã€‚æ€»ä½“ä¸Šæ¥è¯´Geventå°±æ˜¯é€šè¿‡co-rotine + äº‹ä»¶å¾ªç¯ï¼ˆlibevï¼‰å®ç°äº†å¼‚æ­¥æ¨¡å‹ã€‚å¦‚æœå¯¹è¿™é‡Œçš„å®ç°ç‰¹åˆ«æ„Ÿå…´è¶£ï¼Œæ¨èçœ‹David beezlyçš„<a href="https://www.youtube.com/watch?v=Z_OAlIhXziw" target="_blank" rel="noopener">curious course on corontines and concurrency</a> and Kavya Joshiçš„  <a href="https://www.youtube.com/watch?v=GunMToxbE0E" target="_blank" rel="noopener">a deep dive into how gevent works</a> </p><p>Asyncæ¨¡å¼ä¸‹Gunicornå¤„ç†è¯·æ±‚çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://www.spirulasystems.com/wp-content/plugins/phastpress/phast.php?service=images&width=275&height=300&src=https%3A%2F%2Fwww.spirulasystems.com%2Fwp-content%2Fuploads%2F2015%2F01%2Fsync_worker_type2-275x300.png&cacheMarker=1557312233-55428&token=c96103d27e004eef" alt="async worker"><br>ä¸€ä¸ªasync workerå¯ä»¥å¹¶å‘çš„å¤„ç†å¾ˆå¤šä¸ªè¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚å®é™…ä¸Šè¢«ä¸€ä¸ªcoroutineå¤„ç†ï¼Œå½“å…¶è¿›å…¥IOç­‰å¾…ï¼Œä¼šä¸»åŠ¨yieldå‡ºæ§åˆ¶æƒï¼Œè¿™æ ·ä¸‹ä¸€ä¸ªcoroutineå°±å¯ä»¥æ‰§è¡Œã€‚å½“IO readyï¼Œä¼šè§¦å‘äº‹ä»¶ï¼Œäº‹ä»¶å¾ªç¯ä¼šå°†å¯¹åº”çš„coroutineçš„ä»yeildå‡ºæ§åˆ¶æƒçš„åœ°æ–¹æ¢å¤æ‰§è¡Œã€‚  </p><p>Async workerçš„corotinesä¼šè¿è¡Œåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œé€šè¿‡æ¥å›åˆ‡æ¢å‡½æ•°æ¥å……åˆ†åˆ©ç”¨CPUï¼Œå‡å°‘IOç­‰å¾…æ—¶é—´ï¼Œå…¶åœ¨æŸä¸ªæ—¶åˆ»åªä¼šæœ‰ä¸€ä¸ªroutineåœ¨cpuä¸Šè¿è¡Œã€‚ç›¸æ¯”äºè¿›ç¨‹çº¿ç¨‹ï¼Œcoroutineæ›´åŠ è½»é‡ï¼Œå› ä¸ºå…¶æ“ä½œçš„ç»´åº¦æ˜¯å‡½æ•°è€Œä¸æ˜¯æ•´ä¸ªè¿›ç¨‹çº¿ç¨‹ã€‚</p><p>Gunicorn have an base worker type for every support worker, that is <code>base.Wrorker</code>, from the def of it, you can see child worker must implement <code>run init_process</code>.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># base.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, age, ppid, sockets, app, timeout, cfg, log)</span>:</span></span><br><span class="line">        <span class="string">""" called in pre-fork """</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">notify</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">""" inform master process that this worker is alive """</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""\</span></span><br><span class="line"><span class="string">        This is the mainloop of a worker process. You should override</span></span><br><span class="line"><span class="string">        this method in a subclass to provide the intended behaviour</span></span><br><span class="line"><span class="string">        for your particular evil schemes.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_process</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""\</span></span><br><span class="line"><span class="string">        If you override this method in a subclass, the last statement</span></span><br><span class="line"><span class="string">        in the function should be to call this method with</span></span><br><span class="line"><span class="string">        super().init_process() so that the ``run()`` loop is initiated.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        ...</span><br><span class="line">        self.wait_fds = self.sockets + [self.PIPE[<span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line">        self.log.close_on_exec()</span><br><span class="line"></span><br><span class="line">        self.init_signals()</span><br><span class="line"></span><br><span class="line">        self.load_wsgi()</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment"># Enter main run loop</span></span><br><span class="line">        self.booted = <span class="literal">True</span></span><br><span class="line">        self.run()</span><br></pre></td></tr></table></figure><p>but for async worker, it will have second parent base type which is <code>base_async.AsyncWorker</code>, which is inherit from <code>base.Worker</code>.<br>it maily defs how to process or handle the request. also Gunicorn have the corresponding SyncWorker defined in <code>sync.py</code>.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># base_async.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncWorker</span><span class="params">(base.Worker)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self, listener, client, addr)</span>:</span></span><br><span class="line">        req = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            parser = http.RequestParser(self.cfg, client)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                listener_name = listener.getsockname()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> self.cfg.keepalive:</span><br><span class="line">                    req = next(parser)</span><br><span class="line">                    self.handle_request(listener_name, req, client, addr)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_request</span><span class="params">(self, listener_name, req, sock, addr)</span>:</span></span><br><span class="line">        request_start = datetime.now()</span><br><span class="line">        environ = &#123;&#125;</span><br><span class="line">        resp = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.cfg.pre_request(self, req)</span><br><span class="line">            resp, environ = wsgi.create(req, sock, addr,</span><br><span class="line">                                        listener_name, self.cfg)</span><br><span class="line">            environ[<span class="string">"wsgi.multithread"</span>] = <span class="literal">True</span></span><br><span class="line">            ...</span><br></pre></td></tr></table></figure><p>Gevent worker implementation is defined in <code>ggevent.py</code>, which will implement following methods: <code>run</code>, <code>init_process</code>, <code>notify</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ggevent.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GeventWorker</span><span class="params">(AsyncWorker)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">notify</span><span class="params">(self)</span>:</span></span><br><span class="line">        super().notify()</span><br><span class="line">        <span class="keyword">if</span> self.ppid != os.getppid():</span><br><span class="line">            self.log.info(<span class="string">"Parent changed, shutting down: %s"</span>, self)</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_process</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.patch()</span><br><span class="line">        hub.reinit()</span><br><span class="line">        super().init_process()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        servers = []</span><br><span class="line">        ssl_args = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.cfg.is_ssl:</span><br><span class="line">            ssl_args = dict(server_side=<span class="literal">True</span>, **self.cfg.ssl_options)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> self.sockets:</span><br><span class="line">            s.setblocking(<span class="number">1</span>)</span><br><span class="line">            pool = Pool(self.worker_connections)</span><br><span class="line">            <span class="keyword">if</span> self.server_class <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                environ = base_environ(self.cfg)</span><br><span class="line">                environ.update(&#123;</span><br><span class="line">                    <span class="string">"wsgi.multithread"</span>: <span class="literal">True</span>,</span><br><span class="line">                    <span class="string">"SERVER_SOFTWARE"</span>: VERSION,</span><br><span class="line">                &#125;)</span><br><span class="line">                server = self.server_class(</span><br><span class="line">                    s, application=self.wsgi, spawn=pool, log=self.log,</span><br><span class="line">                    handler_class=self.wsgi_handler, environ=environ,</span><br><span class="line">                    **ssl_args)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                hfun = partial(self.handle, s)</span><br><span class="line">                server = StreamServer(s, handle=hfun, spawn=pool, **ssl_args)</span><br><span class="line">                <span class="keyword">if</span> self.cfg.workers &gt; <span class="number">1</span>:</span><br><span class="line">                    server.max_accept = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            server.start()</span><br><span class="line">            servers.append(server)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> self.alive:</span><br><span class="line">            self.notify()</span><br><span class="line">            gevent.sleep(<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Stop accepting requests</span></span><br><span class="line">            <span class="keyword">for</span> server <span class="keyword">in</span> servers:</span><br><span class="line">                <span class="keyword">if</span> hasattr(server, <span class="string">'close'</span>):  <span class="comment"># gevent 1.0</span></span><br><span class="line">                    server.close()</span><br><span class="line">                <span class="keyword">if</span> hasattr(server, <span class="string">'kill'</span>):  <span class="comment"># gevent &lt; 1.0</span></span><br><span class="line">                    server.kill()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Handle current requests until graceful_timeout</span></span><br><span class="line">            ts = time.time()</span><br><span class="line">            <span class="keyword">while</span> time.time() - ts &lt;= self.cfg.graceful_timeout:</span><br><span class="line">                accepting = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> server <span class="keyword">in</span> servers:</span><br><span class="line">                    <span class="keyword">if</span> server.pool.free_count() != server.pool.size:</span><br><span class="line">                        accepting += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># if no server is accepting a connection, we can exit</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> accepting:</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">                self.notify()</span><br><span class="line">                gevent.sleep(<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Force kill all active the handlers</span></span><br><span class="line">            self.log.warning(<span class="string">"Worker graceful timeout (pid:%s)"</span> % self.pid)</span><br><span class="line">            <span class="keyword">for</span> server <span class="keyword">in</span> servers:</span><br><span class="line">                server.stop(timeout=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬çš„web applicationè¦query dbï¼Œä»ç¬¬ä¸‰æ–¹apiæ‹‰å–æ•°æ®ç­‰ï¼Œæ‰€ä»¥å¾ˆå¤§æ¦‚ç‡ä¸Šè¿™æ˜¯ä¸€ä¸ªIO boundçš„taskï¼Œè¿™å°±æ¯”è¾ƒé€‚åˆç”¨Gunicornçš„Async workerï¼ˆgeventï¼‰æ¥å¤„ç†ã€‚å¦‚æœä½ çš„æœåŠ¡æ˜¯ä¸€ä¸ªCPU boundçš„taskï¼Œé‚£ä¹ˆç”¨Gunicornçš„Sync taskå°±ä¼šè¾¾åˆ°å¾ˆå¥½çš„æ€§èƒ½ã€‚</p><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://www.youtube.com/watch?v=GunMToxbE0E" target="_blank" rel="noopener">A deep dive into how gevent works</a><br><a href="https://www.spirulasystems.com/blog/2015/01/20/gunicorn-worker-types/" target="_blank" rel="noopener">Gunicorn worker types</a><br><a href="https://words.volant.is/articles/understanding-gunicorns-async-worker-concurrency-model/" target="_blank" rel="noopener">Understand Gunicornâ€™s async worker models</a><br><a href="https://github.com/benoitc/gunicorn" target="_blank" rel="noopener">benoitc/gunicorn</a><br><a href="https://docs.gunicorn.org/en/stable/design.html" target="_blank" rel="noopener">Gunicorn Design</a><br><a href="https://www.youtube.com/watch?v=Z_OAlIhXziw" target="_blank" rel="noopener">Curious course on corontines and concurrency</a>  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Gunicorn æ˜¯ä¸€ä¸ªPython Web Serverå®ç°ï¼Œå…¼å®¹WSGIåè®®ã€‚å…¶è¿ç§»è‡ªRubyä¸–ç•Œçš„Unicornã€‚åœ¨æˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæœ‰å¤§é‡ä½¿ç”¨Gunicornä½œä¸ºWeb æœåŠ¡å™¨ï¼Œæ‰€ä»¥æœ¬æ–‡åˆ†æGunicornçš„ç›¸å…³å‡ ä¸ªé—®é¢˜ï¼š Server modelï¼ŒAsync worker.&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
      <category term="Web Server" scheme="http://yoursite.com/tags/Web-Server/"/>
    
      <category term="Gunicorn" scheme="http://yoursite.com/tags/Gunicorn/"/>
    
  </entry>
  
  <entry>
    <title>Let&#39;s build a WSGI server</title>
    <link href="http://yoursite.com/2020/03/22/Let-s-build-a-WSGI-server/"/>
    <id>http://yoursite.com/2020/03/22/Let-s-build-a-WSGI-server/</id>
    <published>2020-03-22T11:58:34.000Z</published>
    <updated>2020-09-23T17:55:12.026Z</updated>
    
    <content type="html"><![CDATA[<p>Letâ€™s build a wsgi server ground up with sockets, multi-processing or Select/Poll/Epoll. to achive this, you need familiar with Pythonâ€™s socket programming, Pythonâ€™s cucurreny model, Linux Non-blocking I/O.</p><a id="more"></a><p>WSGI(web server gateway interface) is a protocol in Python web programming, it defines how web application and web server communicate. with this protocol, you can chose various combinations about web servers and web frameworks which are wsgi-compatiable. for example, you can use Gunicorn + Django, or even Bjoern + Flask etcâ€¦</p><h3 id="Whatâ€™s-WSGI-Server"><a href="#Whatâ€™s-WSGI-Server" class="headerlink" title="Whatâ€™s WSGI Server"></a>Whatâ€™s WSGI Server</h3><p>WSGI server is the server side wsgi protocol implementation. which is responsible accepting connections and invoke web application to process the result though wsgi protocol, and finally return the result back to clients. with wsgi server concentrate on accepting connections, wsgi framework(application) can focus on your bussiness logic.   </p><p>To summarize, as an wsgi server, it must contains following info:</p><ul><li><p>compose <code>env</code> variables which will be used in web framework</p>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">environ[<span class="string">'wsgi.input'</span>]        = sys.stdin</span><br><span class="line">environ[<span class="string">'wsgi.errors'</span>]       = sys.stderr</span><br><span class="line">environ[<span class="string">'wsgi.version'</span>]      = (<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">environ[<span class="string">'wsgi.multithread'</span>]  = <span class="literal">False</span></span><br><span class="line">environ[<span class="string">'wsgi.multiprocess'</span>] = <span class="literal">True</span></span><br><span class="line">environ[<span class="string">'wsgi.run_once'</span>]     = <span class="literal">True</span></span><br><span class="line">environ[<span class="string">'wsgi.url_schema'</span>]   = <span class="string">'http'</span></span><br><span class="line">environ[<span class="string">'REQUEST_METHOD'</span>]    = <span class="string">'GET'</span></span><br><span class="line">environ[<span class="string">'PATH_INFO'</span>]         = <span class="string">'/hello'</span></span><br><span class="line">environ[<span class="string">'SERVER_NAME'</span>]       = <span class="string">'localhost'</span></span><br><span class="line">environ[<span class="string">'SERVER_PORT'</span>]       = <span class="number">8888</span></span><br></pre></td></tr></table></figure></li><li><p>start_response callable which will be called in web framework</p>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_response</span><span class="params">(status, response_header, exec_info=None)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    status is the http status code, response_header is the header web framework wants to added</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></li></ul><p>for more detail, please reference: <a href="https://www.python.org/dev/peps/pep-0333/#implementation-application-notes" target="_blank" rel="noopener">PEP 333: Python web server gateway interfaces v1.0</a></p><h3 id="Simple-TCP-echo-server"><a href="#Simple-TCP-echo-server" class="headerlink" title="Simple TCP echo server"></a>Simple TCP echo server</h3><p>As classic socket programming said, a socket server needs to bind/listen/accept/recv/send/close, a socket client needs to connect/send/recv/close. here is a simple example:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleTcpServer</span><span class="params">(object)</span>:</span></span><br><span class="line">    address_family = socket.AF_INET</span><br><span class="line">    socket_type = socket.SOCK_STREAM</span><br><span class="line">    request_queue_size = <span class="number">1024</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init</span><span class="params">(self, server_address)</span>:</span></span><br><span class="line">        <span class="comment"># Create a listening socket</span></span><br><span class="line">        self.listen_socket = listen_socket = socket.socket(</span><br><span class="line">            self.address_family,</span><br><span class="line">            self.socket_type</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># Allow to reuse the same address</span></span><br><span class="line">        listen_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># Bind</span></span><br><span class="line">        listen_socket.bind(server_address)</span><br><span class="line">        <span class="comment"># Activate</span></span><br><span class="line">        listen_socket.listen(self.request_queue_size)</span><br><span class="line">        <span class="comment"># Get server host name and port</span></span><br><span class="line">        host, port = self.listen_socket.getsockname()[:<span class="number">2</span>]</span><br><span class="line">        self.server_name = socket.getfqdn(host)</span><br><span class="line">        self.server_port = port</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">server_forever</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            self.client_connection, client_address = self.listen_socket.accept()</span><br><span class="line">            self.handle_one_request()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_one_request</span><span class="params">(self)</span>:</span></span><br><span class="line">        request_data = self.client_connection.recv(<span class="number">1024</span>)</span><br><span class="line">        self.client_connection.sendall(request_data)</span><br><span class="line">        self.client_connection.close()</span><br></pre></td></tr></table></figure><h3 id="A-simple-wsgi-server"><a href="#A-simple-wsgi-server" class="headerlink" title="A simple wsgi server"></a>A simple wsgi server</h3><p>The simple wsgi server will listen on port, waitting for incoming connection to accept, for each connection, wsgi server will invoke web framework process(which is the main entrance implemented in web framework) the request and wait until web framework finish processing it and return the result to client. here is a simple example:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WSGIServer</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    address_family = socket.AF_INET</span><br><span class="line">    socket_type = socket.SOCK_STREAM</span><br><span class="line">    request_queue_size = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, server_address)</span>:</span></span><br><span class="line">        <span class="comment"># Create a listening socket</span></span><br><span class="line">        self.listen_socket = listen_socket = socket.socket(</span><br><span class="line">            self.address_family,</span><br><span class="line">            self.socket_type</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># Allow to reuse the same address</span></span><br><span class="line">        listen_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># Bind</span></span><br><span class="line">        listen_socket.bind(server_address)</span><br><span class="line">        <span class="comment"># Activate</span></span><br><span class="line">        listen_socket.listen(self.request_queue_size)</span><br><span class="line">        <span class="comment"># Get server host name and port</span></span><br><span class="line">        host, port = self.listen_socket.getsockname()[:<span class="number">2</span>]</span><br><span class="line">        self.server_name = socket.getfqdn(host)</span><br><span class="line">        self.server_port = port</span><br><span class="line">        <span class="comment"># Return headers set by Web framework/Web application</span></span><br><span class="line">        self.headers_set = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_app</span><span class="params">(self, application)</span>:</span></span><br><span class="line">        self.application = application</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">serve_forever</span><span class="params">(self)</span>:</span></span><br><span class="line">        listen_socket = self.listen_socket</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># New client connection</span></span><br><span class="line">            self.client_connection, client_address = listen_socket.accept()</span><br><span class="line">            <span class="comment"># Handle one request and close the client connection. Then</span></span><br><span class="line">            <span class="comment"># loop over to wait for another client connection</span></span><br><span class="line">            self.handle_one_request()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_one_request</span><span class="params">(self)</span>:</span></span><br><span class="line">        request_data = self.client_connection.recv(<span class="number">1024</span>)</span><br><span class="line">        self.request_data = request_data = request_data.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="comment"># Print formatted request data a la 'curl -v'</span></span><br><span class="line">        print(<span class="string">''</span>.join(</span><br><span class="line">            <span class="string">f'&lt; <span class="subst">&#123;line&#125;</span>\n'</span> <span class="keyword">for</span> line <span class="keyword">in</span> request_data.splitlines()</span><br><span class="line">        ))</span><br><span class="line"></span><br><span class="line">        self.parse_request(request_data)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Construct environment dictionary using request data</span></span><br><span class="line">        env = self.get_environ()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># It's time to call our application callable and get</span></span><br><span class="line">        <span class="comment"># back a result that will become HTTP response body</span></span><br><span class="line">        result = self.application(env, self.start_response)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Construct a response and send it back to the client</span></span><br><span class="line">        self.finish_response(result)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_request</span><span class="params">(self, text)</span>:</span></span><br><span class="line">        request_line = text.splitlines()[<span class="number">0</span>]</span><br><span class="line">        request_line = request_line.rstrip(<span class="string">'\r\n'</span>)</span><br><span class="line">        <span class="comment"># Break down the request line into components</span></span><br><span class="line">        (self.request_method,  <span class="comment"># GET</span></span><br><span class="line">         self.path,            <span class="comment"># /hello</span></span><br><span class="line">         self.request_version  <span class="comment"># HTTP/1.1</span></span><br><span class="line">         ) = request_line.split()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_environ</span><span class="params">(self)</span>:</span></span><br><span class="line">        env = &#123;&#125;</span><br><span class="line">        <span class="comment"># The following code snippet does not follow PEP8 conventions</span></span><br><span class="line">        <span class="comment"># but it's formatted the way it is for demonstration purposes</span></span><br><span class="line">        <span class="comment"># to emphasize the required variables and their values</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># Required WSGI variables</span></span><br><span class="line">        env[<span class="string">'wsgi.version'</span>]      = (<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">        env[<span class="string">'wsgi.url_scheme'</span>]   = <span class="string">'http'</span></span><br><span class="line">        env[<span class="string">'wsgi.input'</span>]        = io.StringIO(self.request_data)</span><br><span class="line">        env[<span class="string">'wsgi.errors'</span>]       = sys.stderr</span><br><span class="line">        env[<span class="string">'wsgi.multithread'</span>]  = <span class="literal">False</span></span><br><span class="line">        env[<span class="string">'wsgi.multiprocess'</span>] = <span class="literal">False</span></span><br><span class="line">        env[<span class="string">'wsgi.run_once'</span>]     = <span class="literal">False</span></span><br><span class="line">        <span class="comment"># Required CGI variables</span></span><br><span class="line">        env[<span class="string">'REQUEST_METHOD'</span>]    = self.request_method    <span class="comment"># GET</span></span><br><span class="line">        env[<span class="string">'PATH_INFO'</span>]         = self.path              <span class="comment"># /hello</span></span><br><span class="line">        env[<span class="string">'SERVER_NAME'</span>]       = self.server_name       <span class="comment"># localhost</span></span><br><span class="line">        env[<span class="string">'SERVER_PORT'</span>]       = str(self.server_port)  <span class="comment"># 8888</span></span><br><span class="line">        <span class="keyword">return</span> env</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_response</span><span class="params">(self, status, response_headers, exc_info=None)</span>:</span></span><br><span class="line">        <span class="comment"># Add necessary server headers</span></span><br><span class="line">        server_headers = [</span><br><span class="line">            (<span class="string">'Date'</span>, <span class="string">'Mon, 15 Jul 2019 5:54:48 GMT'</span>),</span><br><span class="line">            (<span class="string">'Server'</span>, <span class="string">'WSGIServer 0.2'</span>),</span><br><span class="line">        ]</span><br><span class="line">        self.headers_set = [status, response_headers + server_headers]</span><br><span class="line">        <span class="comment"># To adhere to WSGI specification the start_response must return</span></span><br><span class="line">        <span class="comment"># a 'write' callable. We simplicity's sake we'll ignore that detail</span></span><br><span class="line">        <span class="comment"># for now.</span></span><br><span class="line">        <span class="comment"># return self.finish_response</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">finish_response</span><span class="params">(self, result)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            status, response_headers = self.headers_set</span><br><span class="line">            response = <span class="string">f'HTTP/1.1 <span class="subst">&#123;status&#125;</span>\r\n'</span></span><br><span class="line">            <span class="keyword">for</span> header <span class="keyword">in</span> response_headers:</span><br><span class="line">                response += <span class="string">'&#123;0&#125;: &#123;1&#125;\r\n'</span>.format(*header)</span><br><span class="line">            response += <span class="string">'\r\n'</span></span><br><span class="line">            <span class="keyword">for</span> data <span class="keyword">in</span> result:</span><br><span class="line">                response += data.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">            <span class="comment"># Print formatted response data a la 'curl -v'</span></span><br><span class="line">            print(<span class="string">''</span>.join(</span><br><span class="line">                <span class="string">f'&gt; <span class="subst">&#123;line&#125;</span>\n'</span> <span class="keyword">for</span> line <span class="keyword">in</span> response.splitlines()</span><br><span class="line">            ))</span><br><span class="line">            response_bytes = response.encode()</span><br><span class="line">            self.client_connection.sendall(response_bytes)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self.client_connection.close()</span><br></pre></td></tr></table></figure><h3 id="Concurrent-with-multi-processing"><a href="#Concurrent-with-multi-processing" class="headerlink" title="Concurrent with multi-processing"></a>Concurrent with multi-processing</h3><p>The upper wsgi server can process a request at a time, cuz it is a single process and will block in while loop, as following code shows:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serve_forever</span><span class="params">(self)</span>:</span></span><br><span class="line">    listen_socket = self.listen_socket</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># New client connection</span></span><br><span class="line">        self.client_connection, client_address = listen_socket.accept()</span><br><span class="line">        <span class="comment"># Handle one request and close the client connection. Then</span></span><br><span class="line">        <span class="comment"># loop over to wait for another client connection</span></span><br><span class="line">        self.handle_one_request()</span><br></pre></td></tr></table></figure><p><code>handle_one_request</code> will block the while loop while processing the current connection. the time spend on blocking depends on your web applicationâ€™s corresonding methodâ€™s processing speed.  </p><p>if the first connection didnâ€™t finished, the second connection will be blocked by the first one. how can we let the wsgi server handle multiple connections at the same time? the answer is multi-processing.  </p><p>here is an example of multi-processing version, which will fork an new python process for each incoming connections.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WSGIServer</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    address_family = socket.AF_INET</span><br><span class="line">    socket_type = socket.SOCK_STREAM</span><br><span class="line">    request_queue_size = <span class="number">1024</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, server_address)</span>:</span></span><br><span class="line">        <span class="comment"># Create a listening socket</span></span><br><span class="line">        self.listen_socket = listen_socket = socket.socket(</span><br><span class="line">            self.address_family,</span><br><span class="line">            self.socket_type</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># Allow to reuse the same address</span></span><br><span class="line">        listen_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># Bind</span></span><br><span class="line">        listen_socket.bind(server_address)</span><br><span class="line">        <span class="comment"># Activate</span></span><br><span class="line">        listen_socket.listen(self.request_queue_size)</span><br><span class="line">        <span class="comment"># Get server host name and port</span></span><br><span class="line">        host, port = self.listen_socket.getsockname()[:<span class="number">2</span>]</span><br><span class="line">        self.server_name = socket.getfqdn(host)</span><br><span class="line">        self.server_port = port</span><br><span class="line">        <span class="comment"># Return headers set by Web framework/Web application</span></span><br><span class="line">        self.headers_set = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reap_children</span><span class="params">(selflili, signum, frame)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        collect zombie children</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># wait for all children, do not block</span></span><br><span class="line">                pid, status = os.waitpid(<span class="number">-1</span>, os.WNOHANG)</span><br><span class="line">                <span class="keyword">if</span> pid == <span class="number">0</span>:  <span class="comment"># no more zombies</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="comment"># usally this would be OSError exception</span></span><br><span class="line">                <span class="comment"># with errno attribute set to errno.ECHILD</span></span><br><span class="line">                <span class="comment"># which means there are no more children</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_app</span><span class="params">(self, application)</span>:</span></span><br><span class="line">        self.application = application</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">serve_forever</span><span class="params">(self)</span>:</span></span><br><span class="line">        signal.signal(signal.SIGCHLD, self.__reap_children)</span><br><span class="line">        listen_socket = self.listen_socket</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># New client connection</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.client_connection, client_address = listen_socket.accept()</span><br><span class="line">            <span class="keyword">except</span> IOError <span class="keyword">as</span> e:</span><br><span class="line">                code, msg = e.args</span><br><span class="line">                <span class="keyword">if</span> code == errno.EINR:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">raise</span></span><br><span class="line">            pid = os.fork()</span><br><span class="line">            <span class="keyword">if</span> pid == <span class="number">0</span>:  <span class="comment"># child</span></span><br><span class="line">                self.listen_socket.close()</span><br><span class="line">                self.handle_one_request()</span><br><span class="line">                os._exit(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">else</span>:  <span class="comment"># parent</span></span><br><span class="line">                self.client_connection.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_one_request</span><span class="params">(self)</span>:</span></span><br><span class="line">        request_data = self.client_connection.recv(<span class="number">1024</span>)</span><br><span class="line">        self.request_data = request_data = request_data.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="comment"># Print formatted request data a la 'curl -v'</span></span><br><span class="line">        print(<span class="string">''</span>.join(</span><br><span class="line">            <span class="string">f'&lt; <span class="subst">&#123;line&#125;</span>\n'</span> <span class="keyword">for</span> line <span class="keyword">in</span> request_data.splitlines()</span><br><span class="line">        ))</span><br><span class="line"></span><br><span class="line">        self.parse_request(request_data)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Construct environment dictionary using request data</span></span><br><span class="line">        env = self.get_environ()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># It's time to call our application callable and get</span></span><br><span class="line">        <span class="comment"># back a result that will become HTTP response body</span></span><br><span class="line">        result = self.application(env, self.start_response)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Construct a response and send it back to the client</span></span><br><span class="line">        self.finish_response(result)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_request</span><span class="params">(self, text)</span>:</span></span><br><span class="line">        request_line = text.splitlines()[<span class="number">0</span>]</span><br><span class="line">        request_line = request_line.rstrip(<span class="string">'\r\n'</span>)</span><br><span class="line">        <span class="comment"># Break down the request line into components</span></span><br><span class="line">        (self.request_method,  <span class="comment"># GET</span></span><br><span class="line">         self.path,            <span class="comment"># /hello</span></span><br><span class="line">         self.request_version  <span class="comment"># HTTP/1.1</span></span><br><span class="line">         ) = request_line.split()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_environ</span><span class="params">(self)</span>:</span></span><br><span class="line">        env = &#123;&#125;</span><br><span class="line">        <span class="comment"># The following code snippet does not follow PEP8 conventions</span></span><br><span class="line">        <span class="comment"># but it's formatted the way it is for demonstration purposes</span></span><br><span class="line">        <span class="comment"># to emphasize the required variables and their values</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># Required WSGI variables</span></span><br><span class="line">        env[<span class="string">'wsgi.version'</span>]      = (<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">        env[<span class="string">'wsgi.url_scheme'</span>]   = <span class="string">'http'</span></span><br><span class="line">        env[<span class="string">'wsgi.input'</span>]        = io.StringIO(self.request_data)</span><br><span class="line">        env[<span class="string">'wsgi.errors'</span>]       = sys.stderr</span><br><span class="line">        env[<span class="string">'wsgi.multithread'</span>]  = <span class="literal">False</span></span><br><span class="line">        env[<span class="string">'wsgi.multiprocess'</span>] = <span class="literal">False</span></span><br><span class="line">        env[<span class="string">'wsgi.run_once'</span>]     = <span class="literal">False</span></span><br><span class="line">        <span class="comment"># Required CGI variables</span></span><br><span class="line">        env[<span class="string">'REQUEST_METHOD'</span>]    = self.request_method    <span class="comment"># GET</span></span><br><span class="line">        env[<span class="string">'PATH_INFO'</span>]         = self.path              <span class="comment"># /hello</span></span><br><span class="line">        env[<span class="string">'SERVER_NAME'</span>]       = self.server_name       <span class="comment"># localhost</span></span><br><span class="line">        env[<span class="string">'SERVER_PORT'</span>]       = str(self.server_port)  <span class="comment"># 8888</span></span><br><span class="line">        <span class="keyword">return</span> env</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_response</span><span class="params">(self, status, response_headers, exc_info=None)</span>:</span></span><br><span class="line">        <span class="comment"># Add necessary server headers</span></span><br><span class="line">        server_headers = [</span><br><span class="line">            (<span class="string">'Date'</span>, <span class="string">'Mon, 15 Jul 2019 5:54:48 GMT'</span>),</span><br><span class="line">            (<span class="string">'Server'</span>, <span class="string">'WSGIServer 0.2'</span>),</span><br><span class="line">        ]</span><br><span class="line">        self.headers_set = [status, response_headers + server_headers]</span><br><span class="line">        <span class="comment"># To adhere to WSGI specification the start_response must return</span></span><br><span class="line">        <span class="comment"># a 'write' callable. We simplicity's sake we'll ignore that detail</span></span><br><span class="line">        <span class="comment"># for now.</span></span><br><span class="line">        <span class="comment"># return self.finish_response</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">finish_response</span><span class="params">(self, result)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            status, response_headers = self.headers_set</span><br><span class="line">            response = <span class="string">f'HTTP/1.1 <span class="subst">&#123;status&#125;</span>\r\n'</span></span><br><span class="line">            <span class="keyword">for</span> header <span class="keyword">in</span> response_headers:</span><br><span class="line">                response += <span class="string">'&#123;0&#125;: &#123;1&#125;\r\n'</span>.format(*header)</span><br><span class="line">            response += <span class="string">'\r\n'</span></span><br><span class="line">            <span class="keyword">for</span> data <span class="keyword">in</span> result:</span><br><span class="line">                response += data.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">            <span class="comment"># Print formatted response data a la 'curl -v'</span></span><br><span class="line">            print(<span class="string">''</span>.join(</span><br><span class="line">                <span class="string">f'&gt; <span class="subst">&#123;line&#125;</span>\n'</span> <span class="keyword">for</span> line <span class="keyword">in</span> response.splitlines()</span><br><span class="line">            ))</span><br><span class="line">            response_bytes = response.encode()</span><br><span class="line">            self.client_connection.sendall(response_bytes)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self.client_connection.close()</span><br></pre></td></tr></table></figure><h3 id="Concurrent-with-Linuxâ€™s-Non-blocking-I-O"><a href="#Concurrent-with-Linuxâ€™s-Non-blocking-I-O" class="headerlink" title="Concurrent with Linuxâ€™s Non-blocking I/O"></a>Concurrent with Linuxâ€™s Non-blocking I/O</h3><p>The multi-processing version still have problems, like when there are massive connections, the server will create massive processes for each connection. this will exaust the server resources, and also process-switching is expensive. to achive that, you will think using process pool.  </p><p>But letâ€™s think from another side, the server maily handles I/O tasks, i.e waitting socket to be readable, read the data and process it, and write to socket. for this kind of task, we use Non-Blocking I/O.</p><p>Suppose youâ€™re a webserver. Every time you accept a connection with the accept system call (hereâ€™s the man page), you get a new file descriptor representing that connection.</p><p>If youâ€™re a web server, you might have thousands of connections open at the same time. You need to know when people send you new data on those connections, so you can process and respond to them.</p><p>You could have a loop that basically does:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> open_connections:</span><br><span class="line">    <span class="keyword">if</span> has_new_input(x):</span><br><span class="line">        process_input(x)</span><br></pre></td></tr></table></figure><p>The problem with this is that it can waste a lot of CPU time. Instead of spending all CPU time to ask â€œare there updates now? how about now? how about now? how about now?â€œ, instead weâ€™d rather just ask the Linux kernel â€œhey, here are 100 file descriptors. Tell me when one of them is updated!â€œ.</p><p>The 3 system calls that let you ask Linux to monitor lots of file descriptors are poll, epoll and select. Letâ€™s start with poll and select because thatâ€™s where the chapter started.</p><p>I am not gonna talk the details between <code>select/poll/epoll</code>, you can read this post for more: <a href="https://jvns.ca/blog/2017/06/03/async-io-on-linux--select--poll--and-epoll/" target="_blank" rel="noopener">async io on linux select/poll/epoll</a>.</p><p>Pythonâ€™s select module have support for Linuxâ€™s <code>select/poll/epoll</code>, letâ€™s use select rewrite our wsgi server:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WSGIServer</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    address_family = socket.AF_INET</span><br><span class="line">    socket_type = socket.SOCK_STREAM</span><br><span class="line">    request_queue_size = <span class="number">1024</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, server_address)</span>:</span></span><br><span class="line">        <span class="comment"># Create a listening socket</span></span><br><span class="line">        self.listen_socket = listen_socket = socket.socket(</span><br><span class="line">            self.address_family,</span><br><span class="line">            self.socket_type</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># Allow to reuse the same address</span></span><br><span class="line">        listen_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        listen_socket.setblocking(<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># Bind</span></span><br><span class="line">        listen_socket.bind(server_address)</span><br><span class="line">        <span class="comment"># Activate</span></span><br><span class="line">        listen_socket.listen(self.request_queue_size)</span><br><span class="line">        <span class="comment"># Get server host name and port</span></span><br><span class="line">        host, port = self.listen_socket.getsockname()[:<span class="number">2</span>]</span><br><span class="line">        self.server_name = socket.getfqdn(host)</span><br><span class="line">        self.server_port = port</span><br><span class="line">        <span class="comment"># Return headers set by Web framework/Web application</span></span><br><span class="line">        self.headers_set = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_app</span><span class="params">(self, application)</span>:</span></span><br><span class="line">        self.application = application</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">serve_forever</span><span class="params">(self)</span>:</span></span><br><span class="line">        rlist, wlist, elist = [self.listen_socket], [], []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># listen_socket = self.listen_socket</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            readables, writables, exceptions = select.select(rlist, wlist, elist)</span><br><span class="line">            <span class="keyword">for</span> sock <span class="keyword">in</span> readables:</span><br><span class="line">                <span class="keyword">if</span> sock <span class="keyword">is</span> self.listen_socket:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        conn, client_address = self.listen_socket.accept()</span><br><span class="line">                    <span class="keyword">except</span> IOError <span class="keyword">as</span> e:</span><br><span class="line">                        code, msg = e.args</span><br><span class="line">                        <span class="keyword">if</span> code == errno.EINTR:</span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            <span class="keyword">raise</span></span><br><span class="line">                    rlist.append(conn)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        request_data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">                    <span class="keyword">except</span> ConnectionResetError <span class="keyword">as</span> e:</span><br><span class="line">                        request_data = <span class="literal">None</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> request_data:</span><br><span class="line">                        sock.close()</span><br><span class="line">                        rlist.remove(sock)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        request_data = request_data.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">                        print(<span class="string">''</span>.join(</span><br><span class="line">                            <span class="string">f'&lt; <span class="subst">&#123;line&#125;</span>\n'</span> <span class="keyword">for</span> line <span class="keyword">in</span> request_data.splitlines()</span><br><span class="line">                        ))</span><br><span class="line">                        <span class="comment"># parse request</span></span><br><span class="line">                        (request_method, path, request_version) = self.parse_request(request_data)</span><br><span class="line">                        env = self.get_environ(</span><br><span class="line">                            request_data, request_method, path,</span><br><span class="line">                            self.server_name, self.server_port</span><br><span class="line">                        )</span><br><span class="line">                        result = self.application(env, self.start_response)</span><br><span class="line">                        self.finish_response(result, sock)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_request</span><span class="params">(cls, text)</span>:</span></span><br><span class="line">        request_line = text.splitlines()[<span class="number">0</span>]</span><br><span class="line">        request_line = request_line.rstrip(<span class="string">'\r\n'</span>)</span><br><span class="line">        <span class="keyword">return</span> request_line.split()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_environ</span><span class="params">(self, request_data, request_method, path, server_name, server_port)</span>:</span></span><br><span class="line">        env = &#123;&#125;</span><br><span class="line">        <span class="comment"># The following code snippet does not follow PEP8 conventions</span></span><br><span class="line">        <span class="comment"># but it's formatted the way it is for demonstration purposes</span></span><br><span class="line">        <span class="comment"># to emphasize the required variables and their values</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># Required WSGI variables</span></span><br><span class="line">        env[<span class="string">'wsgi.version'</span>]      = (<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">        env[<span class="string">'wsgi.url_scheme'</span>]   = <span class="string">'http'</span></span><br><span class="line">        env[<span class="string">'wsgi.input'</span>]        = io.StringIO(request_data)</span><br><span class="line">        env[<span class="string">'wsgi.errors'</span>]       = sys.stderr</span><br><span class="line">        env[<span class="string">'wsgi.multithread'</span>]  = <span class="literal">False</span></span><br><span class="line">        env[<span class="string">'wsgi.multiprocess'</span>] = <span class="literal">False</span></span><br><span class="line">        env[<span class="string">'wsgi.run_once'</span>]     = <span class="literal">False</span></span><br><span class="line">        <span class="comment"># Required CGI variables</span></span><br><span class="line">        env[<span class="string">'REQUEST_METHOD'</span>]    = request_method    <span class="comment"># GET</span></span><br><span class="line">        env[<span class="string">'PATH_INFO'</span>]         = path              <span class="comment"># /hello</span></span><br><span class="line">        env[<span class="string">'SERVER_NAME'</span>]       = server_name       <span class="comment"># localhost</span></span><br><span class="line">        env[<span class="string">'SERVER_PORT'</span>]       = str(server_port)  <span class="comment"># 8888</span></span><br><span class="line">        <span class="keyword">return</span> env</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_response</span><span class="params">(self, status, response_headers, exc_info=None)</span>:</span></span><br><span class="line">        <span class="comment"># Add necessary server headers</span></span><br><span class="line">        server_headers = [</span><br><span class="line">            (<span class="string">'Date'</span>, <span class="string">'Mon, 15 Jul 2019 5:54:48 GMT'</span>),</span><br><span class="line">            (<span class="string">'Server'</span>, <span class="string">'WSGIServer 0.2'</span>),</span><br><span class="line">        ]</span><br><span class="line">        self.headers_set = [status, response_headers + server_headers]</span><br><span class="line">        <span class="comment"># To adhere to WSGI specification the start_response must return</span></span><br><span class="line">        <span class="comment"># a 'write' callable. We simplicity's sake we'll ignore that detail</span></span><br><span class="line">        <span class="comment"># for now.</span></span><br><span class="line">        <span class="comment"># return self.finish_response</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">finish_response</span><span class="params">(self, result, conn)</span>:</span></span><br><span class="line">        status, response_headers = self.headers_set</span><br><span class="line">        response = <span class="string">f'HTTP/1.1 <span class="subst">&#123;status&#125;</span>\r\n'</span></span><br><span class="line">        <span class="keyword">for</span> header <span class="keyword">in</span> response_headers:</span><br><span class="line">            response += <span class="string">'&#123;0&#125;: &#123;1&#125;\r\n'</span>.format(*header)</span><br><span class="line">        response += <span class="string">'\r\n'</span></span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> result:</span><br><span class="line">            response += data.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="comment"># Print formatted response data a la 'curl -v'</span></span><br><span class="line">        print(<span class="string">''</span>.join(</span><br><span class="line">            <span class="string">f'&gt; <span class="subst">&#123;line&#125;</span>\n'</span> <span class="keyword">for</span> line <span class="keyword">in</span> response.splitlines()</span><br><span class="line">        ))</span><br><span class="line">        response_bytes = response.encode()</span><br><span class="line">        conn.sendall(response_bytes)</span><br></pre></td></tr></table></figure><p>we use following code tell os that give the readable and writable file descriptors when possible:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readables, writables, exceptions = select.select(rlist, wlist, elist)</span><br></pre></td></tr></table></figure><p>and then we loop the <code>readables</code>, if it is a listen_socket, we accept it. if it is a socket with income data, we read it.</p><h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>Letâ€™s benchmark our wsgi server with following web application, also against Gunicorn:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/hello')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    time.sleep(<span class="number">0.2</span>)  <span class="comment"># simulate that your bussiness logic will take 200 ms</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World'</span></span><br></pre></td></tr></table></figure><p>to benchmark, we use <code>wrk</code> as following:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrk -c 1000 -d 60 -t 8 http://localhost:8888/hello</span><br></pre></td></tr></table></figure><p>Gunicorn config:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gunicorn -w 8 flask_hello:app</span><br></pre></td></tr></table></figure><p>Here is the result for multi-processing version:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">09:00 $ wrk -c 1000 -d 60 -t 8 http://localhost:8888/hello</span><br><span class="line">Running 1m <span class="built_in">test</span> @ http://localhost:8888/hello</span><br><span class="line">  8 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency   202.47ms  144.58ms   1.99s    94.69%</span><br><span class="line">    Req/Sec    92.84     40.03   282.00     66.11%</span><br><span class="line">  44396 requests <span class="keyword">in</span> 1.00m, 6.35MB <span class="built_in">read</span></span><br><span class="line">  Socket errors: connect 0, <span class="built_in">read</span> 44536, write 437, timeout 214</span><br><span class="line">Requests/sec:    739.07</span><br><span class="line">Transfer/sec:    108.26KB</span><br></pre></td></tr></table></figure><p>Here is the result for Non-Blocking IO version:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">09:07 $ wrk -c 1000 -d 60 -t 8 http://localhost:8888/hello</span><br><span class="line">Running 1m <span class="built_in">test</span> @ http://localhost:8888/hello</span><br><span class="line">  8 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency   139.15ms   49.91ms   1.91s    77.01%</span><br><span class="line">    Req/Sec   519.52    211.03     1.42k    73.73%</span><br><span class="line">  247992 requests <span class="keyword">in</span> 1.00m, 35.48MB <span class="built_in">read</span></span><br><span class="line">  Socket errors: connect 0, <span class="built_in">read</span> 38, write 0, timeout 417</span><br><span class="line">Requests/sec:   4128.61</span><br><span class="line">Transfer/sec:    604.78KB</span><br></pre></td></tr></table></figure><p>Here is the result with Gunicorn multi-processing version</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">09:03 $ wrk -c 1000 -d 60 -t 8 http://localhost:8000/hello</span><br><span class="line">Running 1m <span class="built_in">test</span> @ http://localhost:8000/hello</span><br><span class="line">  8 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    43.78ms   77.65ms   1.97s    97.56%</span><br><span class="line">    Req/Sec   472.75    350.11     2.76k    81.24%</span><br><span class="line">  217149 requests <span class="keyword">in</span> 1.00m, 35.41MB <span class="built_in">read</span></span><br><span class="line">  Socket errors: connect 0, <span class="built_in">read</span> 78, write 147, timeout 94</span><br><span class="line">Requests/sec:   3613.30</span><br><span class="line">Transfer/sec:    603.39KB</span><br></pre></td></tr></table></figure><p>here is the result on my Linux book:</p><table><thead><tr><th></th><th>Single Process</th><th>Multi-Process</th><th>Non-Blocking I/O</th><th>Gunicorn</th></tr></thead><tbody><tr><td>QPS</td><td>todo</td><td>739</td><td>4128</td><td>3613</td></tr></tbody></table><p>And found an interesting thing, Non-Blocking IO will use one process but also can support high qps, at the same time, it takes less CPU than Gunicorn pre-fork model.</p><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://www.python.org/dev/peps/pep-0333/#implementation-application-notes" target="_blank" rel="noopener">PEP 333: Python web server gateway interfaces v1.0</a><br><a href="https://ruslanspivak.com/lsbaws-part2/" target="_blank" rel="noopener">Letâ€™s build a web server</a><br><a href="https://jvns.ca/blog/2017/06/03/async-io-on-linux--select--poll--and-epoll/" target="_blank" rel="noopener">async io on linux select/poll/epoll</a>  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Letâ€™s build a wsgi server ground up with sockets, multi-processing or Select/Poll/Epoll. to achive this, you need familiar with Pythonâ€™s socket programming, Pythonâ€™s cucurreny model, Linux Non-blocking I/O.&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
      <category term="Concurrency" scheme="http://yoursite.com/tags/Concurrency/"/>
    
      <category term="WSGI" scheme="http://yoursite.com/tags/WSGI/"/>
    
      <category term="Select" scheme="http://yoursite.com/tags/Select/"/>
    
  </entry>
  
  <entry>
    <title>WSGI æœåŠ¡å™¨æ€§èƒ½åˆ†æã€è¯‘ã€‘</title>
    <link href="http://yoursite.com/2020/03/08/WSGI-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"/>
    <id>http://yoursite.com/2020/03/08/WSGI-æœåŠ¡å™¨æ€§èƒ½åˆ†æ/</id>
    <published>2020-03-08T11:36:07.000Z</published>
    <updated>2020-09-23T17:55:12.030Z</updated>
    
    <content type="html"><![CDATA[<p>çªç„¶çœ‹åˆ°Omed Habibçš„æ–‡ç« ï¼š<a href="https://www.appdynamics.com/blog/engineering/a-performance-analysis-of-python-wsgi-servers-part-2/" target="_blank" rel="noopener">A performance analysis of Python wsgi servers</a>ï¼Œè§‰å¾—Bjoernç¡®å®å¯ä»¥ç”¨åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­ï¼Œç”¨æ¥æ›¿ä»£ç°æœ‰Gunicornã€‚å› æ­¤å°†åŸæ–‡ç¿»è¯‘è‡³æ­¤ï¼Œå¸Œæœ›æ›´å¤šå¯ä»¥å¸®åŠ©æ›´å¤šäººã€‚btwï¼ŒBjoernæ˜¯ä¸€ä¸ªç”¨Cå’ŒLibuvå®ç°çš„è½»é‡åŒ–WSGIæœåŠ¡å™¨ï¼Œå„æ–¹é¢è¯„æµ‹ç›®å‰åŸºæœ¬éƒ½å¤„äºé¢†å…ˆçš„ä½ç½®ã€‚</p><a id="more"></a><p>åœ¨è¿™ä¸ªç³»åˆ—çš„ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»‹ç»äº†6æ¬¾æ¯”è¾ƒå‡ºåçš„WSGI Serverã€‚åœ¨æœ¬ç¯‡ä¸­ï¼Œæˆ‘ä¼šé€šè¿‡æ„å»ºbenchmarkæµ‹è¯•é›†æ¥è¯„æµ‹è¿™6æ¬¾serverã€‚  </p><h3 id="CGIå’Œmod-pyton"><a href="#CGIå’Œmod-pyton" class="headerlink" title="CGIå’Œmod_pyton"></a>CGIå’Œmod_pyton</h3><p>åœ¨WSGIæ ‡å‡†åŒ–ä»¥å‰ï¼ŒCGIå’Œmod_pythonå°±å·²ç»å­˜åœ¨äº†ã€‚CGIæ˜¯é€šè¿‡å¯¹æ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°çš„Pyè¿›ç¨‹æ¥å¤„ç†é“¾æ¥ï¼Œå› æ­¤æ¯”è¾ƒä½æ•ˆã€‚ mod_pythonç›¸å¯¹äºCGIï¼Œæ€§èƒ½æœ‰æå‡ï¼Œä½†æ˜¯åªèƒ½å’ŒApache Http server é›†æˆï¼Œå†µä¸”ç›®å‰å¤„äºinactive devolopçš„çŠ¶æ€ã€‚</p><h3 id="WSGI-Servers"><a href="#WSGI-Servers" class="headerlink" title="WSGI Servers"></a>WSGI Servers</h3><p>å› ä¸ºæ—¶é—´å…³ç³»ï¼Œæˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨ä¸‹é¢çš„Wsgi serverã€‚æ‰€æœ‰çš„æµ‹è¯•ä»£ç éƒ½å·²ç»å‘å¸ƒåœ¨ <a href="https://github.com/omedhabib/WSGI_Benchmarks" target="_blank" rel="noopener">github</a>ï¼Œä¸”æˆ‘ä»¬å°†ä¼šåæœŸæ›´æ–°å®ƒã€‚</p><ul><li>Bojern çš„å®˜æ–¹æ–‡æ¡£æè¿°å…¶ä¸ºâ€œéå¸¸å¿«çš„Python WSGI Serverâ€ å¹¶ä¸”å®ƒæ˜¯â€œæœ€å¿«çš„ï¼Œæœ€å°çš„ï¼Œæœ€è½»é‡åŒ–çš„â€ã€‚æˆ‘ä»¬ä½¿ç”¨é»˜è®¤çš„é…ç½®åˆ›å»ºäº†ä¸€ä¸ª<a href="https://gist.github.com/omedhabib/c3c8ff74ec3993740e80d7235251e73a" target="_blank" rel="noopener">app</a> æ¥æµ‹è¯•å®ƒã€‚</li><li>CherryPy æ˜¯ä¸€ä¸ªWSGI serverå’Œapp fraworkçš„å®ç°ã€‚</li><li>Gunicorn ç†å¿µæ¥è‡ªRubyä¸–ç•Œçš„Unicornã€‚å…¶å®˜æ–¹æ–‡æ¡£æè¿°ä¸ºâ€œå®ç°ç®€å•ï¼Œè½»é‡â€ã€‚å’Œå‰ä¸¤è€…ä¸åŒçš„æ˜¯ï¼ŒGunicornæ˜¯ä¸€ä¸ªç‹¬ç«‹å¯åŠ¨çš„serverã€‚</li><li>Meinheld ç§°å…¶ä¸ºâ€œé«˜æ€§èƒ½çš„WSGIå…¼å®¹webæœåŠ¡å™¨â€ã€‚æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œæˆ‘ä»¬åˆ›å»ºäº†è¿™ä¸ª<a href="https://gist.github.com/omedhabib/d638e213af0f843580e5ca7724005ac6" target="_blank" rel="noopener">æµ‹è¯•ç¨‹åº</a></li><li>mod_wsgi å’Œmod_python ä¸€æ ·æ¥è‡ªåŒä¸€ä¸ªä½œè€…ï¼Œä¸”åªèƒ½å’Œapache http serveræ­é…å·¥ä½œã€‚</li><li>uWSGI æ˜¯ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„WSGI serverã€‚åŒæ ·çš„æ ¹æ®é»˜è®¤é…ç½®æˆ‘ä»¬å»ºç«‹äº†ç›¸åº”çš„æµ‹è¯•ç¨‹åºã€‚</li></ul><h3 id="å‹æµ‹"><a href="#å‹æµ‹" class="headerlink" title="å‹æµ‹"></a>å‹æµ‹</h3><p>æˆ‘ä»¬ä½¿ç”¨Dockeræ¥è·‘æ¯ä¸ªbenchmarkï¼Œè¿™æ ·å¯ä»¥ç¯å¢ƒéš”ç¦»ï¼Œæ¯ä¸ªæµ‹è¯•å¯åŠ¨çš„åˆ°æ—¶å€™éƒ½æ˜¯å¹²å‡€çš„ç¯å¢ƒï¼Œä¸å—å½“å‰sysçš„å½±å“ã€‚</p><h4 id="æœåŠ¡å™¨"><a href="#æœåŠ¡å™¨" class="headerlink" title="æœåŠ¡å™¨"></a>æœåŠ¡å™¨</h4><ul><li>ç‹¬ç«‹çš„Docker å®¹å™¨</li><li>2 CPU</li><li>512 RAM</li></ul><h4 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h4><ul><li>wrk, ä¸€ä¸ªç°ä»£åŒ–çš„HTTPå‹æµ‹å·¥å…·</li><li>ä½¿ç”¨åœ¨100åˆ°10000ä¹‹é—´çš„å¹¶å‘é‡éšæœºæµ‹è¯•ä¸€ä¸ªæœåŠ¡</li><li>wrk é™åˆ¶ä½¿ç”¨2ä¸ªsystem cpu</li><li>æ¯ä¸ªæµ‹è¯•è·‘30ç§’ä¸”é‡å¤4é</li></ul><h4 id="æ€§èƒ½æ•°æ®"><a href="#æ€§èƒ½æ•°æ®" class="headerlink" title="æ€§èƒ½æ•°æ®"></a>æ€§èƒ½æ•°æ®</h4><ul><li>wrkæä¾›çš„è¯·æ±‚æ•°é‡ã€é”™è¯¯ã€å»¶è¿Ÿ</li><li>Docker statå·¥å…·æä¾›çš„CPUã€memä½¿ç”¨æƒ…å†µ</li><li>å»æ‰ä¸¤è¾¹çš„æå€¼ç„¶åå–å¹³å‡</li><li>è¯·å‚è€ƒï¼š<a href="https://github.com/omedhabib/WSGI_Benchmarks/blob/master/benchmark.sh" target="_blank" rel="noopener">script</a></li></ul><h4 id="ç»“æœæ•°æ®"><a href="#ç»“æœæ•°æ®" class="headerlink" title="ç»“æœæ•°æ®"></a>ç»“æœæ•°æ®</h4><p>æ‰€æœ‰çš„è¯„æµ‹æ•°æ®éƒ½æ”¾åœ¨é¡¹ç›®githubç›®å½•ä¸‹çš„summary csvæ–‡ä»¶ã€‚å¦‚æœä½ æ„Ÿå…´è¶£å¯ä»¥å°†å…¶å¯¼å…¥å›¾å½¢åŒ–å·¥å…·æ¥åˆ†æã€‚</p><h3 id="QPS"><a href="#QPS" class="headerlink" title="QPS"></a>QPS</h3><p>ä¸‹å›¾å±•ç¤ºäº†6æ¬¾serverçš„QPSæƒ…å†µï¼Œæ•°æ®è¶Šå¤§è¶Šå¥½ã€‚<br><img src="/img/wsgi_qps.png" alt="request served"></p><p><img src="/img/wsgi_qps_bjoern_hidden.png" alt="request served bojern hidden"></p><ul><li>Bojern æ˜¯æ˜æ˜¾çš„èƒœå‡ºè€…</li><li>CherryPyå°½ç®¡ç”¨çº¯Pythonå®ç°ï¼Œä½†æ˜¯å…¶æ€§èƒ½ç›¸å½“ä¸é”™</li><li>Meinheldä¹Ÿå¯ä»¥</li><li>mod_wsgi æ€§èƒ½ç¨³å®šï¼Œä½†æ˜¯å¹¶æ²¡æœ‰é‚£ä¹ˆå‡ºè‰²</li><li>Gunicorn éšç€å¹¶å‘é‡å¢å¤§qpsä¸‹é™</li><li>uWSGIè¡¨ç°å«åº•<br>èƒœå‡ºè€…ï¼šBojern</li></ul><h3 id="å»¶è¿Ÿ"><a href="#å»¶è¿Ÿ" class="headerlink" title="å»¶è¿Ÿ"></a>å»¶è¿Ÿ</h3><p>å»¶è¿Ÿå°±æ˜¯ä»è¯·æ±‚å‘å‡ºåˆ°å“åº”æ”¶åˆ°è¿™æ®µæ—¶é—´ï¼Œè¶ŠçŸ­è¶Šå¥½ã€‚<br><img src="/img/wsgi_latency.png" alt="wsgi_latency"></p><ul><li>CherryPy åœ¨å¹¶å‘é‡æŒç»­å¢é•¿çš„æƒ…å†µä¸‹è¡¨ç°ç¨³å®šï¼ŒåŸºæœ¬ä½äº3æ¯«ç§’</li><li>Bjoernå»¶è¿Ÿæ¯”è¾ƒå¤§ï¼Œä½†æ˜¯åœ¨å¹¶å‘é‡ä½çš„æƒ…å†µä¸‹å»¶è¿Ÿè¾ƒå°</li><li>Gunicorn å»¶è¿Ÿä¸€ç›´ç¨³å®š</li><li>mod_wsgi å¤„äºå¹³å‡æ°´å¹³</li><li>Meinheld å’ŒBjoernä¸€æ ·ï¼Œå½“å¹¶å‘é‡å¢å¤§ï¼Œå»¶è¿Ÿå¢å¤§</li><li>uWSGI æœ€åä¸€å<br>èƒœå‡ºè€…ï¼šCherryPy<br>Note: Bjoern is the second</li></ul><h3 id="å†…å­˜ä½¿ç”¨æƒ…å†µ"><a href="#å†…å­˜ä½¿ç”¨æƒ…å†µ" class="headerlink" title="å†…å­˜ä½¿ç”¨æƒ…å†µ"></a>å†…å­˜ä½¿ç”¨æƒ…å†µ</h3><p>è¿™é‡Œè€ƒå¯Ÿæ¯ç§æœåŠ¡å™¨ä½¿ç”¨å†…å­˜æƒ…å†µï¼Œå½“ç„¶æ˜¯è¶Šä½è¶Šå¥½ã€‚<br><img src="/img/wsgi_mem.png" alt="wsgi_mem"></p><ul><li>Bjoern å†…å­˜å ç”¨æœ€å°‘ï¼Œå³ä½¿æ˜¯10000çš„å¹¶å‘ä¹Ÿåªå ç”¨äº†9M</li><li>Meinheld å’ŒBjoernåŸºæœ¬ç›¸ä¼¼</li><li>Gunicorn åœ¨å¢å¤§å¹¶å‘é‡çš„æƒ…å†µä¸‹ï¼Œå†…å­˜å ç”¨ç¨³å®š</li><li>CherryPy ä¼šéšç€å¹¶å‘å¢åŠ å ç”¨å˜å¤§</li><li>mod_wsgi è¡¨ç°ç¨³å®š</li><li>uWSGI åˆæ˜¯å ç”¨èµ„æºæœ€å¤šçš„<br>èƒœå‡ºè€…ï¼š Bjoern and Beinheld</li></ul><h3 id="é”™è¯¯"><a href="#é”™è¯¯" class="headerlink" title="é”™è¯¯"></a>é”™è¯¯</h3><p>è¿™é‡Œç»™å‡ºWeb serverä¸¢å¼ƒï¼Œæ–­å¼€æˆ–è€…è¶…æ—¶é“¾æ¥çš„æƒ…å†µã€‚<br><img src="/img/wsgi_error.png" alt="wsgi_error"></p><ul><li>CherryPy åŸºæœ¬ä¸Šé›¶é”™è¯¯</li><li>Bjoern æœ‰é‡åˆ°errorï¼Œä½†æ˜¯å…¶qpsé«˜å¾ˆå¤š</li><li>mod_wsgi å¤§æ¦‚æœ‰6%çš„é”™è¯¯ç‡</li><li>Gunicorn åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œé”™è¯¯ç‡å¤§æ¦‚9%</li><li>uWSGI å¤§æ¦‚34%çš„é”™è¯¯ç‡</li><li>Meinheld é”™è¯¯ç‡æ¯”è¾ƒé«˜<br>èƒœå‡ºè€…ï¼š CherryPy</li></ul><h3 id="CPUä½¿ç”¨æƒ…å†µ"><a href="#CPUä½¿ç”¨æƒ…å†µ" class="headerlink" title="CPUä½¿ç”¨æƒ…å†µ"></a>CPUä½¿ç”¨æƒ…å†µ</h3><p>CPUä½¿ç”¨ç‡é«˜ä¸æ˜¯åäº‹ä¹Ÿä¸æ˜¯å¥½äº‹ï¼Œå‰ææ˜¯æä¾›æœåŠ¡ç¨³å®šå°±å¥½ã€‚ä½†æ˜¯åœ¨ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ç‡æœˆåº•è¡¨ç°è¶Šå¥½ã€‚</p><p><img src="/img/wsgi_cpu_usage.png" alt="wsgi_cpu_usage"></p><ul><li>Bjoern æ˜¯å•çº¿ç¨‹çš„ï¼Œå…¶å®ç”¨ç‡100%</li><li>CherryPy æ˜¯å¤šçº¿ç¨‹ï¼Œä½†æ˜¯å› ä¸ºGILï¼Œå…¶å®ç”¨ç‡åŸºæœ¬150%</li><li>Gunicorn æ˜¯å¤šè¿›ç¨‹ï¼Œå ç”¨ç‡åœ¨150%ä»¥ä¸Š</li><li>Meinheld å’ŒGjoernå·®ä¸å¤š</li><li>mod_wsgi çœŸæ­£çš„å¤šçº¿ç¨‹ï¼Œæ‰€ä»¥åŸºæœ¬è·‘æ»¡äº†CPU</li><li>uWSGI ä½¿ç”¨ç‡è¾ƒä½<br>èƒœå‡ºè€…ï¼š Noneï¼Œå› ä¸ºæ¨¡å¼ä¸ä¸€æ ·ï¼Œæ— æ³•æ¯”è¾ƒ</li></ul><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ ¹æ®å‹æµ‹ç»“æœï¼Œæˆ‘ä»¬å¾—å‡ºç»“è®º:Bjoernæ€§èƒ½ä¼˜å¼‚ï¼ŒuWSGIè¡¨ç°æœ€å·®ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;çªç„¶çœ‹åˆ°Omed Habibçš„æ–‡ç« ï¼š&lt;a href=&quot;https://www.appdynamics.com/blog/engineering/a-performance-analysis-of-python-wsgi-servers-part-2/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;A performance analysis of Python wsgi servers&lt;/a&gt;ï¼Œè§‰å¾—Bjoernç¡®å®å¯ä»¥ç”¨åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­ï¼Œç”¨æ¥æ›¿ä»£ç°æœ‰Gunicornã€‚å› æ­¤å°†åŸæ–‡ç¿»è¯‘è‡³æ­¤ï¼Œå¸Œæœ›æ›´å¤šå¯ä»¥å¸®åŠ©æ›´å¤šäººã€‚btwï¼ŒBjoernæ˜¯ä¸€ä¸ªç”¨Cå’ŒLibuvå®ç°çš„è½»é‡åŒ–WSGIæœåŠ¡å™¨ï¼Œå„æ–¹é¢è¯„æµ‹ç›®å‰åŸºæœ¬éƒ½å¤„äºé¢†å…ˆçš„ä½ç½®ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
      <category term="Web Server" scheme="http://yoursite.com/tags/Web-Server/"/>
    
      <category term="WSGI" scheme="http://yoursite.com/tags/WSGI/"/>
    
      <category term="Performance" scheme="http://yoursite.com/tags/Performance/"/>
    
  </entry>
  
  <entry>
    <title>Redis internal 101 --[Draft]</title>
    <link href="http://yoursite.com/2020/02/24/Redis-internal-101/"/>
    <id>http://yoursite.com/2020/02/24/Redis-internal-101/</id>
    <published>2020-02-24T04:18:00.000Z</published>
    <updated>2020-09-23T17:55:12.030Z</updated>
    
    <content type="html"><![CDATA[<p>é¡¹ç›®ä¸­ç»å¸¸ä½¿ç”¨Redisä½œä¸ºcacheæ–¹æ¡ˆï¼Œä½†æ˜¯ä½ çŸ¥é“ä¸ºä»€ä¹ˆRedisä½œä¸ºä¸€ç§ç¼“å­˜é€Ÿåº¦å¦‚æ­¤å¿«ï¼Ÿä¸ºä»€ä¹ˆttlèƒ½expireæ‰ä½ çš„keyï¼Ÿæœ¬æ–‡æ¥åˆ†æè¿™äº›ä¸œè¥¿ã€‚</p><a id="more"></a>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;é¡¹ç›®ä¸­ç»å¸¸ä½¿ç”¨Redisä½œä¸ºcacheæ–¹æ¡ˆï¼Œä½†æ˜¯ä½ çŸ¥é“ä¸ºä»€ä¹ˆRedisä½œä¸ºä¸€ç§ç¼“å­˜é€Ÿåº¦å¦‚æ­¤å¿«ï¼Ÿä¸ºä»€ä¹ˆttlèƒ½expireæ‰ä½ çš„keyï¼Ÿæœ¬æ–‡æ¥åˆ†æè¿™äº›ä¸œè¥¿ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Cache" scheme="http://yoursite.com/tags/Cache/"/>
    
      <category term="Redis" scheme="http://yoursite.com/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>ä¸ºä»€ä¹ˆMySQLé‡‡ç”¨Bæ ‘ --[Draft]</title>
    <link href="http://yoursite.com/2020/02/24/%E4%B8%BA%E4%BB%80%E4%B9%88MySQL%E9%87%87%E7%94%A8B%E6%A0%91/"/>
    <id>http://yoursite.com/2020/02/24/ä¸ºä»€ä¹ˆMySQLé‡‡ç”¨Bæ ‘/</id>
    <published>2020-02-24T04:17:33.000Z</published>
    <updated>2020-09-23T17:55:12.030Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥å‰åªæœ‰MySQL, åæ¥å‡ºäº†å¾ˆå¤šå„ç§ç±»å‹çš„æ•°æ®åº“ï¼Œæ¯”å¦‚Mongodbï¼ŒInfluxdbï¼Œcassandraç­‰ï¼Œä¸ç®¡å“ªç§æ•°æ®åº“ï¼Œéƒ½éœ€è¦ä½¿ç”¨ç´¢å¼•ç®—æ³•æ¥å¿«é€Ÿæœç´¢æ•°æ®ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹MySQLä½¿ç”¨ç´¢å¼•çš„ç®—æ³•ã€‚</p><a id="more"></a>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»¥å‰åªæœ‰MySQL, åæ¥å‡ºäº†å¾ˆå¤šå„ç§ç±»å‹çš„æ•°æ®åº“ï¼Œæ¯”å¦‚Mongodbï¼ŒInfluxdbï¼Œcassandraç­‰ï¼Œä¸ç®¡å“ªç§æ•°æ®åº“ï¼Œéƒ½éœ€è¦ä½¿ç”¨ç´¢å¼•ç®—æ³•æ¥å¿«é€Ÿæœç´¢æ•°æ®ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹MySQLä½¿ç”¨ç´¢å¼•çš„ç®—æ³•ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://yoursite.com/tags/MySQL/"/>
    
      <category term="DB" scheme="http://yoursite.com/tags/DB/"/>
    
  </entry>
  
  <entry>
    <title>Django app are slow, Think Again</title>
    <link href="http://yoursite.com/2020/02/24/Django-app-are-slow-Think-Again/"/>
    <id>http://yoursite.com/2020/02/24/Django-app-are-slow-Think-Again/</id>
    <published>2020-02-24T03:59:38.000Z</published>
    <updated>2020-09-23T17:55:12.026Z</updated>
    
    <content type="html"><![CDATA[<p>ç»å¸¸å¬åˆ°åŒäº‹è¯´PythonæœåŠ¡æ€§èƒ½ä¸å¥½ï¼Œè¦å»æ‹¥æŠ±Goã€‚ä½†æ˜¯ç»†æƒ³ï¼ŒæŠ€æœ¯é‡Œé¢æ²¡æœ‰é“¶å¼¹ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œä»–è¯šç„¶æ²¡æœ‰ç¼–è¯‘å‹è¯­è¨€å¿«ã€‚æˆ‘ä»¬çš„æœåŠ¡éƒ½æ˜¯ä¸€äº›I/Oä¸ºä¸»çš„ï¼Œå¤§éƒ¨åˆ†çš„æ—¶é—´å¯èƒ½éƒ½æ˜¯åœ¨ç­‰å¾…ç½‘ç»œI/Oï¼Œå¦‚æœæ¢æˆä»»ä½•ä¸€ç§ç¼–è¯‘å‹è¯­è¨€ï¼Œéš¾é“å°±æ²¡æœ‰è¿™ç§I/Oç­‰å¾…äº†å—ï¼Ÿå†æ¯”å¦‚Instagramï¼ŒYoutubeï¼ŒDropboxç­‰éƒ½åœ¨å¤§è§„æ¨¡ä½¿ç”¨Pythonï¼Œä¸ºä»€ä¹ˆäººå®¶çš„æœåŠ¡ä¸ä¼šåƒèœ—ç‰›ä¸€æ ·å‘¢ï¼Ÿè‡ªå·±çš„Py æœåŠ¡æ€§èƒ½å·®ï¼Œæˆ‘è¿˜èƒ½åšä»€ä¹ˆå‘¢ï¼Ÿ<br>æœ¬ç¯‡æ¥åˆ†æä¸ºä»€ä¹ˆç›®å‰Djangoçš„æœåŠ¡æ²¡æœ‰æˆ‘ä»¬é¢„æƒ³çš„å¥½ï¼Ÿèƒ½åšäº›ä»€ä¹ˆæ¥æ”¹è¿›ï¼Ÿ</p><a id="more"></a>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç»å¸¸å¬åˆ°åŒäº‹è¯´PythonæœåŠ¡æ€§èƒ½ä¸å¥½ï¼Œè¦å»æ‹¥æŠ±Goã€‚ä½†æ˜¯ç»†æƒ³ï¼ŒæŠ€æœ¯é‡Œé¢æ²¡æœ‰é“¶å¼¹ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œä»–è¯šç„¶æ²¡æœ‰ç¼–è¯‘å‹è¯­è¨€å¿«ã€‚æˆ‘ä»¬çš„æœåŠ¡éƒ½æ˜¯ä¸€äº›I/Oä¸ºä¸»çš„ï¼Œå¤§éƒ¨åˆ†çš„æ—¶é—´å¯èƒ½éƒ½æ˜¯åœ¨ç­‰å¾…ç½‘ç»œI/Oï¼Œå¦‚æœæ¢æˆä»»ä½•ä¸€ç§ç¼–è¯‘å‹è¯­è¨€ï¼Œéš¾é“å°±æ²¡æœ‰è¿™ç§I/Oç­‰å¾…äº†å—ï¼Ÿå†æ¯”å¦‚Instagramï¼ŒYoutubeï¼ŒDropboxç­‰éƒ½åœ¨å¤§è§„æ¨¡ä½¿ç”¨Pythonï¼Œä¸ºä»€ä¹ˆäººå®¶çš„æœåŠ¡ä¸ä¼šåƒèœ—ç‰›ä¸€æ ·å‘¢ï¼Ÿè‡ªå·±çš„Py æœåŠ¡æ€§èƒ½å·®ï¼Œæˆ‘è¿˜èƒ½åšä»€ä¹ˆå‘¢ï¼Ÿ&lt;br&gt;æœ¬ç¯‡æ¥åˆ†æä¸ºä»€ä¹ˆç›®å‰Djangoçš„æœåŠ¡æ²¡æœ‰æˆ‘ä»¬é¢„æƒ³çš„å¥½ï¼Ÿèƒ½åšäº›ä»€ä¹ˆæ¥æ”¹è¿›ï¼Ÿ&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
      <category term="Django" scheme="http://yoursite.com/tags/Django/"/>
    
      <category term="Async" scheme="http://yoursite.com/tags/Async/"/>
    
      <category term="Concurrency" scheme="http://yoursite.com/tags/Concurrency/"/>
    
  </entry>
  
  <entry>
    <title>CPython&#39;s Garbage Collector</title>
    <link href="http://yoursite.com/2020/02/18/CPython-s-Garbage-Collector/"/>
    <id>http://yoursite.com/2020/02/18/CPython-s-Garbage-Collector/</id>
    <published>2020-02-18T02:56:50.000Z</published>
    <updated>2020-09-23T17:55:12.026Z</updated>
    
    <content type="html"><![CDATA[<p>As described in <a href="/2020/02/11/How-Python-manage-memory/">How Python manage memory</a>, we now know how CPython allocate memory for objects, but how CPython reclaim that memory? this post will show you how CPython reclaim memory through Garbage Collector.</p><a id="more"></a><h3 id="Reference-Count"><a href="#Reference-Count" class="headerlink" title="Reference Count"></a>Reference Count</h3><p>CPython use reference count relaim memory, we know that everything in Python is object, <code>int</code>, <code>str</code>, <code>list</code> or <code>dict</code> etc, which all derived from <code>PyObject</code>, which have following struct defination in C:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">object</span> &#123;</span></span><br><span class="line">    Py_ssize_t ob_refcnt;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">typeobject</span> *<span class="title">ob_type</span>;</span></span><br><span class="line">&#125; PyObject;</span><br></pre></td></tr></table></figure><p>the <code>ob_type</code> field indicated current object type, i.e <code>int</code> or <code>str</code> etc. the <code>ob_refcnt</code> is a number, it will be incremented by 1 in following situations:</p><ul><li>variable assignment</li><li>function argument passing</li><li>appending to a container object</li></ul><p>In Python we can get this reference count easily with <code>sys.getrefcount</code>, here is an example:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foo = []  <span class="comment"># now list object's ref count is 1</span></span><br><span class="line"><span class="keyword">print</span> sys.getrefcount(foo)  <span class="comment"># will print 2, cuz getrefcount function will increase 1 count to ref count</span></span><br></pre></td></tr></table></figure><p>when an objectâ€™s reference count goes to zero, it will be automatically freed by Python to itâ€™s memory pool. and Python will return memory to operating system only and only if the whole <code>arena</code> memory area are empty. but due to <strong>memory fragement</strong>, all <code>arenas</code> will in used situation, thus Python will hold lots of memory when it is running.</p><p>Reference count is incredibly simple and efficient, but it cant deal with reference cycles. thus Python have an supplemental algorithm called <em>generation garbage collection</em>, .</p><p>The reference counting module is fundamental to Python thus cant be disabled, but <em>generation garbage collection</em> is optional and can be disabled manually like following:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gc.disable()</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="Reference-Cycles"><a href="#Reference-Cycles" class="headerlink" title="Reference Cycles"></a>Reference Cycles</h3><p>A reference cycle occurs when one or more objects referencing each other or itself. </p><p><img src="https://rushter.com/static/uploads/img/circularref.svg" alt="objects referencing each other"></p><p>For container objejcts like <code>list</code>, <code>tuppel</code>, <code>dict</code>, <code>class</code> etc, will meet this cycle.</p><p>here is an example:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gc</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># disable generation gc first</span></span><br><span class="line">gc.disable()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># objects referencing each other</span></span><br><span class="line">object_one = &#123;&#125;  <span class="comment"># refcnt: 1</span></span><br><span class="line">object_two = &#123;&#125;  <span class="comment"># refcnt: 2</span></span><br><span class="line"></span><br><span class="line">object_one_addr = id(object_one)</span><br><span class="line">object_two_addr = id(object_two)</span><br><span class="line"></span><br><span class="line">object_one[<span class="string">'object_two'</span>] = object_two  <span class="comment"># refcnt: 2</span></span><br><span class="line">object_two[<span class="string">'object_one'</span>] = object_one  <span class="comment"># refcnt: 2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> object_one, object_two  <span class="comment"># after del, the object are unreachable, but the refcnt is still 1, thus cant be reclamed</span></span><br><span class="line"><span class="keyword">print</span> ctypes.c_long.from_address(object_one_addr).value  <span class="comment"># 1</span></span><br><span class="line"><span class="keyword">print</span> ctypes.c_long.from_address(object_two_addr).value  <span class="comment"># 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># object referencing itself</span></span><br><span class="line">lst_obj = []  <span class="comment"># refcnt: 1</span></span><br><span class="line">lst_obj_addr = id(lst_obj)</span><br><span class="line">lst_obj.append(lst_obj)  <span class="comment"># refcnt: 2</span></span><br><span class="line"><span class="keyword">del</span> lst_obj  <span class="comment"># refcnt: 1, after del, refcnt to object is still 1, thus cant be cleaned</span></span><br><span class="line"><span class="keyword">print</span> ctypes.c_long.from_address(lst_obj_addr).value  <span class="comment"># 1</span></span><br></pre></td></tr></table></figure><p>We know that Reference Counting only free object when itâ€™s <code>ob_refcnt</code> field is zero. but objects which have reference cycles never goes to zero, thus Reference Counting canâ€™t free it.</p><h3 id="Generational-Garbage-Collection"><a href="#Generational-Garbage-Collection" class="headerlink" title="Generational Garbage Collection"></a>Generational Garbage Collection</h3><p>To solve reference cycle problems, CPython use Generational Garbage Collection. Generation GC will run periodically(whenever the number of objects gets over the threshhold <code>gc.get_threshhold()</code>).</p><h4 id="How-to-detect-reference-cycles"><a href="#How-to-detect-reference-cycles" class="headerlink" title="How to detect reference cycles"></a>How to detect reference cycles</h4><p>CPython only focus on container objects, i.e. objects that can contain another object: arrays, dictrionaries, user classes etc. also GC will ignore tupples with only immutable types(int, str).   </p><p>For this CPython have two doubly linked list: one of list objects to be scanned, and a tentatively unreachable list.  </p><p>Letâ€™s take an example: </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># object self referencing</span></span><br><span class="line">lst_obj = []</span><br><span class="line">lst_obj.append(lst_obj)</span><br><span class="line"></span><br><span class="line"><span class="comment"># objects ref each other</span></span><br><span class="line">object_one = &#123;&#125;</span><br><span class="line">object_two = &#123;&#125;</span><br><span class="line">object_three = &#123;&#125;</span><br><span class="line"></span><br><span class="line">A = object_one</span><br><span class="line">object_one[<span class="string">'object_two'</span>] = object_two</span><br><span class="line">object_two[<span class="string">'object_three'</span>] = object_three</span><br><span class="line">object_three[<span class="string">'object_one'</span>] = object_one</span><br></pre></td></tr></table></figure><p>1, when gc starts, it has all objects in first list, each object also has an <code>gc_ref</code> field initially equal to <code>ob_refcnt</code>, as following image shows, you can ref code <code>[update_refs](https://hg.python.org/cpython/file/eafe4007c999/Modules/gcmodule.c#l335)</code> for more detailed info:</p><p><img src="https://pythoninternal.files.wordpress.com/2014/07/python-cyclic-gc-1-new-page.png" alt="doubly linked list"></p><p>2, GC then iterate each objects in first list. for each object, it will decrements by 1 the gc_ref of the objects that current object refering.</p><p><img src="https://pythoninternal.files.wordpress.com/2014/07/python-cyclic-gc-2-new-page.png" alt="scan objects"></p><p>3, GC scan again the first list, objects with <code>gc_ref</code> zero are marked as <code>GC_INTENTATIVE_UNREACHABLE</code> and moved to intentative unreachable list, as following image shows:</p><p><img src="https://pythoninternal.files.wordpress.com/2014/07/python-cyclic-gc-3-new-page.png" alt="unreachable intentative list"></p><p>4, GC scan first list again, cuz link1â€™s gc_ref is 1, it is marked as <code>GC_REACHABLE</code>.</p><p><img src="https://pythoninternal.files.wordpress.com/2014/07/python-cyclic-gc-4-new-page.png" alt="mark reachable">  </p><p>5, When GC encounters rechable objects, it traverse all objects it referencing, mark them <code>GC_REACHABEL</code> too and move them into first list.<br><img src="https://pythoninternal.files.wordpress.com/2014/07/python-cyclic-gc-5-new-page.png" alt="move back">  </p><p>6, When all objects are scaned, the container objects in tentively unreachable list can be garbage collected.</p><h4 id="Optimization-1-limiting-the-time-for-each-collection"><a href="#Optimization-1-limiting-the-time-for-each-collection" class="headerlink" title="Optimization #1: limiting the time for each collection"></a>Optimization #1: limiting the time for each collection</h4><p>The most objects die yong, for example, most objects we created will not be used later, thus can be collected shortly, these are yong objects. on the other side, the older objects are unlikely collected .  </p><p>CPython defined 3 generations of objects from 0 to 2. every new object starts at generation 0, when it survives one GC round, it moves to next generation. the older generation, the longer it lives, thus unlikely collected. </p><h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>CPython use reference counting mainly, will use generational garbage collection as an suplenmental method. to make your code efficient, plz dont write cyclic reference, this will cost time when generational garbage collector runs.</p><h3 id="Reference-Resource"><a href="#Reference-Resource" class="headerlink" title="Reference Resource"></a>Reference Resource</h3><p><a href="http://arctrix.com/nas/python/gc/" target="_blank" rel="noopener">Portable Garbage Collection</a><br><a href="https://www.youtube.com/watch?v=CLW5Lyc1FN8&t=1139s" target="_blank" rel="noopener">PyCon 2019: Time to take out rubbish: garbage collector by Pablo Galindo Salgado</a><br><a href="https://www.youtube.com/watch?v=F6u5rhUQ6dU" target="_blank" rel="noopener">PyCon 2016: Memory management in Python by Nina Zakharenko</a><br><a href="https://pythoninternal.wordpress.com/2014/08/04/the-garbage-collector/" target="_blank" rel="noopener">The Garbage Collector by Lpoulain</a><br><a href="https://rushter.com/blog/python-garbage-collector/" target="_blank" rel="noopener">Garbage collection in Python: things you need to know by Aertem Golubin</a>  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;As described in &lt;a href=&quot;/2020/02/11/How-Python-manage-memory/&quot;&gt;How Python manage memory&lt;/a&gt;, we now know how CPython allocate memory for objects, but how CPython reclaim that memory? this post will show you how CPython reclaim memory through Garbage Collector.&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
      <category term="CPtyhon" scheme="http://yoursite.com/tags/CPtyhon/"/>
    
      <category term="GC" scheme="http://yoursite.com/tags/GC/"/>
    
      <category term="Memory Management" scheme="http://yoursite.com/tags/Memory-Management/"/>
    
  </entry>
  
  <entry>
    <title>Speed up your code with concurrency</title>
    <link href="http://yoursite.com/2020/02/11/Speed-up-your-code-with-concurrency/"/>
    <id>http://yoursite.com/2020/02/11/Speed-up-your-code-with-concurrency/</id>
    <published>2020-02-11T01:55:06.000Z</published>
    <updated>2020-09-23T17:55:12.030Z</updated>
    
    <content type="html"><![CDATA[<p>Why my code still slow after i <a href="/2020/02/01/Profiling-and-Optimizing/">Profiling and Optimizing</a>, or even <a href="/2020/02/09/Lift-Your-Python-Speed/">Lift Your Python Speed</a>? what else could i do to improve the speed of my code? the answer is <code>concurrency</code>!</p><a id="more"></a><p>There are two kinds of tasks, i.e CPU bound or I/O bound task. if your task mainly focus on calculation, then itâ€™s a CPU bound, if your task mainly spend time waitting File I/O, Network I/O etc, then its a I/O bound task. </p><p>Python have <code>multi-threading</code>, <code>multi-processing</code>, <code>asyncio</code>, for different kinds of task, you need use different kinds of concurrency.</p><blockquote><p>note concurrency is time sharing, even though multiple tasks <code>runing</code> the same time, there are only one task runing in the CPU at a time. but parallism will use multi cpus run the tasks at the same time.</p></blockquote><p>I will use an I/O bound task and CPU bound task show you how these methods can speedup your code.</p><h3 id="Speedup-I-O-bound-task"><a href="#Speedup-I-O-bound-task" class="headerlink" title="Speedup I/O bound task"></a>Speedup I/O bound task</h3><p>Task: download page from many sites</p><h4 id="Sync-version"><a href="#Sync-version" class="headerlink" title="Sync version"></a>Sync version</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_site</span><span class="params">(url, session)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">        print(<span class="string">f"Read <span class="subst">&#123;len(response.content)&#125;</span> from <span class="subst">&#123;url&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_all_sites</span><span class="params">(sites)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> requests.Session() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> sites:</span><br><span class="line">            download_site(url, session)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    sites = [</span><br><span class="line">        <span class="string">"http://csrgxtu.github.io/2020/02/18/CPython-s-Garbage-Collector/"</span>,</span><br><span class="line">        <span class="string">"http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/"</span>,</span><br><span class="line">    ] * <span class="number">80</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    download_all_sites(sites)</span><br><span class="line">    duration = time.time() - start_time</span><br><span class="line">    print(<span class="string">f"Downloaded <span class="subst">&#123;len(sites)&#125;</span> in <span class="subst">&#123;duration&#125;</span> seconds"</span>)</span><br></pre></td></tr></table></figure><p>run it on my mac (Processor: 2.7 GHz Intel Core i7, Memory: 16GB 2133 MHz LPDDR3)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ python3 download_sites.py</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">Read 18547 from http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/</span><br><span class="line">Read 32524 from http://csrgxtu.github.io/2020/02/18/CPython<span class="_">-s</span>-Garbage-Collector/</span><br><span class="line">Read 18547 from http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/</span><br><span class="line">Read 32524 from http://csrgxtu.github.io/2020/02/18/CPython<span class="_">-s</span>-Garbage-Collector/</span><br><span class="line">Read 18547 from http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/</span><br><span class="line">Downloaded 160 <span class="keyword">in</span> 147.5717649459839 seconds</span><br></pre></td></tr></table></figure><p>it took 147.57 seconds. if you run upper code, the time will be different, cuz it depends on your network connection.</p><h4 id="Multi-threading-version"><a href="#Multi-threading-version" class="headerlink" title="Multi-threading version"></a>Multi-threading version</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">thread_local = threading.local()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_session</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> hasattr(thread_local, <span class="string">"session"</span>):</span><br><span class="line">        thread_local.session = requests.Session()</span><br><span class="line">    <span class="keyword">return</span> thread_local.session</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_site</span><span class="params">(url)</span>:</span></span><br><span class="line">    session = get_session()</span><br><span class="line">    <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">        print(<span class="string">f"Read <span class="subst">&#123;len(response.content)&#125;</span> from <span class="subst">&#123;url&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_all_sites</span><span class="params">(sites)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        executor.map(download_site, sites)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    sites = [</span><br><span class="line">        <span class="string">"http://csrgxtu.github.io/2020/02/18/CPython-s-Garbage-Collector/"</span>,</span><br><span class="line">        <span class="string">"http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/"</span>,</span><br><span class="line">    ] * <span class="number">80</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    download_all_sites(sites)</span><br><span class="line">    duration = time.time() - start_time</span><br><span class="line">    print(<span class="string">f"Downloaded <span class="subst">&#123;len(sites)&#125;</span> in <span class="subst">&#123;duration&#125;</span> seconds"</span>)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ python3 download_sites.py</span><br><span class="line"></span><br><span class="line">Read 32524 from http://csrgxtu.github.io/2020/02/18/CPython<span class="_">-s</span>-Garbage-Collector/</span><br><span class="line">Read 18547 from http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/</span><br><span class="line">Read 32524 from http://csrgxtu.github.io/2020/02/18/CPython<span class="_">-s</span>-Garbage-Collector/</span><br><span class="line">Read 32524 from http://csrgxtu.github.io/2020/02/18/CPython<span class="_">-s</span>-Garbage-Collector/</span><br><span class="line">Read 18547 from http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/</span><br><span class="line">Downloaded 160 <span class="keyword">in</span> 34.54466891288757 seconds</span><br></pre></td></tr></table></figure><p>it took 34.54 seconds.</p><h4 id="Multi-processing-version"><a href="#Multi-processing-version" class="headerlink" title="Multi-processing version"></a>Multi-processing version</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_site</span><span class="params">(url)</span>:</span></span><br><span class="line">    session = requests.Session()</span><br><span class="line">    <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">        print(<span class="string">f"Read <span class="subst">&#123;len(response.content)&#125;</span> from <span class="subst">&#123;url&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_all_sites</span><span class="params">(sites)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ProcessPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        executor.map(download_site, sites)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    sites = [</span><br><span class="line">        <span class="string">"http://csrgxtu.github.io/2020/02/18/CPython-s-Garbage-Collector/"</span>,</span><br><span class="line">        <span class="string">"http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/"</span>,</span><br><span class="line">    ] * <span class="number">80</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    download_all_sites(sites)</span><br><span class="line">    duration = time.time() - start_time</span><br><span class="line">    print(<span class="string">f"Downloaded <span class="subst">&#123;len(sites)&#125;</span> in <span class="subst">&#123;duration&#125;</span> seconds"</span>)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ python3 download_sites.py</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">Read 18547 from http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/</span><br><span class="line">Read 32524 from http://csrgxtu.github.io/2020/02/18/CPython<span class="_">-s</span>-Garbage-Collector/</span><br><span class="line">Read 18547 from http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/</span><br><span class="line">Read 32524 from http://csrgxtu.github.io/2020/02/18/CPython<span class="_">-s</span>-Garbage-Collector/</span><br><span class="line">Read 18547 from http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/</span><br><span class="line">Downloaded 160 <span class="keyword">in</span> 41.209649085998535 seconds</span><br></pre></td></tr></table></figure><p>it took 41.20 seconds</p><h4 id="Async-IO-version"><a href="#Async-IO-version" class="headerlink" title="Async-IO version"></a>Async-IO version</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">download_site</span><span class="params">(session, url)</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">        print(<span class="string">"Read &#123;0&#125; from &#123;1&#125;"</span>.format(response.content_length, url))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">download_all_sites</span><span class="params">(sites)</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        tasks = []</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> sites:</span><br><span class="line">            task = asyncio.ensure_future(download_site(session, url))</span><br><span class="line">            tasks.append(task)</span><br><span class="line">        <span class="keyword">await</span> asyncio.gather(*tasks, return_exceptions=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    sites = [</span><br><span class="line">        <span class="string">"http://csrgxtu.github.io/2020/02/18/CPython-s-Garbage-Collector/"</span>,</span><br><span class="line">        <span class="string">"http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/"</span>,</span><br><span class="line">    ] * <span class="number">80</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(download_all_sites(sites))</span><br><span class="line">    duration = time.time() - start_time</span><br><span class="line">    print(<span class="string">f"Downloaded <span class="subst">&#123;len(sites)&#125;</span> sites in <span class="subst">&#123;duration&#125;</span> seconds"</span>)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ python3 download_sites.py</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">Read 5112 from http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/</span><br><span class="line">Read 5112 from http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/</span><br><span class="line">Read 5112 from http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/</span><br><span class="line">Read 8104 from http://csrgxtu.github.io/2020/02/18/CPython<span class="_">-s</span>-Garbage-Collector/</span><br><span class="line">Downloaded 160 sites <span class="keyword">in</span> 14.110821962356567 seconds</span><br></pre></td></tr></table></figure><p>it took 14.11 seconds.</p><h4 id="Multi-processing-Async-I-O"><a href="#Multi-processing-Async-I-O" class="headerlink" title="Multi-processing + Async-I/O"></a>Multi-processing + Async-I/O</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">download_site</span><span class="params">(session, url)</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">        print(<span class="string">"Read &#123;0&#125; from &#123;1&#125;"</span>.format(response.content_length, url))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">download_all_sites</span><span class="params">(sites)</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        tasks = []</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> sites:</span><br><span class="line">            task = asyncio.ensure_future(download_site(session, url))</span><br><span class="line">            tasks.append(task)</span><br><span class="line">        <span class="keyword">await</span> asyncio.gather(*tasks, return_exceptions=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">asyc_tasks</span><span class="params">(sites)</span>:</span></span><br><span class="line">    asyncio.get_event_loop().run_until_complete(download_all_sites(sites))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">chunks</span><span class="params">(lst, n)</span>:</span></span><br><span class="line">    <span class="string">"""Yield successive n-sized chunks from lst."""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(lst), n):</span><br><span class="line">        <span class="keyword">yield</span> lst[i:i + n]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    sites = [</span><br><span class="line">        <span class="string">"http://csrgxtu.github.io/2020/02/18/CPython-s-Garbage-Collector/"</span>,</span><br><span class="line">        <span class="string">"http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/"</span>,</span><br><span class="line">    ] * <span class="number">80</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ProcessPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        futures = [executor.submit(asyc_tasks, s) <span class="keyword">for</span> s <span class="keyword">in</span> chunks(sites, <span class="number">5</span>)]</span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(futures):</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    duration = time.time() - start_time</span><br><span class="line">    print(<span class="string">f"Downloaded <span class="subst">&#123;len(sites)&#125;</span> sites in <span class="subst">&#123;duration&#125;</span> seconds"</span>)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ python download_sites.py</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">Read 8104 from http://csrgxtu.github.io/2020/02/18/CPython<span class="_">-s</span>-Garbage-Collector/</span><br><span class="line">Read 5112 from http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/</span><br><span class="line">Read 8104 from http://csrgxtu.github.io/2020/02/18/CPython<span class="_">-s</span>-Garbage-Collector/</span><br><span class="line">Read 8104 from http://csrgxtu.github.io/2020/02/18/CPython<span class="_">-s</span>-Garbage-Collector/</span><br><span class="line">Read 8104 from http://csrgxtu.github.io/2020/02/18/CPython<span class="_">-s</span>-Garbage-Collector/</span><br><span class="line">Read 5112 from http://csrgxtu.github.io/2020/02/11/Speed-up-your-code-with-concurrency/</span><br><span class="line">Downloaded 160 sites <span class="keyword">in</span> 6.9041831493377686 seconds</span><br></pre></td></tr></table></figure><p>it took 6.90 seconds.</p><p>Here is the summary result of the upper experiments:  </p><table><thead><tr><th align="center">x</th><th>Sync</th><th>Threading</th><th>Processing</th><th>Async-I/O</th><th>Processing+Async-I/O</th></tr></thead><tbody><tr><td align="center">Time(Seconds)</td><td>147.57</td><td>35.54</td><td>41.20</td><td>14.11</td><td>6.90</td></tr></tbody></table><p>For sync version, it request the site one by one, thus most time spend on waiting network I/O. here is a diagramï¼š</p><p><img src="https://files.realpython.com/media/IOBound.4810a888b457.png" alt="sync version">  </p><p>By using Threading or Processing, OS will switch the threading or processing, when one task is waitting or running, OS will put other task into running, thus will reduce the total time on waitting I/O, here is the diagram for threading.:</p><p><img src="https://files.realpython.com/media/Threading.3eef48da829e.png" alt="threading">  </p><p>here is the multi-processing diagram:</p><p><img src="https://files.realpython.com/media/MProc.7cf3be371bbc.png" alt="processing">  </p><p>As we can see, multi-processing version is slower than multi-threading version, one reason is that process is heavier than thread, it needs to start new interpreter for each process.</p><p>Both multi-threading and multi-processing depend on OSâ€™s process management. i.e we donâ€™t know when our task will be switched from running to pending.   </p><p>Async-I/O will use event loop, you need decide when your task need to switch. i.e if it comes to I/O, you need switch to another task, when I/O done, you need process it. if you forget it when coding, it will pending the main loop forever!!! here is the diagram:</p><p><img src="https://files.realpython.com/media/Asyncio.31182d3731cf.png" alt="async">  </p><p>For more information on Async, plz refer <a href="https://stackoverflow.com/questions/49005651/how-does-asyncio-actually-work/51116910#51116910" target="_blank" rel="noopener">async</a> or google <code>how async works?</code></p><p>Note: Python 2 dont have async support yet, but you can use 3rd party libs: <code>gevent</code> or <code>tonardo</code>. plz use latest Python version.</p><h3 id="Speedup-CPU-bound-task"><a href="#Speedup-CPU-bound-task" class="headerlink" title="Speedup CPU bound task"></a>Speedup CPU bound task</h3><p>Task: computes the sum of the squares of each number from 0 to the passed-in value</p><h4 id="sync"><a href="#sync" class="headerlink" title="sync"></a>sync</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cpu_bound</span><span class="params">(number)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(i * i <span class="keyword">for</span> i <span class="keyword">in</span> range(number))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_sums</span><span class="params">(numbers)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> number <span class="keyword">in</span> numbers:</span><br><span class="line">        cpu_bound(number)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    numbers = [<span class="number">5000000</span> + x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">20</span>)]</span><br><span class="line"></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    find_sums(numbers)</span><br><span class="line">    duration = time.time() - start_time</span><br><span class="line">    print(<span class="string">f"Duration <span class="subst">&#123;duration&#125;</span> seconds"</span>)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ python3 cpu_bound.py</span><br><span class="line"></span><br><span class="line">Duration 11.239729881286621 seconds</span><br></pre></td></tr></table></figure><p>this will be done on a signle thread on a signle process on a signle cpu. here is the diagram:</p><p><img src="https://files.realpython.com/media/CPUBound.d2d32cb2626c.png" alt="sync cpu bound">  </p><h4 id="theading-or-async-version"><a href="#theading-or-async-version" class="headerlink" title="theading or async version"></a>theading or async version</h4><p>if you rewrite upper code into threading or async, it will slow down, cuz threading context switch or code complicity added by both will take additional time.</p><h4 id="multiprocessing"><a href="#multiprocessing" class="headerlink" title="multiprocessing"></a>multiprocessing</h4><p>Pythonâ€™s <code>multiprocessing</code> module is designed to share heavy CPU workloads to multi CPUS.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cpu_bound</span><span class="params">(number)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(i * i <span class="keyword">for</span> i <span class="keyword">in</span> range(number))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_sums</span><span class="params">(numbers)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> multiprocessing.Pool() <span class="keyword">as</span> pool:</span><br><span class="line">        pool.map(cpu_bound, numbers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    numbers = [<span class="number">5</span>_000_000 + x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">20</span>)]</span><br><span class="line"></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    find_sums(numbers)</span><br><span class="line">    duration = time.time() - start_time</span><br><span class="line">    print(<span class="string">f"Duration <span class="subst">&#123;duration&#125;</span> seconds"</span>)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python3 cpu_bound.py</span><br><span class="line">Duration 3.2296340465545654 seconds</span><br></pre></td></tr></table></figure><p>as you can see, it only use 3.22 seconds with multi-processing.</p><p>here is the diagram:</p><p><img src="https://files.realpython.com/media/CPUMP.69c1a7fad9c4.png" alt="multi-cpus"></p><h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>For tasks that wont run frequently, it is no need to use concurrency, cuz adding concurrency support need additional work to change your code and also increases the complecity. if your code is I/O bound, then <code>Async-I/O</code> or <code>Multi-Processing + Async-I/O</code> will be a better choice. for CPU bound tasks, use <code>Multi-Processing</code>.  </p><p><em>My Django app is slow? think again!!!</em></p><h3 id="Rerence"><a href="#Rerence" class="headerlink" title="Rerence"></a>Rerence</h3><p><a href="https://stackoverflow.com/questions/49005651/how-does-asyncio-actually-work/51116910#51116910" target="_blank" rel="noopener">how async works</a><br><a href="https://www.youtube.com/watch?v=MCs5OvhV9S4" target="_blank" rel="noopener">Python concurrency from ground up by David Beazley from Pycon 2015</a><br><a href="https://realpython.com/python-concurrency/" target="_blank" rel="noopener">Python concurrency by Jim Anderson</a>  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Why my code still slow after i &lt;a href=&quot;/2020/02/01/Profiling-and-Optimizing/&quot;&gt;Profiling and Optimizing&lt;/a&gt;, or even &lt;a href=&quot;/2020/02/09/Lift-Your-Python-Speed/&quot;&gt;Lift Your Python Speed&lt;/a&gt;? what else could i do to improve the speed of my code? the answer is &lt;code&gt;concurrency&lt;/code&gt;!&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
      <category term="Concurrency" scheme="http://yoursite.com/tags/Concurrency/"/>
    
  </entry>
  
  <entry>
    <title>How Python manage memory</title>
    <link href="http://yoursite.com/2020/02/11/How-Python-manage-memory/"/>
    <id>http://yoursite.com/2020/02/11/How-Python-manage-memory/</id>
    <published>2020-02-11T01:28:45.000Z</published>
    <updated>2020-09-23T17:55:12.026Z</updated>
    
    <content type="html"><![CDATA[<p>Python is a garbage collection language, means programmers donâ€™t need to care about memory when coding. until we meet high memory usage in production environment and donâ€™t know why our Django web application takes so much memory. to understand why high memory usage in Python web application, need to know following:  </p><ul><li>CPythonâ€™s memory management model</li><li>CPythonâ€™s GC</li><li>What can we do to reduce memory usage<a id="more"></a></li></ul><h3 id="Python-implementations"><a href="#Python-implementations" class="headerlink" title="Python implementations"></a>Python implementations</h3><p>Python have many implementations, like CPython, PyPy, Jython, IronPython etc. each of the implementation have itâ€™s own memory management model and Garbage collector. In most case, we use CPython, which is writen in C language. thus i will only cover CPythonâ€™s memory management model and garbage collector.  </p><h3 id="How-old-version-CPython-manage-memory"><a href="#How-old-version-CPython-manage-memory" class="headerlink" title="How old version CPython manage memory"></a>How old version CPython manage memory</h3><p>In older version Python, like versions before 2.2, CPython use <code>glibc</code>â€˜s <code>malloc</code> and <code>free</code> allocate and release memory directly. when u create objects, CPython will call <code>glibc</code>â€˜s method to allocate memory. when objects no longer needed, it will freeed by <code>glibc</code>. without memory management, this method works but not efficiency. cuz we will constantly create new objects and release them, this will cuz constantly invocation of <code>glibc</code>, thus slow down the Python code. but, this way is simple, and wonâ€™t waste memory(only allocate memory when needed and return it back to OS when no need).  </p><p>here is the corresponding logic chart for old version CPython<br><img src="/img/old_version_cpython_mem_logic.png" alt="old version cpython memory layer">  </p><h3 id="How-CPython-manage-memory-now"><a href="#How-CPython-manage-memory-now" class="headerlink" title="How CPython manage memory now?"></a>How CPython manage memory now?</h3><p>Request memory when needed works fine, but it needs constantly invocation of <code>glibc</code> methods. like working with threading or processing, we usaully use <code>pool</code>. when need new thread/processing to run, we just create it from pool in our code directly instead of calling <code>multithreading</code> or <code>multiprocessing</code> directly, this sames us time.  </p><p>To make memory allocation or release more efficiently, Python starts using a new memory model since 2.4. here is the logic chart for new memory model:</p><p><img src="/img/py-mem-model.png" alt="py memory model"></p><p>CPython has an object allocator that is responsible for allocating memory within the object memory area. This object allocator is where most of the magic happens. It gets called every time a new object needs space allocated or deleted.  </p><p>To manage memeory, CPython object allocator use <strong>Arenas</strong>, <strong>Pools</strong>, <strong>Blocks</strong> internally. lets explain them one by one.</p><h4 id="Arenas"><a href="#Arenas" class="headerlink" title="Arenas"></a>Arenas</h4><p>The arena is a chunk of 256kB memory allocated on the heap, which provides memory for 64 pools. here is the logic chart of arena:</p><p><img src="/img/arena.png" alt="arena png"></p><p>the structure of the Arena objects looks like following:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arena_object</span> &#123;</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> address;</span><br><span class="line">    block* pool_address;</span><br><span class="line">    uint nfreepools;</span><br><span class="line">    uint ntotalpools;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pool_header</span>* <span class="title">freepools</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">arena_object</span>* <span class="title">nextarena</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">arena_object</span>* <span class="title">prevarena</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>All arenas are linked using doubly linked list (the <code>nextarena</code> and <code>prevarena</code> fields), <code>address</code> is the header address of the doubly linked list, it helps to manage them. The <code>ntotalpools</code> and <code>nfreepools</code> are storing information about currently available pools.  </p><p>The freepools field points to the linked list of available pools.  </p><h4 id="Pools"><a href="#Pools" class="headerlink" title="Pools"></a>Pools</h4><p>A collection of blocks of the same size is called a pool. itâ€™s 4kb, same with OSâ€™s default page size. limiting pool with a fixed size of blocks helps with fragmentation.  </p><p>the structure of the Pool objects looks like following:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Pool for small blocks. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pool_header</span> &#123;</span></span><br><span class="line">    <span class="keyword">union</span> &#123; block *_padding;</span><br><span class="line">            uint count; &#125; ref;          <span class="comment">/* number of allocated blocks    */</span></span><br><span class="line">    block *freeblock;                   <span class="comment">/* pool's free list head         */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pool_header</span> *<span class="title">nextpool</span>;</span>       <span class="comment">/* next pool of this size class  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pool_header</span> *<span class="title">prevpool</span>;</span>       <span class="comment">/* previous pool       ""        */</span></span><br><span class="line">    uint arenaindex;                    <span class="comment">/* index into arenas of base adr */</span></span><br><span class="line">    uint szidx;                         <span class="comment">/* block size class index        */</span></span><br><span class="line">    uint nextoffset;                    <span class="comment">/* bytes to virgin block         */</span></span><br><span class="line">    uint maxnextoffset;                 <span class="comment">/* largest valid nextoffset      */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Pools of the same sized blocks are linked together using doubly linked list (the nextpool and prevpool fields). The szidx field keeps the size class index, whereas ref.count keeps the number of used blocks. The arenaindex stores the number of an arena in which Pool was created. </p><p>The freeblock field is described as follows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Blocks within pools are again carved out as needed.  pool-&gt;freeblock points to</span><br><span class="line">the start of a singly-linked list of free blocks within the pool.  When a</span><br><span class="line">block is freed, it<span class="string">'s inserted at the front of its pool'</span>s freeblock list.  Note</span><br><span class="line">that the available blocks <span class="keyword">in</span> a pool are *not* linked all together when a pool</span><br><span class="line">is initialized.  Instead only <span class="string">"the first two"</span> (lowest addresses) blocks are</span><br><span class="line"><span class="built_in">set</span> up, returning the first such block, and setting pool-&gt;freeblock to a</span><br><span class="line">one-block list holding the second such block.  This is consistent with that</span><br><span class="line">pymalloc strives at all levels (arena, pool, and block) never to touch a piece</span><br><span class="line">of memory until it<span class="string">'s actually needed.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">So long as a pool is in the used state, we'</span>re certain there *is* a block</span><br><span class="line">available <span class="keyword">for</span> allocating, and pool-&gt;freeblock is not NULL.  If pool-&gt;freeblock</span><br><span class="line">points to the end of the free list before we<span class="string">'ve carved the entire pool into</span></span><br><span class="line"><span class="string">blocks, that means we simply haven'</span>t yet gotten to one of the higher-address</span><br><span class="line">blocks.  The offset from the pool_header to the start of <span class="string">"the next"</span> virgin</span><br><span class="line">block is stored <span class="keyword">in</span> the pool_header nextoffset member, and the largest value</span><br><span class="line">of nextoffset that makes sense is stored <span class="keyword">in</span> the maxnextoffset member when a</span><br><span class="line">pool is initialized.  All the blocks <span class="keyword">in</span> a pool have been passed out at least</span><br><span class="line">once when and only when nextoffset &gt; maxnextoffset.</span><br></pre></td></tr></table></figure><p>here is the block size index table:  </p><table><thead><tr><th align="center">Request in Bytes</th><th align="center">Size of allocated block</th><th align="center">Size class index</th></tr></thead><tbody><tr><td align="center">1-8</td><td align="center">8</td><td align="center">0</td></tr><tr><td align="center">9-16</td><td align="center">16</td><td align="center">1</td></tr><tr><td align="center">â€¦</td><td align="center"></td><td align="center"></td></tr><tr><td align="center">505-512</td><td align="center">512</td><td align="center">63</td></tr></tbody></table><p>Pool have three states:  </p><ul><li>Used, partially used, neither full or empty</li><li>Full, all poolâ€™s blocks are currently allocated</li><li>Empty, all poolâ€™s blocks are currently available for allocation</li></ul><p>In order to effiently manage pools, Cpython use an array called <code>usedpools</code>, it stores pointers to pools grouped by class as following image shows:</p><p><img src="https://rushter.com/static/uploads/img/usedpools.svg" alt="usedpool array"></p><p>Note that pools and blocks are not allocating memory directly, instead, they are using already allocated space from arenas.</p><h4 id="Blocks"><a href="#Blocks" class="headerlink" title="Blocks"></a>Blocks</h4><p>Blocks are a chunk of memory of certain size. there are 64 kinds of blocks, as block size index table shows, your <code>int</code> or <code>list</code> will finnaly use these blocks.:</p><table><thead><tr><th align="center">Request in Bytes</th><th align="center">Size of allocated block</th><th align="center">Size class index</th></tr></thead><tbody><tr><td align="center">1-8</td><td align="center">8</td><td align="center">0</td></tr><tr><td align="center">9-16</td><td align="center">16</td><td align="center">1</td></tr><tr><td align="center">â€¦</td><td align="center"></td><td align="center"></td></tr><tr><td align="center">505-512</td><td align="center">512</td><td align="center">63</td></tr></tbody></table><h3 id="Garbage-Collector"><a href="#Garbage-Collector" class="headerlink" title="Garbage Collector"></a>Garbage Collector</h3><p>When you create objects in your code, CPythonâ€™s object allocator will allocate blocks of memeory from pool or arena(CPythonâ€™s memory manager). when you leave your code, CPythonâ€™s garbage collector will free the memory to Python memeory manager.  </p><p>For detail, ref post <a href="/2020/02/18/CPython-s-Garbage-Collector/">CPythonâ€™s Garbage Collector</a></p><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://github.com/python/cpython/blob/7d6ddb96b34b94c1cbdf95baa94492c48426404e/Objects/obmalloc.c" target="_blank" rel="noopener">Github: CPythonâ€™s obmalloc.c</a><br><a href="https://realpython.com/python-memory-management/" target="_blank" rel="noopener">Real Python: Python memory management</a><br><a href="https://realpython.com/python-memory-management/" target="_blank" rel="noopener">Ruster: Python memory management</a><br><a href="https://www.evanjones.ca/memoryallocator/" target="_blank" rel="noopener">Evan Johes: Improving Pythonâ€™s memory allocator</a><br><a href="https://www.youtube.com/watch?v=HHFCFJSPWrI" target="_blank" rel="noopener">EuroPython 2011: Understading Pythonâ€™s memory model: Mutability and Methods</a>  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Python is a garbage collection language, means programmers donâ€™t need to care about memory when coding. until we meet high memory usage in production environment and donâ€™t know why our Django web application takes so much memory. to understand why high memory usage in Python web application, need to know following:  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CPythonâ€™s memory management model&lt;/li&gt;
&lt;li&gt;CPythonâ€™s GC&lt;/li&gt;
&lt;li&gt;What can we do to reduce memory usage
    
    </summary>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
      <category term="Memory Management" scheme="http://yoursite.com/tags/Memory-Management/"/>
    
  </entry>
  
  <entry>
    <title>æ˜¥å¤©è¿˜ä¼šé¥è¿œå—</title>
    <link href="http://yoursite.com/2020/02/10/%E6%98%A5%E5%A4%A9%E8%BF%98%E4%BC%9A%E9%81%A5%E8%BF%9C%E5%90%97/"/>
    <id>http://yoursite.com/2020/02/10/æ˜¥å¤©è¿˜ä¼šé¥è¿œå—/</id>
    <published>2020-02-10T01:34:11.000Z</published>
    <updated>2020-09-23T17:55:12.030Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ªæ˜¥èŠ‚ä¸ä»¥å¾€ä¸åŒã€‚å¹´å‰é¡¹ç›®å¼€ä¼šï¼Œè®¡åˆ’ä¸‹ä¸€ä¸ªå­£åº¦çš„å·¥ä½œï¼Œå‡æ—¥å€¼ç­ï¼Œä¸ªäººè¯·å‡ï¼Œå‡æœŸå­¦ä¹ è®¡åˆ’ã€‚å®¶é‡ŒåŠå¹´å¤œé¥­ï¼Œå¹´åå‡†å¤‡èµ°äº²è®¿å‹ã€‚ä¸€åˆ‡å¦‚å¸¸è¿›è¡Œç€ï¼Œç›´åˆ°å›åˆ°è€å®¶åçš„ç¬¬å››å¤©ï¼Œæ­¦æ±‰å°åŸï¼Œè€å®¶æˆ’ä¸¥ï¼Œæ²³å—äººæ°‘çš„éš”ç¦»è¡ŒåŠ¨å…¨å›½é—»åï¼Œæ–¹çŸ¥äº‹æ€ä¸¥é‡ã€‚çœŸçš„å¥½æ¯”ã€Šè®©å­å¼¹é£ã€‹é‡Œé¢çš„å°è¯æ‰€å½¢å®¹ï¼š</p><blockquote><p>åƒç€ç«é”…å”±ç€æ­Œï¼Œçªç„¶å°±è®©éº»åŒªç»™åŠ«äº†ã€‚</p></blockquote><a id="more"></a><p>ä¸ºäº†å®‰å…¨ï¼Œä¸ºäº†ç˜Ÿç–«å°½å¿«è¿‡å»ï¼Œå“åº”æ”¿åºœå·å¬ï¼Œå‘†åœ¨å®¶é‡Œï¼Œå¯†åˆ‡å…³æ³¨ç€ç›¸å…³æ–°é—»ã€‚æœŸé—´æ„Ÿè§‰åˆ°äº†æ— èŠï¼Œææƒ§ï¼Œéº»æœ¨ä¸ä»ã€‚ä½†ä¹Ÿçœ‹åˆ°äº†ä¸€äº›è®©è‡ªå·±æ„ŸåŠ¨çš„ä¸œè¥¿ï¼Œæ¯”å¦‚æœ‰äººä¿®æ”¹äº†å¶æŒºå°†å†›çš„ã€Šå›šæ­Œã€‹æ¥åŠè¯«å¤§å®¶ä¸è¦å¤–å‡ºï¼š</p><blockquote><p>ä¸ºäººè¿›å‡ºçš„é—¨ç´§é”ç€ï¼›<br>æƒ³æ­»çš„é—¨æ•å¼€ç€ï¼›<br>æœ‰ä¸ªç—…æ¯’åœ¨å¤–é«˜å–Šç€ï¼š<br>â€œå‡ºæ¥ç©å§ï¼Œç»™ä½ è‡ªç”±ï¼â€<br>ä½†æˆ‘æ·±æ·±çš„çŸ¥é“ â€”-<br>å‡ºå»äº†ï¼Œå°±æ­»å®šäº†ã€‚<br>äººçš„ç”Ÿå‘½åªæœ‰ä¸€æ¬¡ï¼<br>ç®—æ±‚äº†ï¼Œ<br>å†å®…åå‡ å¤©å°±è‡ªç”±äº†ï¼<br>           ã€Šç–«æ­Œã€‹</p></blockquote><p>ç°åœ¨çœ‹åˆ°é€šæŠ¥çš„æ•°å­—æ˜¯éº»æœ¨çš„äº†ï¼Œä½†æ˜¯ä»Šæ—©çœ‹åˆ°è±†ç“£ç”¨æˆ·<code>å°æ­</code>çš„æ—¥è®°ï¼ŒçœŸçš„ä½“ä¼šåˆ°äº†é‚£ç§ææƒ§ï¼Œæ— å¥ˆï¼š<br><a href="https://www.douban.com/people/cclethe/statuses" target="_blank" rel="noopener">å°æ­çš„å¹¿æ’­</a></p><p><img src="/img/xiaohang.png" alt="å°æ­çš„å¹¿æ’­"></p><p>ä»Šå¤©å¥¹æ²¡æœ‰æ›´æ–°äº†ï¼Œä¸çŸ¥é“çŠ¶æ€å¦‚ä½•ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™ä¸ªæ˜¥èŠ‚ä¸ä»¥å¾€ä¸åŒã€‚å¹´å‰é¡¹ç›®å¼€ä¼šï¼Œè®¡åˆ’ä¸‹ä¸€ä¸ªå­£åº¦çš„å·¥ä½œï¼Œå‡æ—¥å€¼ç­ï¼Œä¸ªäººè¯·å‡ï¼Œå‡æœŸå­¦ä¹ è®¡åˆ’ã€‚å®¶é‡ŒåŠå¹´å¤œé¥­ï¼Œå¹´åå‡†å¤‡èµ°äº²è®¿å‹ã€‚ä¸€åˆ‡å¦‚å¸¸è¿›è¡Œç€ï¼Œç›´åˆ°å›åˆ°è€å®¶åçš„ç¬¬å››å¤©ï¼Œæ­¦æ±‰å°åŸï¼Œè€å®¶æˆ’ä¸¥ï¼Œæ²³å—äººæ°‘çš„éš”ç¦»è¡ŒåŠ¨å…¨å›½é—»åï¼Œæ–¹çŸ¥äº‹æ€ä¸¥é‡ã€‚çœŸçš„å¥½æ¯”ã€Šè®©å­å¼¹é£ã€‹é‡Œé¢çš„å°è¯æ‰€å½¢å®¹ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;åƒç€ç«é”…å”±ç€æ­Œï¼Œçªç„¶å°±è®©éº»åŒªç»™åŠ«äº†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Life" scheme="http://yoursite.com/tags/Life/"/>
    
  </entry>
  
  <entry>
    <title>Lift Your Python Speed</title>
    <link href="http://yoursite.com/2020/02/09/Lift-Your-Python-Speed/"/>
    <id>http://yoursite.com/2020/02/09/Lift-Your-Python-Speed/</id>
    <published>2020-02-09T04:00:54.000Z</published>
    <updated>2020-09-23T17:55:12.026Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>The easiest way to get your code to run faster is to make it do less work. assuming youâ€™ve already chosen good algorithms and youâ€™ve reduced the amount of data youâ€™re processing, the easiest way to execute fewer instructions is to compile your code down to machine code.</p></blockquote><a id="more"></a><p>In previous post <a href="/2020/02/01/Profiling-and-Optimizing/">Profiling and Optimizating</a> I talked about how to profiling and optimizing your code, apart from that, what can we do to make the code run faster?  </p><p>Python offers a number of options for this, including pure C-based compiling approaches like Cython, ShedSkin and Pythran; LLVM-based compiling via Numba; and the replacement virtual machine PyPy, which includes a built-in just-in-time(JIT) compiler. you need to balancethe requirements of code adaptability and team velocity when deciding which route to take.<br>In this post I will focus on PyPy and Cython.</p><h3 id="What-sort-of-speed-gains-are-possible"><a href="#What-sort-of-speed-gains-are-possible" class="headerlink" title="What sort of speed gains are possible?"></a>What sort of speed gains are possible?</h3><p>Python code that tends to run faster after compiling is probably mathematical and it probably has lots of loops that repeat the same operations many times. Inside these loops, youâ€™re probably making lots of temporary objects.  </p><p>Code that calls out to external liraries (e.g regular expressions, string operations, calls to database libraries) is unlikely to show any speed up after compiling. Programs that are I/O-bound are also unlikely to show significant speedups. also if your code call <code>numpy</code> or <code>scipy</code>, it may not run any faster after compile to <code>C</code> code.  </p><p>Usually, some effort profiling and compiling brings a lot of reward, but continued effort tends to pay inscreasingly less. same to <em>100 meters race</em>, the faster you run, the harder you train.</p><h3 id="JIT-versus-AOT-compilers"><a href="#JIT-versus-AOT-compilers" class="headerlink" title="JIT versus AOT compilers"></a>JIT versus AOT compilers</h3><p>There are two kinds of compilers: JIT (just in time) and AOT (ahead of time).   </p><p>JIT compilers will step into code and compile it when you using it, you donâ€™t need do much work, but it have a cold start problems. normally the second time run will be much faster. PyPy and Numba are the representations of JIT compilers.  </p><p>AOT compilers will compile code first into corresponding machine code, then this compiled lib can be used instantly. It needs you change code correspondingly. Cython, ShedSkin, Pythran are the representations of AOT compilers.  </p><table><thead><tr><th>AOT</th><th>JIT</th></tr></thead><tbody><tr><td>Cython</td><td>Numba</td></tr><tr><td>ShedSkin</td><td>PyPy</td></tr><tr><td>Pythran</td><td></td></tr></tbody></table><table><thead><tr><th></th><th>Python2</th><th>Python3</th></tr></thead><tbody><tr><td>Cython</td><td>Y</td><td>Y</td></tr><tr><td>ShedSkin</td><td>Y</td><td>N</td></tr><tr><td>Pythran</td><td>Y</td><td>Y</td></tr><tr><td>Numba</td><td>N</td><td>Y</td></tr><tr><td>PyPy</td><td>Y</td><td>Y</td></tr></tbody></table><h3 id="Why-does-type-information-help-code-run-faster"><a href="#Why-does-type-information-help-code-run-faster" class="headerlink" title="Why does type information help code run faster?"></a>Why does type information help code run faster?</h3><p>Python is dynamically typed â€“ a variable can refer to an object of any type, and any line of code can change the type of the object that is referred to. this makes it difficult for the virtual machine to optimize how the code is executed at the machine code level, as it doesnâ€™t know which fundamental datatype will be used for future operations. keeping the code generic mkes it run more slowly.  </p><p>Inside Python every fundamental object, like an integer, will be wrapped up in a higher level Python object. the higher level object has extra unctions like <code>__hash__</code> to assist with storage and <code>__str__</code> for printing.  </p><p>Inside a section of code that is CPU bound, it is often the case that tye types of variables dont change. this gives us an opportunity for static compilation and faster code execution.  </p><p>For mathmatical operations, we donâ€™t need high level functions, even the Cpythonâ€™s reference counting GC. we can use machine level code directly. thus it will not interact with Pythonâ€™s VM and directly run on your machine, this will save you lots of time. by doing this, we usually declare types or use <code>C</code> functions directly in Python code.</p><h3 id="Cython"><a href="#Cython" class="headerlink" title="Cython"></a>Cython</h3><p>Cython is a compiler that converts type-annotated Python into a compiled extension module. the type annotations are C-like. this extension can be imported as regular Python module using <code>import</code>. Getting started is simple, but it does have a learning curve that must be climbed with each additional elvel of complexity and optimization.  </p><p>It actually another programming language that can interact with Python. to make our code run faster, we need to anylize the code, find which part interact with Python, which donâ€™t. and then optimize the part which interact with Python. by doing so we can find it easily:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cython -a find_duplicate_movies.pyx</span><br></pre></td></tr></table></figure><p><img src="/img/cython_annotation.png" alt="cython annotation"></p><p>** But it need a learning curve!!! **, i will cover it later.</p><h3 id="PyPy"><a href="#PyPy" class="headerlink" title="PyPy"></a>PyPy</h3><p>PyPy is an alternative implementation of the Python language that includes a tracing just-in-time compiler; it is compatibale with Python 2.7 and an experimental Python3.2 version is available.  </p><p>PyPy uses a different type of garbage collector to CPython, and this can cause some nonobvious behavior changes to your code. Whereas CPython uses reference counting, PyPy uses a modified mark and sweep approach that may clean up unused object much later. Both are correct implementations of the Python specification.  for example, when read file, CPython will close the file handler when itâ€™s done due to reference counting. but for PyPy, it will close and flush data later.  </p><h3 id="Experiment"><a href="#Experiment" class="headerlink" title="Experiment"></a>Experiment</h3><p>here is the example from <a href="/2020/02/01/Profiling-and-Optimizing/">Profiling and Optimizing</a>, find duplicate movies in a list of movie titles from file. here is the data file which contains 6511101 lines: <a href="/img/titles.txt">titles.txt</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_movies</span><span class="params">(src)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(src) <span class="keyword">as</span> fd:</span><br><span class="line">        <span class="keyword">return</span> fd.read().splitlines()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_duplicate_movies</span><span class="params">(src=<span class="string">"titles.txt"</span>)</span>:</span></span><br><span class="line">    movies = read_movies(src)</span><br><span class="line">    movies = [movie.lower() <span class="keyword">for</span> movie <span class="keyword">in</span> movies]</span><br><span class="line">    movies.sort()</span><br><span class="line">    duplicates = []</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> range(len(movies) - <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> movies[idx] == movies[idx + <span class="number">1</span>]:</span><br><span class="line">            duplicates.append(movies[idx])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> duplicates</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    res = find_duplicate_movies()</span><br><span class="line">    <span class="keyword">print</span> res[<span class="number">0</span>:<span class="number">5</span>]</span><br></pre></td></tr></table></figure><p>run it with CPython directly, it use 10 seconds:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">time python find_duplicate_movies.py</span><br><span class="line"></span><br><span class="line">real0m10.187s</span><br><span class="line">user0m9.503s</span><br><span class="line">sys0m0.635s</span><br></pre></td></tr></table></figure><p>run it with PyPy, it use 7 seconds, much faster then CPython.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">time pypy find_duplicte_movies.py</span><br><span class="line"></span><br><span class="line">real0m7.340s</span><br><span class="line">user0m6.456s</span><br><span class="line">sys0m0.724s</span><br></pre></td></tr></table></figure><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href>High Performance Python â€“ Chapter 7</a><br><a href="https://cython.org/#documentation" target="_blank" rel="noopener">Cython</a><br><a href="https://www.youtube.com/watch?v=_1MSX7V28Po" target="_blank" rel="noopener">Cython as a game changer</a><br><a href="https://www.youtube.com/watch?v=zx0wMxuh-wk" target="_blank" rel="noopener">Cython to speed up your Python code</a><br><a href="https://pypy.org/" target="_blank" rel="noopener">PyPy</a>  </p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;The easiest way to get your code to run faster is to make it do less work. assuming youâ€™ve already chosen good algorithms and youâ€™ve reduced the amount of data youâ€™re processing, the easiest way to execute fewer instructions is to compile your code down to machine code.&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
      <category term="Optimization" scheme="http://yoursite.com/tags/Optimization/"/>
    
  </entry>
  
  <entry>
    <title>æŠ€æœ¯é©±åŠ¨å‹å…¬å¸</title>
    <link href="http://yoursite.com/2020/02/06/%E6%8A%80%E6%9C%AF%E9%A9%B1%E5%8A%A8%E5%9E%8B%E5%85%AC%E5%8F%B8/"/>
    <id>http://yoursite.com/2020/02/06/æŠ€æœ¯é©±åŠ¨å‹å…¬å¸/</id>
    <published>2020-02-06T02:18:51.000Z</published>
    <updated>2020-09-23T17:55:12.030Z</updated>
    
    <content type="html"><![CDATA[<p>å¶å°”çœ‹åˆ°<code>äºŒå¾‹èƒŒå</code>åœ¨çŸ¥ä¹ä¸Šå›ç­”é—®é¢˜<a href="https://www.zhihu.com/question/312019918/answer/608965942" target="_blank" rel="noopener"><code>ä½œä¸º IT è¡Œä¸šçš„è¿‡æ¥äººï¼Œä½ æœ‰ä»€ä¹ˆè¯æƒ³å¯¹åè¾ˆè¯´çš„ï¼Ÿ</code></a>ï¼Œæ„Ÿè§‰ç‰¹åˆ«é€‚åˆè‡ªå·±ç°åœ¨çš„å¤„å¢ƒï¼Œæ‰€ä»¥æ‘˜æŠ„å‡ºæ¥ï¼š</p><blockquote><p>1ï¼Œä¸–ç•Œä¸Šæ²¡æœ‰æŠ€æœ¯é©±åŠ¨å‹å…¬å¸ï¼Œå› ä¸ºåœ¨å…¬å¸ï¼Œä¸€åˆ‡éƒ½æ˜¯éœ€æ±‚ä¼˜å…ˆçš„ã€‚<br>2ï¼Œä½ åšçš„å¥½ä¸å¥½ä¸å–å†³äºä½ å¤šèªæ˜ï¼Œè€Œå–å†³äºä½ æ˜¯å¦æ„¿æ„ä¸æ–­è¯»ä¹¦ï¼Œä¸æ–­å­¦ä¹ ï¼Œä¸æ–­ç§¯ç´¯ï¼Œä¸æ–­æ€è€ƒã€‚<br>3ï¼Œå…¬å¸æ˜¯åˆ›é€ è´¢å¯Œçš„åœ°æ–¹ï¼Œä¸æ˜¯å­¦æ ¡ï¼Œä½ å¯ä»¥åœ¨å·¥ä½œä¸­å­¦ä¹ ï¼Œä½†æ˜¯ä¸å¯ä»¥æ”¾ä¸‹å·¥ä½œç„¶åå­¦ä¹ ï¼Œé™¤éä½ çš„å·¥ä½œå·²ç»åšå®Œäº†ã€‚<br>4ï¼Œä¸€å®šè¦æƒ³å¥½åœ¨åŠ¨æ‰‹ï¼Œæƒ³å¥½çš„æ ‡å¿—å°±æ˜¯æ–‡æ¡£å†™å¥½ã€‚<br>5ï¼Œèµ„æœ¬çš„è¿è½¬æ˜¯ä¸èƒ½åœçš„ï¼Œå› ä¸ºä¸€åœä¸‹æ¥æŸå¤±çš„é’±å¤ªå¤šã€‚æ‰€ä»¥èµ„æœ¬å¯Œé›†çš„åœ°æ–¹åŠ ç­æ˜¯å¸¸äº‹ã€‚<br>6ï¼Œç°ä»£ç®¡ç†å­¦çš„ç²¾é«“å°±æ˜¯è®©æ¯ä¸ªäººå˜å¾—å¯æ›¿ä»£ã€‚</p></blockquote><a id="more"></a><p>ä¸–ç•Œä¸Šæ²¡æœ‰æŠ€æœ¯é©±åŠ¨å‹å…¬å¸ï¼Œä¸è®ºgoogleã€facebookï¼Œè¿˜æ˜¯è…¾è®¯ã€é˜¿é‡Œï¼Œéƒ½ä¸æ˜¯æŠ€æœ¯é©±åŠ¨å‹å…¬å¸ã€‚<strong>å› ä¸ºæŠ€æœ¯ä¸æ˜¯æºå¤´ï¼Œéœ€æ±‚æ‰æ˜¯</strong>ã€‚å› æ­¤ä¸€åˆ‡æŠ€æœ¯é—®é¢˜ï¼Œéƒ½è¦æœä»äº§å“äº¤ä»˜å’Œå¸‚åœºåé¦ˆã€‚æ‰€ä»¥ï¼Œä»»ä½•å…¬å¸ï¼Œéƒ½ä¸å¯èƒ½ä»¥æŠ€æœ¯å»é©±åŠ¨è‡ªèº«ã€‚äººå¯ä»¥ä»¥æŠ€æœ¯é©±åŠ¨è‡ªå·±è¿›æ­¥ï¼Œä½†å…¬å¸ä¸è¡Œã€‚ä¸€å®¶å…¬å¸å¯ä»¥ä»¥æŠ€æœ¯åˆ‡å…¥æŸä¸ªå¸‚åœºï¼Œä½†å¦‚æœå®ƒæƒ³ç”Ÿå­˜ä¸‹å»ï¼Œå°±ä¸€å®šä¸èƒ½ä»¥æŠ€æœ¯ä¸ºå¯¼å‘ï¼ŒåšæŒä»¥æŠ€æœ¯ä¸ºå¯¼å‘çš„å…¬å¸çš„ç”Ÿå‘½åŠ›ä¸ºé›¶ï¼Œå…¶ä¸‹åœºæœ‰ä¸¤ä¸ªï¼šç ´äº§æˆ–è€…åœ¨ç ´äº§ä¹‹å‰è¢«æ”¶è´­ã€‚å¦‚æœä½ çœŸçš„å¾ˆç—´è¿·é’»ç ”æŠ€æœ¯ï¼Œè¯·è¯»ç ”è¯»åšæœ€åç•™æ ¡æˆ–è€…è¿›ç ”ç©¶é™¢è®©å›½å®¶ç”¨çº³ç¨äººçš„é’±å…»ä½ ã€‚  </p><p>èµ„æœ¬å¯Œé›†çš„åœ°æ–¹ï¼Œäººéƒ½å¾—åŠ ç­ï¼ŒåŠ ç­çš„æœ¬è´¨ï¼Œæ˜¯äººè·Ÿç€æœºå™¨è·‘ã€äººè·Ÿç€é’±è·‘ï¼›æ›´ä¸ºæœ¬è´¨åœ°è¯´ï¼Œèµ„æœ¬å¯Œé›†çš„åœ°æ–¹ï¼Œäººä½œä¸ºåŠ³åŠ¨åŠ›ï¼Œä¹Ÿæ˜¯èµ„æœ¬çš„ä¸€ç§ã€‚å³ï¼Œäººæ˜¯èµ„æœ¬è€Œä¸æ˜¯äººæœ¬èº«ã€‚èµ„æœ¬çš„è¿è½¬æ˜¯ä¸èƒ½åœçš„ï¼Œå› ä¸ºåœä¸€ä¸‹æŸå¤±çš„é’±å¤ªå¤šäº†ã€‚ä¸­å›½ã€å¤–å›½ï¼Œéƒ½ä¸€æ ·ã€‚çŸ¥é“å‘è¾¾å›½å®¶ä¸ºä»€ä¹ˆäº§ä¸šå·¥äººä¸åŠ ç­å—ï¼Ÿå› ä¸ºåˆ¶é€ ä¸šå·²ç»ä¸æ˜¯è¿™äº›å›½å®¶ä¸»è¦åˆ›é€ è´¢å¯Œçš„é¢†åŸŸäº†ã€‚å‘è¾¾å›½å®¶èµ„æœ¬å¯Œé›†çš„åœ°æ–¹æ˜¯é‡‘èè¡Œä¸šï¼Œæ‰€ä»¥è¥¿æ–¹å›½å®¶çš„é‡‘èç‹—ä¸€æ ·åŠ ç­ã€‚åŠ³åŠ¨æ³•ï¼ŸåŠ ç­è´¹ï¼Ÿéƒ½ä¸å­˜åœ¨çš„ã€‚åŠ³åŠ¨æ³•å’ŒåŠ ç­è´¹åªæœ‰åœ¨èµ„æœ¬ç¦»å¼€è¿™ä¸ªå¸‚åœºåæ‰èƒ½ç»™ä½ ä¿è¯ã€‚ä¸€èˆ¬å…¬å¸çš„ç­–ç•¥æ˜¯ï¼šä»˜ç»™ä½ é«˜äºå…¶ä»–è¡Œä¸šçš„è–ªæ°´ã€æ¢å–ä½ â€œè‡ªæ„¿â€åŠ ç­ã€‚ä¸æƒ³åŠ ç­çš„åŒå­¦ä»¬ï¼Œä½ ä»¬å¯ä»¥å»è€ƒå…¬åŠ¡å‘˜æˆ–è€…å»æ¬§æ´²åšITï¼Œæˆ‘ä¿è¯ä½ ä¸åŠ ç­ã€ä¸ä½†ä¸ç”¨åŠ ç­ï¼Œä½ ç”šè‡³ä¼šé—²å‡ºç—…ã€‚  </p><p>ITæ˜¯å·¥ç§‘ï¼Œä¸æ˜¯ç†ç§‘ï¼Œå’ŒITè¡Œä¸šç›¸ä¼¼åº¦æœ€é«˜çš„è¡Œä¸šæ˜¯ç›–æ¥¼æˆ¿ã€‚çœŸçš„ï¼Œç›¸ä¼¼åº¦ç›¸å½“æƒŠäººã€‚ITé¢†åŸŸæœ€é‡è¦çš„æ˜¯ç»éªŒè€Œä¸æ˜¯ä½ æœ‰å¤šèªæ˜ï¼Œä¸èªæ˜çš„äººæˆ–è€…æ›´å‡†ç¡®åœ°è¯´ä¸é€‚åˆåšè¿™ä¸ªè¡Œä¸šçš„äººï¼Œå¤§å­¦æ¯•ä¸šåå°±æ”¹è¡Œäº†ã€‚è®°ä½ï¼šä½ åšå¾—å¥½ä¸å¥½ï¼Œä¸å–å†³äºä½ æ˜¯å¦èªæ˜ï¼Œè€Œå–å†³äºä½ æ˜¯å¦æ„¿æ„ä¸æ–­è¯»ä¹¦ä¸æ–­å­¦ä¹ å’Œä¸æ–­ç§¯ç´¯ã€‚å› æ­¤ï¼Œå¦‚æœä½ æ‰“ç®—æŠ•èº«è¿™ä¸ªè¡Œä¸šè€Œä½ è¿˜åœ¨å­¦æ ¡ï¼Œè¯·æŠ“ç´§ä¸€åˆ‡æ—¶é—´å¤šè¯»ä¹¦ã€‚  </p><p>å…¬å¸æ˜¯ä½ åˆ›é€ è´¢å¯Œçš„åœ°æ–¹ï¼Œå…¬å¸ä¸æ˜¯å­¦æ ¡ã€‚ä½ å¯ä»¥åœ¨å·¥ä½œä¸­å­¦ä¹ ï¼Œä½†ä½ ä¸èƒ½æ”¾ä¸‹å·¥ä½œç„¶åå»å­¦ä¹ é™¤éä½ çš„å·¥ä½œå·²ç»åšå®Œäº†ã€‚  </p><p><strong>èƒ½å¤§è§„æ¨¡å•†ç”¨çš„æŠ€æœ¯ï¼Œéƒ½ä¸éœ€è¦æ™ºå•†ï¼Œå¦åˆ™è¿™ç§æŠ€æœ¯å°±ä¸å¯èƒ½è§„æ¨¡åŒ–</strong>ã€‚æŸäº›ç¨‹åºå‘˜ä»¬ï¼Œè¯·åœæ­¢ä½ ä»¬çš„èœœæ±è‡ªä¿¡ã€‚  </p><p>æŠ€æœ¯æ ˆï¼Œä¸€æ—¦ç¡®ç«‹äº†ï¼Œå°±å¾ˆéš¾æ”¹äº†ã€‚ä¸€ä¸ªæŠ€æœ¯äººå‘˜æ˜¯å¦‚æ­¤ï¼Œä¸€å®¶å…¬å¸ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æ ¹æœ¬åŸå› æ˜¯ï¼šæ¯ä¸€ä¸ªæ ˆçš„sizeéƒ½å¤ªæ·±äº†â€¦å°±åƒæ˜¯ulimit -s unlimitedè¿‡ä¸€æ ·ã€‚  </p><p>ä¸€ä¸ªç¨‹åºå‘˜ï¼Œåº”è¯¥èŠ±80%çš„æ—¶é—´åšä»£ç è®¾è®¡ã€ç”»UMLå›¾ã€ç”»æ—¶åºå›¾ï¼Œ20%çš„æ—¶é—´å†™codeå’Œdebugï¼›èœé¸Ÿç¨‹åºå‘˜çš„è¿™ä¸ªæ¯”ä¾‹æ°å¥½æ˜¯åçš„ã€‚ä¸€å¥è¯ï¼Œä¸è®ºè¿™ä¸ªéœ€æ±‚æœ‰å¤šç´§æ€¥ï¼Œä½ éƒ½ä¸€å®šè¦â€œæƒ³å¥½å†åŠ¨æ‰‹â€ï¼›â€œæƒ³å¥½â€çš„æ ‡å¿—å°±æ˜¯è®¾è®¡æ–‡æ¡£å†™å¥½äº†ï¼›æ–‡æ¡£ä¸€æ—¦å†™å¥½ï¼Œå†™ä»£ç å°±æ˜¯çº¯ç²¹çš„æ— è„‘å·¥ä½œã€‚ </p><p>å†™æ–‡æ¡£çš„ç›®çš„æ˜¯è®©ä½ åœ¨codeçš„æ—¶å€™ï¼Œä¸éœ€è¦åœä¸‹æ¥æ€è€ƒæ›´ä¸éœ€è¦æ¨å€’é‡æ¥ã€‚å¦‚æœæ²¡æœ‰æ–‡æ¡£ä¹Ÿå¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½ å½“ç„¶å¯ä»¥ä¸å†™æ–‡æ¡£åŒæ—¶æ€è€ƒä¸‹è‡ªå·±æ°´å¹³è¿™ä¹ˆé«˜æ˜¯ä¸æ˜¯å¯ä»¥è¦æ±‚å‡èŒåŠ è–ªäº†â€¦â€¦æˆ–è€…ï¼Œä½ æ˜¯ä¸æ˜¯åœ¨åšæ— èŠçš„if elseç¼–ç å·¥ä½œï¼Ÿ  </p><p>è‹±è¯­ï¼Œå¾ˆé‡è¦ã€‚èƒ½å¦ä½¿ç”¨è‹±è¯­æŸ¥é˜…èµ„æ–™ï¼Œæ˜¯åŒºåˆ†æŠ€æœ¯äººå‘˜æ°´å¹³çš„é‡è¦æŒ‡ç¤ºä¹‹ä¸€ã€‚å¯„å¸Œæœ›äºâ€œæœ‰äººè¿Ÿæ—©ä¼šç¿»è¯‘æˆä¸­æ–‡â€çš„äººæ˜¯æ„šè ¢çš„ã€æ˜¯ä¼šè¢«æ·˜æ±°çš„ã€‚è¦æœ‰åˆ†äº«ç²¾ç¥ï¼Œä¸è¦æ‹…å¿ƒä½ çŸ¥é“çš„ä¸œè¥¿å‘Šè¯‰äº†åˆ«äººä½ å°±æ²¡ä»·å€¼äº†<a href="https://www.zhihu.com/question/67169545/answer/807120993" target="_blank" rel="noopener">https://www.zhihu.com/question/67169545/answer/807120993</a>ã€‚<strong>ä½ æœ€å¤§çš„ä»·å€¼åœ¨äºä½ çŸ¥é“é‚£äº›ä¸œè¥¿çš„è¿‡ç¨‹ï¼Œè€Œä¸æ˜¯é‚£äº›ä¸œè¥¿æœ¬èº«</strong>ã€‚ä½ æ„¿æ„å’Œåˆ«äººåˆ†äº«åˆ«äººè‡ªç„¶ä¹Ÿä¼šæ„¿æ„å’Œä½ åˆ†äº«ï¼Œæœ€ç»ˆè¾¾åˆ°1+1å¤§äº2çš„æ•ˆæœã€‚ä¸åˆ†äº«ï¼Œå°±åƒä¸€ä¸ªå¤±å»äº†äº’è”ç½‘çš„ç¨‹åºå‘˜ï¼Œè¯•é—®ä»–è¿˜èƒ½åˆ›é€ å¤šå°‘ä»·å€¼ï¼Ÿææ€•ä»–è¿æ—¥å¸¸å·¥ä½œéƒ½æ— æ³•å±•å¼€äº†ã€‚æŒæœ‰â€œæˆ‘æŠŠåˆ«äººçŸ¥é“çš„éƒ½å­¦ä¼šã€æˆ‘æŠŠè‡ªå·±çŸ¥é“çš„éƒ½è—èµ·æ¥åˆ«è®©åˆ«äººå­¦å»â€æƒ³æ³•çš„äººï¼Œå…¶å®æ˜¯é»˜è®¤å…¨ä¸–ç•Œåªæœ‰ä½ èªæ˜åˆ«äººéƒ½æ˜¯å‚»ç“œï¼Œè¿™æ ·çš„äººï¼Œåœ¨ä¿¡æ¯ä¼ è¾“æˆæœ¬é«˜çš„æ—¶ä»£ï¼Œå¯ä»¥æ´»ä¸‹å»ï¼Œä½†æ˜¯åœ¨ä»Šå¤©è¿™ä¸ªæ—¶ä»£ï¼Œä»–ä»¬çš„è·¯ä¼šè¶Šèµ°è¶Šçª„æœ€åä¼šè‡ªå·±èµ°å…¥æ­»èƒ¡åŒã€‚å½“ç„¶ï¼Œå¦‚æœä½ çœŸçš„çŸ¥é“äº†äº†ä¸å¾—çš„é»‘ç§‘æŠ€ï¼Œé‚£å°±è¯·ä½ ä¿æŠ¤å¥½è‡ªå·±çš„çŸ¥è¯†äº§æƒç„¶åè‡ªå·±å¼€å…¬å¸ç©å§ã€‚  </p><p>å·¥ä½œè¦æœ‰çƒ­æƒ…ã€‚  </p><p>æ™ºå•†å†³å®šä½ çš„èµ·ç‚¹æƒ…å•†å†³å®šä½ èƒ½èµ°å¤šè¿œçˆ¬å¤šé«˜ï¼›æ··èŒåœºï¼Œé çš„æ˜¯æƒ…å•†ã€‚æƒ…å•†é«˜å°±æ˜¯ï¼šåˆ«äººæ„¿æ„å’Œä½ ä¸€èµ·å·¥ä½œã€ä½ æœ‰é—®é¢˜çš„æ—¶å€™åˆ«äººæ„¿æ„å¸®ä½ ã€‚æ™ºå•†æœ‰æ—¶å€™å¯ä»¥ç¨å¾®å¼¥è¡¥ä¸€ä¸‹æƒ…å•†ä½†ä¸èµ·å†³å®šæ€§çš„ä½œç”¨ã€‚  </p><p>ç°ä»£ç®¡ç†å­¦çš„ç²¾é«“ï¼Œå°±æ˜¯è®©æ¯ä¸ªäººï¼ˆåŒ…æ‹¬è€æ¿æœ¬äººï¼‰éƒ½å˜å¾—å¯æ›¿ä»£ã€‚å¦‚æœä½ è§‰å¾—è‡ªå·±ä¸å¯æ›¿ä»£ï¼Œè¦ä¹ˆæ˜¯ä½ çš„é”™è§‰ï¼Œè¦ä¹ˆæ˜¯ä½ åœ¨ä¸€å®¶ç®¡ç†éå¸¸åŸå§‹çš„ã€æ‘‡æ‘‡æ¬²å é©¬ä¸Šè¦å®Œè›‹çš„å…¬å¸ã€‚  </p><p>æ€æ ·è®©ç¨‹åºå‘˜å˜å¾—å¯æ›¿ä»£ï¼Ÿä¸‰ä¸ªå­—ï¼šå†™æ–‡æ¡£ã€‚ä¸æ„¿æ„å†™æ–‡æ¡£çš„ç¨‹åºå‘˜ï¼Œåº”è¯¥ç«‹åˆ»é©¬ä¸Šæ¯«ä¸çŠ¹è±«åœ°å¼€æ‰ã€‚ç¨‹åºå‘˜å·¥ä½œåˆ›é€ çš„ä»·å€¼ï¼Œè‡³å°‘ä¸€åŠæ˜¯é€šè¿‡æ–‡æ¡£ä½“ç°å‡ºæ¥æ‰å¯¹ã€‚â€œä¸€ä¸ªé¡¹ç›®æ¢ä¸€ä¸ªäººå°±è¦è®©é¡¹ç›®å¤§åœ°éœ‡ä¸€ä¸‹ã€è§£å†³bugæ¢ä¸€ä¸ªäººå°±ä¸è¡Œå› ä¸ºåªæœ‰è€äººçŸ¥é“è¦æ”¹å“ªä¸€è¡Œçš„å“ªä¸ªå…³é”®å­—â€ï¼Œè¿™ä¸è¯´æ˜è¿™ä¸ªé¡¹ç›®æ‰€æ¶‰åŠçš„æŠ€æœ¯æœ‰å¤šå¤æ‚ã€ä¸è¯´æ˜è¿™ä¸ªè€äººæ˜¯ä»€ä¹ˆæŠ€æœ¯å¤§ç‰›ï¼Œè€Œåªè¯´æ˜è¿™ä¸ªé¡¹ç›®çš„é¡¹ç›®ç»ç†æ˜¯è ¢è´§å› ä¸ºè¿™ä¸ªé¡¹ç›®å·²ç»å¤±æ§äº†ã€‚æ–‡æ¡£ä¸æ˜¯äº‹æ— å·¨ç»†çš„æµæ°´è´¦ï¼Œå†™æ–‡æ¡£ä»¥åŠç»„ç»‡æ–‡æ¡£æ˜¯éœ€è¦æ™ºå•†çš„ã€æ˜¯éœ€è¦æ¶æ„å¸ˆå»è®¾è®¡çš„ã€‚ç¾å›½çš„èˆªå¤©é£æœºé‚£ä¹ˆå¤æ‚ï¼Œä½†æ˜¯åœ¨pilotæ‰‹é‡Œçš„æ‰‹å†Œä¹Ÿå°±é‚£ä¹ˆå¤šï¼Œè€Œè¿™ä¸ªæ‰‹å†Œå¯ä»¥åœ¨èˆªå¤©é£æœºå‡ºé—®é¢˜çš„æ—¶å€™ååŠ©pilotå¿«é€Ÿå®šä½ç»å¤§å¤šæ•°é—®é¢˜ã€‚ä¸å¯æ›¿ä»£çš„æ‰“å·¥è€…åªæœ‰ä¸€ç§ï¼šä»¥ä¸­é«˜å±‚é¢†å¯¼çš„èº«ä»½è·Ÿå®Œäº†ä¸€ä¸ªé¡¹ç›®è€Œä¸”è¿™ä¸ªé¡¹ç›®æ­£å¤„äºå¤§çº¢å¤§ç´«çš„é˜¶æ®µï¼Œå…¬å¸ä¸ºäº†é˜²æ­¢ä½ è·³æ§½åˆ°ç«äº‰å¯¹æ‰‹é‚£é‡Œï¼Œæ„¿æ„ä»˜ç»™ä½ è–ªæ°´å…»ç€ä½ å¤©å¤©åœ¨åŠå…¬å®¤å–èŒ¶ã€‚åªè¦é¡¹ç›®ä¸€ç›´çº¢ç€ï¼Œå…¬å¸å°±æ„¿æ„ä¸€ç›´å…»ç€ä½ ã€‚è¯»å®Œè¿™ä¸ªç­”æ¡ˆåå¦‚æœä½ è§‰å¾—æˆ‘æ˜¯ä¸€ä¸ªè½»è§†æŠ€æœ¯çš„äººï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œä½ å’Œæˆ‘ä¸€æ ·ï¼Œæ˜¯ä¸€åé’¢ç²¾ã€‚é’¢ç²¾è¯»åˆ«äººçš„å›ç­”ï¼Œæ°¸è¿œä¸ä¼šå»æ­£é¢ç†è§£ï¼Œè€Œåªä¼šæƒ³å°½ä¸€åˆ‡åŠæ³•æ‰¾è¿™ä¸ªç­”æ¡ˆçš„æ¼æ´ã€‚è§‰å¾—æˆ‘è½»è§†æŠ€æœ¯çš„äººï¼Œéº»çƒ¦çœ‹ä¸‹è¿™ä¸ªï¼š<a href="https://www.zhihu.com/question/36729502/answer/613762292" target="_blank" rel="noopener">https://www.zhihu.com/question/36729502/answer/613762292</a></p><p>======== ä¸‹é¢å±•å¼€ä¸€ç‚¹è°ˆæ–‡æ¡£å’ŒæŠ€æœ¯é©±åŠ¨ ========<br>â€œå¼€å‘äººå‘˜çš„æ–‡æ¡£çš„ä½œç”¨â€ï¼š </p><p>ç»™æ­£åœ¨codeçš„è‡ªå·±çœ‹ã€ç»™å‡ ä¸ªæœˆåå·²ç»å¿˜è®°è¿™ä¸ªæ¨¡å—å½“åˆæ˜¯æ€ä¹ˆå¼€å‘çš„è‡ªå·±çœ‹ã€ç»™è¦æ¥æ‰‹è‡ªå·±å·¥ä½œçš„æ–°äººçœ‹ã€ç»™å‘¨è¾¹æœ‰å…³è”å¼€å‘ä»»åŠ¡çš„åŒäº‹çœ‹ã€ç»™é¢†å¯¼ç­‰æœ‰å…³äººå‘˜çœ‹ã€äº§å“å‡ºbugçš„æ—¶å€™ç”¨æ¥å’Œåˆ«äººæ€¼çš„æ­¦å™¨ã€‚å¦‚æœæ²¡æœ‰æ–‡æ¡£ï¼Œè¿™äº›å·¥ä½œé‡éƒ½ä¼šæˆå€å¢é•¿ã€‚ä»£ç å†ç²¾ç®€å†ç›´è§‚ï¼Œä¹Ÿä¸å¯èƒ½æœ‰äººç±»è¯­è¨€ç›´è§‚ï¼Œè°è§‰å¾—è‡ªå·±å‰å®³åˆ°è¯»ä»£ç å’Œè¯»äººç±»è¯­è¨€å†™çš„æ–‡æ¡£é€Ÿåº¦ä¸€æ ·å¿«è¯»åœ°æ­¥ï¼Œæˆ‘ç»™ä½ ä¸ªæˆ‘ä¸Šå¤§å­¦æ—¶å€™å†™çš„å°ç¨‹åºï¼Œéº»çƒ¦ä½ è¯»ä¸€ä¸‹ä»£ç ï¼Œçœ‹çœ‹ä½ å¤šé•¿æ—¶é—´å¯ä»¥çœ‹æ˜ç™½ï¼š<a href="https://github.com/YvesZHI/FallingCode" target="_blank" rel="noopener">https://github.com/YvesZHI/FallingCode</a>è¿™æ®µä»£ç æœ¬èº«å¹¶ä¸å¤æ‚ï¼Œåº”è¯¥è¯´éå¸¸ç®€å•ï¼Œä½†æ˜¯æ²¡æœ‰æ–‡æ¡£â€¦â€¦è¯»è¯»çœ‹å§ã€‚ç®€è€Œè¨€ä¹‹ï¼Œæ–‡æ¡£ï¼Œå°±åƒç›–æ¥¼æˆ¿çš„è®¾è®¡å›¾ï¼Œæ²¡æœ‰å›¾çº¸ï¼Œä½ æ˜¯ä¸èƒ½å¼€å§‹æ¬ç –çš„ã€‚é¢†å¯¼æœ‰æ²¡æœ‰ç»™ä½ çœ‹éœ€æ±‚åˆ†ææ–‡æ¡£ï¼Ÿæœ‰æ²¡æœ‰æ‹¿ç€éœ€æ±‚åˆ†ææ–‡æ¡£ç»™ä½ å®£è®²ä½ è¦åšä»€ä¹ˆï¼Ÿæ²¡æœ‰ï¼Ÿä¸å¹²æ´»ï¼›æµ‹è¯•çš„åŒäº‹æœ‰æ²¡æœ‰ç»™ä½ çœ‹æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£ï¼Ÿæœ‰æ²¡æœ‰ç»™ä½ å®£è®²ï¼Ÿæ²¡æœ‰ï¼Ÿä¸å¹²æ´»ï¼›ä½ è‡ªå·±æ˜ç™½é¢†å¯¼çš„æ„å›¾äº†å—ï¼Ÿæ˜ç™½æµ‹è¯•åŒäº‹çš„æ„å›¾äº†å—ï¼Ÿæƒ³æ˜ç™½åï¼Œå¼€å§‹æƒ³è‡ªå·±è¦å¼€å‘çš„æ¨¡å—é‡Œçš„å„ä¸ªåŠŸèƒ½æ¨¡å—ä¹‹é—´çš„å…³ç³»ï¼Œå¯ä»¥ç”»æ—¶åºå›¾ï¼›æ—¶åºå›¾ç”»å®Œäº†ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ï¼ˆå¯èƒ½ï¼‰é¢‘ç¹å˜åŒ–çš„æ¨¡å—/éœ€æ±‚ï¼Œå¦‚æœæœ‰ï¼Œè¯·åŠ¡å¿…ä½¿ç”¨ä¸€äº›è®¾è®¡æ¨¡å¼ï¼Œå¦‚æœè¦ç”¨è®¾è®¡æ¨¡å¼ï¼Œè¯·åŠ¡å¿…ç”»UMLç±»å›¾ï¼Œå¦‚æœæ²¡æœ‰é¢‘ç¹å˜åŒ–çš„æ¨¡å—/éœ€æ±‚ï¼Œè¯·ä¸€å®šä¸è¦ç”¨è®¾è®¡æ¨¡å¼ï¼›æœ€åï¼Œçœ‹çœ‹åœ¨ä¸€ä¸ªåŠŸèƒ½æ¨¡å—ä¸­ï¼Œæœ‰æ²¡æœ‰é€»è¾‘æ¯”è¾ƒå¤æ‚çš„åœ°æ–¹ï¼Œå¦‚æœæœ‰ï¼Œè¯·ç”»æµç¨‹å›¾ï¼›æ¨¡å—å’Œæ¨¡å—ä¹‹é—´æœ‰æ²¡æœ‰éœ€è¦æ˜ç¡®çš„åè®®ï¼Ÿå¦‚æœæœ‰ï¼Œè¯·æŠŠåè®®å†™å‡ºæ¥ã€‚ä¸Šé¢è¿™ä¸€æ®µè¯ï¼Œå°±æ˜¯ä½ è¦å†™çš„æ–‡æ¡£ï¼Œè¿™ä¸ªæ–‡æ¡£çš„è¯»è€…ä¸»è¦æ˜¯ä½ ï¼Œåœ¨ä½ çš„æ¨¡å—å‡ºé—®é¢˜ä¹‹å‰ï¼Œåˆ«äººé€šå¸¸ä¸ä¼šè¯»è¿™ä¸ªæ–‡æ¡£ï¼ˆä¸æ’é™¤ä½ çš„é¢†å¯¼ä¼šè¦æ±‚çœ‹ä½ è¿™ä¸ªæ–‡æ¡£ï¼‰ã€‚å¦‚æœä½ æ—¢ä¸éœ€è¦æ—¶åºå›¾åˆä¸éœ€è¦ç±»å›¾åˆæ²¡ä»€ä¹ˆåè®®éœ€è¦æ˜ç¡®ï¼Œé‚£ä¹ˆï¼Œä½ å°±å¯ä»¥ä¸å†™è¿™ä¸ªæ–‡æ¡£ã€‚å¦å¤–ï¼Œå¦‚æœè¿™ä¸ªæ–‡æ¡£å†™å¾—å¥½ï¼Œä½ çš„ä»£ç æ˜¯ä¸éœ€è¦ä»»ä½•æ³¨é‡Šçš„ã€‚  </p><p>â€œæŠ€æœ¯é©±åŠ¨â€ï¼š  </p><p>ä¸€äº›æœ‹å‹è®¤ä¸ºæˆ‘å¯¹â€œæŠ€æœ¯é©±åŠ¨â€æœ‰è¯¯è§£ï¼Œå¯¹æ­¤æˆ‘ä¸æƒ³è¾©è®ºäº†ã€‚é¢˜ç›®æ˜¯ï¼šä½œä¸ºITè¡Œä¸šçš„è¿‡æ¥äººï¼Œæˆ‘æœ‰ä»€ä¹ˆæƒ³å¯¹åè¾ˆè¯´çš„ã€‚ä¸Šé¢é‚£æ®µè¯å°±æ˜¯æˆ‘æƒ³å¯¹åè¾ˆè¯´çš„ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå°±æ˜¯å‘Šè¯‰åè¾ˆï¼Œå¦‚æœä¸€å®¶å…¬å¸æ‰“ç€â€œæˆ‘ä»¬æ˜¯æŠ€æœ¯é©±åŠ¨å‹å…¬å¸â€çš„åå·åœ¨æ‹›äººï¼Œé‚£ä¹ˆå¦‚æœä½ å†³å®šè¦å»è¿™å®¶å…¬å¸ï¼Œæˆ‘åŠä½ ä¸€å®šè¦æƒ³å¥½è€ƒå¯Ÿå¥½ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæˆ‘çŸ¥é“ä»–çš„é‚£å¥â€œæŠ€æœ¯é©±åŠ¨â€å¾ˆå¸å¼•ä½ ä½ æƒ³å­¦ä¸œè¥¿ï¼Œä½†æ˜¯å¯¹å°å…¬å¸æ¥è¯´ï¼Œå®ƒæœ€å¤§çš„ä»»åŠ¡æ˜¯æ´»ä¸‹å»ï¼Œç„¶åæ‰æ˜¯å…¶ä»–ï¼Œæˆ‘ä¸æ˜¯è¯´å°å…¬å¸å­¦ä¸åˆ°ä¸œè¥¿ï¼Œæˆ‘åªæ˜¯è¯´å°å…¬å¸å¾ˆéš¾å¾ˆéš¾åšåˆ°çœŸæ­£çš„æŠ€æœ¯é©±åŠ¨ï¼›è¯„è®ºåŒºæœ‰äººåšæŒè®¤ä¸ºå¾®è½¯è¿™ç§å…¬å¸æ˜¯æŠ€æœ¯é©±åŠ¨ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘åé¢ä¼šä¸“é—¨è¡¥å……ï¼Œç›®å‰æˆ‘åªèƒ½è¯´ï¼šæˆ‘æ˜¯æ²¡è§è¿‡å¾®è½¯å¤§å¼ æ——é¼“åœ°è¯´è‡ªå·±æ˜¯ä»€ä¹ˆâ€œæŠ€æœ¯é©±åŠ¨â€å…¬å¸ç„¶åå¿½æ‚ æ–°äººã€‚  </p><p>â€œæŠ€æœ¯é©±åŠ¨2â€ï¼š  </p><p>çœ‹æ¥æœ‰ä¸å°‘æœ‹å‹æ„¿æ„å’Œæˆ‘çº ç»“è¿™ä¸ªâ€œæŠ€æœ¯é©±åŠ¨â€çš„é—®é¢˜ï¼Œé‚£æˆ‘å°±å’Œä½ ä»¬æ ä¸€æ ã€‚æˆ‘ä»¥åä¸ºä¸ºä¾‹æ¥è¯´è¯´ã€‚åä¸ºæˆåŠŸçš„å†…åœ¨åŸå› ï¼Œæ—©å°±æ•²é”£æ‰“é¼“åœ°å‘Šè¯‰å…¨ä¸–ç•Œäº†ï¼šä»¥å®¢æˆ·ä¸ºä¸­å¿ƒï¼Œä»¥å¥‹æ–—è€…ä¸ºæœ¬ï¼Œé•¿æœŸè‰°è‹¦å¥‹æ–—ï¼ŒåšæŒè‡ªæˆ‘æ‰¹åˆ¤ã€‚è¿™å››å¥è¯ï¼Œæ²¡ä¸€å¥æ˜¯ç›´æ¥å’ŒæŠ€æœ¯ç›¸å…³çš„ã€‚è¿™é‡Œæˆ‘å…ˆç‰¹åˆ«å£°æ˜ä¸€ä¸‹ï¼Œæˆ‘ä¸æ˜¯è¯´ï¼ŒæŠ€æœ¯äººå‘˜åœ¨åä¸ºå°±ä¸ä¼šææŠ€æœ¯ã€ä¸ä¼šæå‡è‡ªå·±çš„æŠ€æœ¯æ°´å¹³ã€åä¸ºçš„æŠ€æœ¯æ°´å¹³å·®ã€‚æˆ‘ç»ä¸æ˜¯è¿™ä¸ªæ„æ€ã€‚åä¸ºçš„æŠ€æœ¯ï¼Œä¸éœ€è¦æˆ‘å¤šè¯´ï¼Œå…¨ä¸–ç•Œçš„äººéƒ½æ˜¯æœ‰ç›®å…±ç¹çš„ï¼Œåä¸ºå…¬å¸çš„æŠ€æœ¯ä¸“åˆ©æ•°å°±æ‘†åœ¨é‚£é‡Œï¼Œé‚£æ˜¯è°ä¹ŸæŠ¹æ€ä¸äº†çš„ï¼›åä¸ºå…¬å¸é‡Œçš„æŠ€æœ¯å¤§ç‰›ï¼Œå¤šäº†å»äº†ï¼›ä½†åœ¨è¿™é‡Œï¼Œæˆ‘è¦è¯´çš„è¿˜æ˜¯ç¬¬ä¸€æ®µçš„æ„æ€ï¼šä¸€ä¸ªäººå¯ä»¥ä»¥æŠ€æœ¯é©±åŠ¨ï¼Œä½†ä¸€å®¶å…¬å¸ä¸è¡Œã€‚åä¸ºå…¬å¸çš„æ ¸å¿ƒç†å¿µï¼Œæœ¬è´¨å°±æ˜¯â€œæˆå°±å®¢æˆ·â€ï¼Œä½ æŠŠå®¢æˆ·æˆå°±äº†ï¼Œä½ å°±ä¹ŸæŠŠè‡ªå·±æˆå°±äº†ï¼Œåä¸ºä¸æ˜¯å…ˆæˆå°±è‡ªå·±å†å»æˆå°±å®¢æˆ·çš„å…¬å¸ã€‚ä½ å»åä¸ºå·¥ä½œï¼Œä½ å¯ä»¥ä»¥æŠ€æœ¯é©±åŠ¨è‡ªå·±ï¼Œä½†åä¸ºä¸èƒ½è¿™æ ·åšã€‚è¿™ä¸€ç‚¹å’Œå¾®è½¯ä¸IBMçš„åˆä½œæå…¶ç›¸ä¼¼ï¼šIBMè¯´ï¼Œä½ ä»¬å¾®è½¯ç°åœ¨æçš„ä¸œè¥¿æˆ‘æ„¿æ„ç”¨ï¼Œä½†æ˜¯æˆ‘éœ€è¦ä½ ä»¬ç»™æˆ‘æä¸ªæ“ä½œç³»ç»Ÿï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½ç»§ç»­åˆä½œã€‚ç„¶åå¾®è½¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿå®ƒé©¬ä¸Šè´­ä¹°äº†å¦å¤–ä¸€å®¶å…¬å¸æçš„DOSæ“ä½œç³»ç»Ÿï¼Œç„¶åç›´æ¥æˆæƒç»™IBMä½¿ç”¨ã€‚è¿™é‡Œé¢æœ‰å››ä¸ªé—®é¢˜éœ€è¦å„ä½ç²¾é’¢ä»¬æ€è€ƒï¼š1ï¼‰ä¸ºä»€ä¹ˆé‚£å®¶å¼€å‘DOSçš„å…¬å¸æ²¡èƒ½ç›´æ¥å’ŒIBMåˆä½œï¼Ÿ2ï¼‰å¾®è½¯è´­ä¹°DOSç³»ç»Ÿçš„é’±å“ªé‡Œæ¥çš„ï¼Ÿ3ï¼‰å¾®è½¯ä¸ºä»€ä¹ˆä¸è‡ªå·±å¼€å‘æ“ä½œç³»ç»Ÿï¼Ÿ4ï¼‰æŠ€æœ¯åœ¨å‰ä¸‰ä¸ªé—®é¢˜ä¸­çš„è§’è‰²å’Œä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿè‡³äºè¯„è®ºåŒºæœ‰æœ‹å‹è¯´Intelæ˜¯æŠ€æœ¯é©±åŠ¨å…¬å¸ï¼Œæˆ‘å»ºè®®ä»–å»äº†è§£ä¸€ä¸‹Intelä¸ºä»€ä¹ˆæ”¾å¼ƒäº†æ‰‹æœºå¸‚åœºï¼šé‡ç‚¹å…³æ³¨Intelå†³å®šæ”¾å¼ƒæ‰‹æœºå¸‚åœºçš„åŸå› ï¼Œç„¶åä½ å°±ä¼šå‘ç°ï¼Œè¿™ä¸ªåŸå› çš„æœ¬è´¨ï¼Œå°±æ˜¯ä¸€ç§æŠ€æœ¯æƒ…èŠ‚çš„äº§ç‰©ã€‚Intelæ”¾å¼ƒæ‰‹æœºå¸‚åœºä¸åä¸ºå†³å®šè¿›å†›æ‰‹æœºå¸‚åœºæ˜¯æˆªç„¶ä¸åŒçš„ã€‚åä¸ºæœ¬æ¥æ˜¯åšåŸºç«™ã€è·¯ç”±å™¨å’Œäº¤æ¢æœºçš„ï¼Œè¿™æ˜¯å®ƒçš„ä¸»è¥ä¸šåŠ¡ã€‚é‚£ä¹ˆåä¸ºä¸ºä»€ä¹ˆå†³å®šè¿›å…¥æ‰‹æœºå¸‚åœºï¼Ÿæ˜¯ä»€ä¹ˆåŸå› é©±ä½¿åä¸ºåœ¨æ²¡æœ‰ä»»ä½•æŠ€æœ¯ç§¯ç´¯çš„å‰æä¸‹è¿›å…¥æ‰‹æœºå¸‚åœºã€ä»¥è‡³äºæœ€åˆåä¸ºçš„æ‰‹æœºè¢«åä¸ºå‘˜å·¥æˆç§°ä¸ºâ€œæš–æ‰‹å®â€å€’è´´é’±éƒ½æ²¡äººæ„¿æ„ç”¨ä½†ç°åœ¨åä¸ºæ‰‹æœºå¦‚æ­¤æˆåŠŸï¼Ÿæ‰€ä»¥ï¼Œæˆ‘è¿˜æ˜¯é‚£ä¸ªè§‚ç‚¹ï¼šä¸–ç•Œä¸Šæ²¡æœ‰æŠ€æœ¯é©±åŠ¨å‹å…¬å¸ã€‚æˆ‘æœ¬äººå°±æ˜¯ç¨‹åºå‘˜ï¼Œæˆ‘ä¸€ç›´éƒ½ä»¥æŠ€æœ¯åœ¨é©±åŠ¨è‡ªå·±æˆ‘ä¸€ç›´éƒ½åœ¨åŠªåŠ›æå‡è‡ªå·±çš„æŠ€æœ¯æ°´å¹³ä½†æ˜¯æˆ‘è¿˜æ˜¯è¦è¯´ï¼šä¸–ç•Œä¸Šæ²¡æœ‰æŠ€æœ¯é©±åŠ¨å‹å…¬å¸ã€‚  </p><p>â€œæŠ€æœ¯é©±åŠ¨3â€ï¼š  </p><p>ç»§ç»­æ€¼ä¸€ä¸ªæ–°çš„teamè¦å¼€å‘ä¸€æ¬¾è½¯ä»¶ã€‚å®ƒé¦–å…ˆè¦è§£å†³çš„é—®é¢˜ï¼Œæ˜¯åœ¨äº§å“1.0å¼€å‘å‡ºæ¥å¹¶ä¸”èµšåˆ°é’±ä¹‹å‰è¿™ä¸ªteamçš„ç»è´¹ï¼›å…¶æ¬¡ï¼Œå®ƒè¦æå‰æ‰¾å¥½äº§å“çš„å®¢æˆ·ç¾¤å’Œå¯èƒ½å­˜åœ¨çš„é”€å”®æ¸ é“å¹¶ä¸”åšå®Œç›¸åº”çš„å·¥ä½œï¼›å†æ¬¡ï¼Œå®ƒè¦åšäº§å“è§„åˆ’ï¼Œå¦‚ä»€ä¹ˆæ—¶å€™å‡º1.0ç‰ˆæœ¬çš„äº§å“ã€å“ªä¸ªæ¨¡å—å¼€å‘å¤§æ¦‚è¦å¤šä¹…ã€ä»€ä¹ˆç±»å‹çš„é—®é¢˜å¯ä»¥æš‚æ—¶æç½®ä»€ä¹ˆç±»å‹çš„é—®é¢˜ä¸èƒ½æç½®è¦ç»„ç»‡æ”»å…³ç»„å…¬å…³ç­‰ï¼ˆå…¨æ˜¯é¡¹ç›®ç®¡ç†ç›¸å…³å†…å®¹ï¼Œå’ŒæŠ€æœ¯æ²¡æœ‰ç›´æ¥å…³ç³»ï¼‰ã€‚æœ€åï¼Œè¿›å…¥äº§å“å¼€å‘é˜¶æ®µã€‚ä¸€æ—¦è¿›å…¥äº§å“å¼€å‘ï¼Œå°±åƒå·¥å‚çš„æµæ°´çº¿ä¸€æ ·ï¼Œæ˜¯ä¸å¯èƒ½å‡ºç°ä»€ä¹ˆå¯¼è‡´äº§å“å¼€å‘è¿›è¡Œä¸ä¸‹å»çš„æŠ€æœ¯éš¾ç‚¹çš„ï¼ˆå¦åˆ™æŠ€æœ¯leaderå°±æ˜¯ç™½ç—´è¿™ç§äº§å“åº”è¯¥åœ¨å¤´è„‘é£æš´é˜¶æ®µå°±è¢«æ‹æ­»æ‰å¯¹ï¼‰ï¼Œæ‰€ä»¥ï¼Œâ€œæœŸæœ›å‡ºç°ä»€ä¹ˆå†³å®šäº§å“ç”Ÿæ­»çš„æŠ€æœ¯éš¾ç‚¹ç„¶åè‡ªå·±nbé—ªé—ªåœ°æå®šâ€è¿™ç§äº‹æƒ…ï¼Œæ˜¯ä¸å¯èƒ½å‘ç”Ÿçš„ï¼›åŒæ—¶ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéš¾å…å‡ºç°å„ç§æ„æ–™ä¹‹å¤–çš„bugï¼Œæ¯”å¦‚ï¼Œä½ è´Ÿè´£çš„æ¨¡å—å‡ºç°äº†ä¸‰ä¸ªbugï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯å¿…ç°é—®é¢˜ä¸”ç›´æ¥å½±å“åŠŸèƒ½å®ç°ï¼Œé‚£è¿™ä¸ªä¸€å®šè¦æå®šçš„ï¼Œå¦‚æœä½ æä¸å®šï¼Œteamä¼šæ‰¾å…¶ä»–è€æ‰‹å’Œä½ ä¸€èµ·æ”»å…³ï¼Œæ”»å…³ç»“æœæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯bugè§£å†³äº†ä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œå¦ä¸€ç§æ˜¯bugè§£å†³äº†ä¹ŸçŸ¥é“äº†æ˜¯ä¸ºä»€ä¹ˆã€‚å¯¹äºç¬¬ä¸€ç§æƒ…å†µï¼Œteamæ˜¯ä¸ä¼šè®©ä½ â€œæ½œå¿ƒç ”ç©¶å‡ ä¸ªæœˆæœ€åæ‰¾åˆ°äº†åŸå› â€çš„ï¼Œä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºä½ è¿˜æœ‰åç»­å·¥ä½œè¦å®Œæˆè€Œè¿™ä¸ªbugå·²ç»è§£å†³äº†ä¸å½±å“ç”¨æˆ·ä½¿ç”¨äº†ï¼Œä»€ä¹ˆæ—¶å€™æ‰æœ‰å¯èƒ½è®©ä½ ç»§ç»­è·Ÿè¿›è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ1.0ç‰ˆæœ¬çš„äº§å“å¸‚åœºåé¦ˆç¬¦åˆé¢„æœŸä¸”å…¬å¸å†³å®šè¦ç»§ç»­æŠ•å…¥æ2.0ç‰ˆæœ¬ â€”â€”â€”åªæœ‰è¿™ä¸ªæ¡ä»¶æ»¡è¶³ï¼Œä½ æ‰æœ‰å¯èƒ½ç»§ç»­è·Ÿè¿›è¿™ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆæ˜¯æœ‰å¯èƒ½å‘¢ï¼Ÿå› ä¸ºè¿™ä¸ªbugå·²ç»ä¸å½±å“å®¢æˆ·ä½¿ç”¨äº†ï¼Œæ²¡å¿…è¦æŠ•å…¥äººåŠ›å»æäº†ï¼Œä½ å¦‚æœèŠ±å‡ ä¸ªæœˆçš„æ—¶é—´å»æ‰¾è¿™ä¸ªbugçš„åŸå› ï¼Œé‚£ä¹ˆè¯·é—®ï¼š2.0ç‰ˆæœ¬çš„å·¥ä½œè°åšï¼Ÿåœ¨å¾ˆå¤šé¡¹ç›®ä¸­ï¼Œç±»ä¼¼è¿™ç§â€œé—®é¢˜è§£å†³äº†ä½†æ˜¯ä¸çŸ¥é“åŸå› çš„bugâ€ç°è±¡ï¼Œæ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œç›´åˆ°è¿™ä¸ªäº§å“ç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œè¿™äº›bugçš„åŸå› éƒ½æ²¡æœ‰æ‰¾åˆ°ã€‚å› æ­¤ï¼Œâ€œæœŸæœ›ç¢°åˆ°ç¥ç§˜bugç„¶åè‡ªå·±æ½œå¿ƒç ”ç©¶å‡ ä¸ªæœˆç»ˆäºæŠŠåŸå› æ‰¾åˆ°â€è¿™ç§äº‹æƒ…ï¼Œå¾ˆå¤šæ—¶å€™æ˜¯ä¸å­˜åœ¨çš„ã€‚æ¥ç€ä¸Šé¢çš„â€œä¸‰ä¸ªbugâ€ç»§ç»­ï¼šå¦å¤–ä¸¤ä¸ªbugï¼Œæ˜¯æ¦‚ç‡å‘ç”Ÿä¸”å‘ç”Ÿæ¦‚ç‡å¾ˆä½ã€‚è¿™ä¸ªæ—¶å€™å¦‚æœå·¥æœŸæ¯”è¾ƒèµ¶ï¼Œå…¬å¸ä¼šæƒ³åŠæ³•ç»•è¿‡å»è¿™ä¸¤ä¸ªbugï¼Œæ¯”å¦‚å®šæ—¶é‡å¯æœåŠ¡å™¨ã€å®šæ—¶æ¸…ç†ç¼“å­˜ç­‰ï¼ˆè¿™äº›æ–¹æ³•é€šå¸¸å¯ä»¥ç»•å¼€ä½æ¦‚ç‡bugï¼‰ï¼Œä¸ä¼šç»™ä½ â€œæ½œå¿ƒç ”ç©¶ä¸‰ä¸ªæœˆç„¶åæŠŠbugè§£å†³â€çš„æœºä¼šçš„ã€‚ä»€ä¹ˆæ—¶å€™æ‰æœ‰å¯èƒ½è®©ä½ ç»§ç»­ç ”ç©¶è¿™ä¸¤ä¸ªbugå‘¢ï¼Ÿå’Œç¬¬ä¸€ä¸ªbugä¸€æ ·ï¼Œåªæœ‰åœ¨åç»­ç»§ç»­å¼€å‘ï¼Œæ‰æœ‰å¯èƒ½è®©ä½ ç»§ç»­è·Ÿè¿›ã€‚ç°åœ¨ï¼Œè¯·å„ä½å†é‡æ–°å“å‘³ä¸€ä¸‹â€œæŠ€æœ¯é©±åŠ¨â€è¿™ä¸ªè¯ã€‚åˆ°åº•ä»€ä¹ˆæ˜¯æŠ€æœ¯é©±åŠ¨ï¼Ÿå…¶å®è¿™ä¸ªè¯çœŸæ­£çš„å«ä¹‰å°±æ˜¯ï¼šæˆ‘ä»¬å…¬å¸æ•ˆç›Šå¾ˆå¥½èƒ½å…»æ´»nbçš„æŠ€æœ¯å›¢é˜Ÿæ‰€ä»¥äº§å“èƒ½ä¸æ–­è¿­ä»£æ¼”è¿›å¼€å‘ï¼Œéšç€äº§å“çš„ä¸æ–­è¿­ä»£ï¼ŒæŠ€æœ¯äººå‘˜æœ‰å¯èƒ½ä¼šé‡åˆ°ä¸€äº›å…¶ä»–å…¬å¸é‡ä¸åˆ°çš„é—®é¢˜ã€‚æ‰€ä»¥ï¼Œå¦‚æœä¸€å®¶æ–°æˆç«‹çš„å°å…¬å¸è¯´è‡ªå·±æ˜¯æŠ€æœ¯é©±åŠ¨çš„â€¦â€¦è¿1.0ç‰ˆæœ¬çš„äº§å“éƒ½æ²¡æœ‰å°±æ•¢è¯´è‡ªå·±æ˜¯æŠ€æœ¯é©±åŠ¨ï¼Ÿä½ ä¿¡å—ï¼Ÿä¸ç®¡ä½ ä¿¡ä¸ä¿¡ï¼Œåæ­£æˆ‘ä¸ä¿¡ã€‚ç®€è€Œè¨€ä¹‹ï¼Œâ€œæŠ€æœ¯é©±åŠ¨â€çš„åŒä¹‰è¯å°±æ˜¯â€œæˆ‘ä»¬å…¬å¸å¾ˆæœ‰é’±â€+â€œæˆ‘ä»¬å…¬å¸ä¸æ˜¯ç‚’è‚¡ç‚’æˆ¿è€Œæ˜¯åšäº§å“çš„å…¬å¸â€ã€‚è‡³äºä¸ºä»€ä¹ˆä¸ç›´æ¥è¿™ä¹ˆè¯´å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºè¿™ç§è¯´æ³•ä¸å®¹æ˜“è¢«åå¹´å¯’çª—è‹¦è¯»æ½œå¿ƒç ”ç©¶æŠ€æœ¯çš„åŒå­¦æ¥å—â€¦â€¦è¢«â€œæŠ€æœ¯é©±åŠ¨â€è¿·æƒ‘çš„åŒå­¦ï¼Œå…¶å®å°±æ˜¯è¯»ä¹¦è¯»å‚»äº†ï¼Œä»€ä¹ˆå«â€œè¯»ä¹¦è¯»å‚»äº†â€ï¼Ÿå°±æ˜¯æŠŠç¤¾ä¼šå’Œå­¦æ ¡ç­‰åŒæˆåŒæ ·çš„ä¸œè¥¿â€¦â€¦â€œå¾ˆæœ‰é’±çš„åšITäº§å“çš„å…¬å¸â€ï¼Œè¿™ä¸ªä¸–ç•Œä¸Šå½“ç„¶æ˜¯æœ‰çš„ï¼Œä½†æ˜¯è¿™æ ·çš„å…¬å¸ï¼Œæ ¹æœ¬ä¸ä¼šç”¨â€œæŠ€æœ¯é©±åŠ¨â€è¿™ç§è¯æ¥å¿½æ‚ æ–°äººã€‚æœ€åï¼Œéš”è¡Œå¦‚éš”å±±ä½†éš”è¡Œä¸éš”ç†ã€‚å¦‚æœä½ è¯»å®Œä¸Šé¢çš„ä¸œè¥¿ï¼Œå¯¹è‡ªå·±æ‰€å¤„çš„è¡Œä¸šæœ‰äº†è¿›ä¸€æ­¥çš„è®¤è¯†ï¼Œæˆ‘ä»¥ä¸ºï¼Œæ˜¯å¾ˆæ­£å¸¸çš„ã€‚</p><h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4><p><a href="https://www.zhihu.com/question/312019918/answer/608965942" target="_blank" rel="noopener">ä½œä¸º IT è¡Œä¸šçš„è¿‡æ¥äººï¼Œä½ æœ‰ä»€ä¹ˆè¯æƒ³å¯¹åè¾ˆè¯´çš„ï¼Ÿ</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¶å°”çœ‹åˆ°&lt;code&gt;äºŒå¾‹èƒŒå&lt;/code&gt;åœ¨çŸ¥ä¹ä¸Šå›ç­”é—®é¢˜&lt;a href=&quot;https://www.zhihu.com/question/312019918/answer/608965942&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;ä½œä¸º IT è¡Œä¸šçš„è¿‡æ¥äººï¼Œä½ æœ‰ä»€ä¹ˆè¯æƒ³å¯¹åè¾ˆè¯´çš„ï¼Ÿ&lt;/code&gt;&lt;/a&gt;ï¼Œæ„Ÿè§‰ç‰¹åˆ«é€‚åˆè‡ªå·±ç°åœ¨çš„å¤„å¢ƒï¼Œæ‰€ä»¥æ‘˜æŠ„å‡ºæ¥ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1ï¼Œä¸–ç•Œä¸Šæ²¡æœ‰æŠ€æœ¯é©±åŠ¨å‹å…¬å¸ï¼Œå› ä¸ºåœ¨å…¬å¸ï¼Œä¸€åˆ‡éƒ½æ˜¯éœ€æ±‚ä¼˜å…ˆçš„ã€‚&lt;br&gt;2ï¼Œä½ åšçš„å¥½ä¸å¥½ä¸å–å†³äºä½ å¤šèªæ˜ï¼Œè€Œå–å†³äºä½ æ˜¯å¦æ„¿æ„ä¸æ–­è¯»ä¹¦ï¼Œä¸æ–­å­¦ä¹ ï¼Œä¸æ–­ç§¯ç´¯ï¼Œä¸æ–­æ€è€ƒã€‚&lt;br&gt;3ï¼Œå…¬å¸æ˜¯åˆ›é€ è´¢å¯Œçš„åœ°æ–¹ï¼Œä¸æ˜¯å­¦æ ¡ï¼Œä½ å¯ä»¥åœ¨å·¥ä½œä¸­å­¦ä¹ ï¼Œä½†æ˜¯ä¸å¯ä»¥æ”¾ä¸‹å·¥ä½œç„¶åå­¦ä¹ ï¼Œé™¤éä½ çš„å·¥ä½œå·²ç»åšå®Œäº†ã€‚&lt;br&gt;4ï¼Œä¸€å®šè¦æƒ³å¥½åœ¨åŠ¨æ‰‹ï¼Œæƒ³å¥½çš„æ ‡å¿—å°±æ˜¯æ–‡æ¡£å†™å¥½ã€‚&lt;br&gt;5ï¼Œèµ„æœ¬çš„è¿è½¬æ˜¯ä¸èƒ½åœçš„ï¼Œå› ä¸ºä¸€åœä¸‹æ¥æŸå¤±çš„é’±å¤ªå¤šã€‚æ‰€ä»¥èµ„æœ¬å¯Œé›†çš„åœ°æ–¹åŠ ç­æ˜¯å¸¸äº‹ã€‚&lt;br&gt;6ï¼Œç°ä»£ç®¡ç†å­¦çš„ç²¾é«“å°±æ˜¯è®©æ¯ä¸ªäººå˜å¾—å¯æ›¿ä»£ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="æ–¹æ³•è®º" scheme="http://yoursite.com/tags/%E6%96%B9%E6%B3%95%E8%AE%BA/"/>
    
      <category term="è®¤çŸ¥" scheme="http://yoursite.com/tags/%E8%AE%A4%E7%9F%A5/"/>
    
  </entry>
  
  <entry>
    <title>Profiling-and-Optimizing</title>
    <link href="http://yoursite.com/2020/02/01/Profiling-and-Optimizing/"/>
    <id>http://yoursite.com/2020/02/01/Profiling-and-Optimizing/</id>
    <published>2020-02-01T11:48:12.000Z</published>
    <updated>2020-09-23T17:55:12.030Z</updated>
    
    <content type="html"><![CDATA[<p>å¤§å­¦æ—¶çœ‹åˆ°ä¸‹é¢çš„è¯´æ³•ï¼Œæ·±ä»¥ä¸ºç„¶ï¼Œå› æ­¤ä¸€ç›´å†™ä»£ç å¾ˆå°‘ä¼˜åŒ–ã€‚é‚£ä¸ªæ—¶å€™è€ƒè™‘æ›´å¤šçš„æ˜¯å¦‚ä½•è·‘èµ·æ¥å’Œè·‘æ­£ç¡®çš„é—®é¢˜ï¼Œå¾ˆå°‘æ¶‰åŠè·‘çš„æ›´å¿«æ›´å¥½çš„é—®é¢˜ã€‚</p><blockquote><p>è¿‡æ—©çš„ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æº â€“ã€Šè®¡ç®—æœºç¨‹åºè®¾è®¡è‰ºæœ¯ã€‹</p></blockquote><p>å¦‚ä»Šå› ä¸ºå·¥ä½œå…³ç³»ï¼Œæˆ‘ä¸å¾—ä¸è€ƒè™‘å¦‚ä½•è·‘çš„æ›´å¿«ï¼Œè·‘çš„æ›´å¥½äº†ã€‚</p><a id="more"></a><h3 id="å¦‚ä½•è·‘çš„æ›´å¿«å‘¢ï¼Ÿ"><a href="#å¦‚ä½•è·‘çš„æ›´å¿«å‘¢ï¼Ÿ" class="headerlink" title="å¦‚ä½•è·‘çš„æ›´å¿«å‘¢ï¼Ÿ"></a>å¦‚ä½•è·‘çš„æ›´å¿«å‘¢ï¼Ÿ</h3><p>å½“ç¨‹åºè¿è¡Œæ­£ç¡®åï¼Œéœ€è¦è€ƒè™‘å¦‚ä½•è·‘çš„æ›´å¿«ï¼Œå ç”¨èµ„æºæ›´å°‘ã€‚å…¶æœ€ç»ˆçš„ç›®çš„æ˜¯ç”¨æœ€å°‘çš„ç¡¬ä»¶èµ„æºä¸ºæ›´å¤šçš„ç”¨æˆ·æä¾›æœåŠ¡ã€‚è¿™é‡Œå¤§è‡´åˆ†ä¸ºä¸¤ç§é€”å¾„ï¼š<br>1ï¼Œ ä¸šåŠ¡è°ƒæ•´ä¼˜åŒ–<br>2ï¼Œ ä»£ç è°ƒæ•´ä¼˜åŒ–<br>ä¸šåŠ¡è°ƒæ•´ä¼˜åŒ–ä¸€èˆ¬éœ€è¦è°ƒæ•´ä¸šåŠ¡ï¼Œé€šè¿‡èˆå¼ƒä¸€äº›ä¸å¤ªé‡è¦çš„åŠŸèƒ½æ¥å¤§å¹…æå‡å½“å‰ä¸»åŠŸèƒ½çš„é€Ÿåº¦ï¼Œéœ€è¦è·¨teamåˆä½œã€‚æ¯”å¦‚å½“å‰é¡µé¢å¯èƒ½ä¸å¤ªéœ€è¦çš„ä¸€äº›æ•°æ®ï¼ˆè·å–æ¯”è¾ƒè€—æ—¶ï¼‰å¯ä»¥èˆå¼ƒã€‚æ¥å£æˆ–è€…é¡µé¢å¤„ç†çš„æ•°æ®å°‘äº†ï¼Œé€Ÿåº¦å°±ä¼šç›¸åº”çš„æå‡ã€‚<br>ä»£ç è°ƒæ•´ä¼˜åŒ–åˆ™æ˜¯å¼€å‘è€…åœ¨ä¸å½±å“å½“å‰ä¸šåŠ¡åŠŸèƒ½çš„å‰æä¸‹ï¼Œå†…éƒ¨è°ƒæ•´ä¼˜åŒ–ä»£ç é€»è¾‘ã€‚æ•´ä¸ªè¿‡ç¨‹å¯¹ç»ˆç«¯ç”¨æˆ·æ˜¯é€æ˜çš„ã€‚  </p><p>æœ¬æ–‡æˆ‘ä¸»è¦è¯´æ˜ä»£ç ä¼˜åŒ–ï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬å¼€å‘è€…åœ¨ä¸ä¾èµ–å…¶å®ƒå¤–éƒ¨èµ„æºæƒ…å†µä¸‹å°±å¯ä»¥è¿›è¡Œçš„ã€‚</p><h3 id="Profiling"><a href="#Profiling" class="headerlink" title="Profiling"></a>Profiling</h3><p>æˆ‘è¦ä¼˜åŒ–ä»£ç ï¼Œé‚£è¯¥ä»å“ªé‡Œä¼˜åŒ–å‘¢ï¼Ÿé¦–å…ˆå½“ç„¶æ˜¯å®šä½ï¼Œå®šä½éœ€è¦ä¼˜åŒ–çš„åœ°æ–¹ã€‚ç¬¬ä¸€ç§æ–¹æ³•æ˜¯å¤§è‡´è¯„ä¼°ä»£ç ä¸­å“ªä¸€ä¸ªæ¨¡å—æˆ–è€…å‡½æ•°æ¯”è¾ƒè€—æ—¶ï¼Œç„¶åé‡ç‚¹åˆ†æã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯å€ŸåŠ©å·¥å…·é‡åŒ–è¯„ä¼°ä»£ç è€—è´¹èµ„æºæƒ…å†µï¼ˆCPUï¼ŒMemï¼‰ï¼Œæ ¹æ®è¯„ä¼°åˆ—è¡¨ç»“æœä¼˜åŒ–ã€‚ç¬¬ä¸€ç§æ–¹æ³•æ¯”è¾ƒä¸»è§‚ï¼Œå› ä¸ºä¸åŒçš„å¼€å‘è€…å¾€å¾€è¯„ä¼°çš„æœ‰å·®è·ï¼Œæˆ–è€…å¤§å‹é¡¹ç›®å¼€å‘è€…å¯¹å…¶å®ƒæ¨¡å—ä¸å¤ªç†Ÿæ‚‰ï¼Œæ— æ³•æ­£ç¡®è¯„ä¼°ã€‚è€Œç¬¬äºŒç§æ–¹æ³•æ¯”è¾ƒå®¢è§‚ï¼Œé€šè¿‡ç›‘æ§ç»Ÿè®¡ä»£ç è€—è´¹èµ„æºçš„æƒ…å†µé‡åŒ–å…¶æ€§èƒ½ï¼Œå¼€å‘è€…å¯ä»¥å¾ˆå®¹æ˜“ä»ç»Ÿè®¡çš„ç»“æœä¸­å¾—å‡ºä»£ç å“ªä¸€å—æ¯”è¾ƒè€—è´¹èµ„æºã€‚ç¬¬äºŒç§æ–¹æ³•å°±æ˜¯Profilingã€‚</p><p>Profiling ä¸€èˆ¬ä½¿ç”¨ä¸‹é¢çš„å·¥å…·ï¼š<br>1ï¼Œ Pythonè£…é¥°å™¨ï¼Œç”¨æ¥æµ‹é‡å‡½æ•°è€—æ—¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timefn</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">measure_time</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        t1 = time.time()</span><br><span class="line">        result = fn(*args, **kwargs)</span><br><span class="line">        t2 = time.time()</span><br><span class="line">        <span class="keyword">print</span> (<span class="string">"@timefn:"</span> + fn.func_name + <span class="string">" took "</span> + str(t2 - t1) + <span class="string">" senconds"</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> measure_time</span><br><span class="line"></span><br><span class="line"><span class="meta">@timefn</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func_to_measure</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>2ï¼Œ Python Module <code>timeit</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python -m timeit -n <span class="number">5</span> -r <span class="number">5</span> ...</span><br><span class="line"></span><br><span class="line"><span class="number">5</span> loops, best of <span class="number">5</span>: <span class="number">13.1</span> sec per loop</span><br></pre></td></tr></table></figure><p>3ï¼Œ Unix Time Command</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/time -p python scripts.py</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">real 13.46</span><br><span class="line">user 13.40</span><br><span class="line">sys 0.04</span><br></pre></td></tr></table></figure><p>4, cProfile module<br>å¯ä»¥æŸ¥çœ‹å½“å‰ç¨‹åºä¸­ç”¨æˆ·å®šä¹‰å‡½æ•°æˆ–è€…Pythonå†…éƒ¨å‡½æ•°çš„è°ƒç”¨åŠè€—æ—¶æƒ…å†µã€‚ä¸€èˆ¬ç”¨æ¥å®šä½å‡½æ•°å±‚çº§ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">python -m cProfile -s cumulative problem1.py </span><br><span class="line"></span><br><span class="line">         66716 <span class="keyword">function</span> calls <span class="keyword">in</span> 9.435 seconds</span><br><span class="line"></span><br><span class="line">   Ordered by: standard name</span><br><span class="line"></span><br><span class="line">   ncalls  tottime  percall  cumtime  percall filename:lineno(<span class="keyword">function</span>)</span><br><span class="line">        3    0.000    0.000    0.000    0.000 functools.py:17(update_wrapper)</span><br><span class="line">        3    0.000    0.000    0.000    0.000 functools.py:39(wraps)</span><br><span class="line">        1    0.000    0.000    9.435    9.435 problem1.py:1(&lt;module&gt;)</span><br><span class="line">        1    9.407    9.407    9.408    9.408 problem1.py:20(merge_two_list)</span><br><span class="line">        1    0.019    0.019    0.025    0.025 problem1.py:4(get_muliply_res)</span><br><span class="line">        1    0.001    0.001    0.001    0.001 timing_decorators.py:1(&lt;module&gt;)</span><br><span class="line">        3    0.000    0.000    0.000    0.000 timing_decorators.py:5(timefn)</span><br><span class="line">        2    0.000    0.000    9.433    4.717 timing_decorators.py:6(measure_time)</span><br><span class="line">       15    0.000    0.000    0.000    0.000 &#123;getattr&#125;</span><br><span class="line">    66665    0.005    0.000    0.005    0.000 &#123;method <span class="string">'append'</span> of <span class="string">'list'</span> objects&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;method <span class="string">'disable'</span> of <span class="string">'_lsprof.Profiler'</span> objects&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;method <span class="string">'format'</span> of <span class="string">'str'</span> objects&#125;</span><br><span class="line">        3    0.000    0.000    0.000    0.000 &#123;method <span class="string">'update'</span> of <span class="string">'dict'</span> objects&#125;</span><br><span class="line">        2    0.003    0.002    0.003    0.002 &#123;range&#125;</span><br><span class="line">        9    0.000    0.000    0.000    0.000 &#123;setattr&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;sum&#125;</span><br><span class="line">        4    0.000    0.000    0.000    0.000 &#123;time.time&#125;</span><br></pre></td></tr></table></figure><p>5, line_profiler module<br>ä¸Šè¿°cProfileå®šä½åˆ°å‡½æ•°çº§åˆ«åï¼Œå¯ä»¥ä½¿ç”¨line_profilerå®šä½åˆ°å‡½æ•°ä¸­å…·ä½“æŸä¸€è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kernprof -l -v problem1.py </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Total time: 9.80845 s</span><br><span class="line">File: problem1.py</span><br><span class="line">Function: merge_two_list at line 20</span><br><span class="line"></span><br><span class="line">Line <span class="comment">#      Hits         Time  Per Hit   % Time  Line Contents</span></span><br><span class="line">==============================================================</span><br><span class="line">    20                                           @timefn</span><br><span class="line">    21                                           @profile</span><br><span class="line">    22                                           def merge_two_list(small_lst, big_lst):</span><br><span class="line">    23                                               <span class="string">""</span><span class="string">" merge two list into one, remove duplicate elements "</span><span class="string">""</span></span><br><span class="line">    24         1        158.0    158.0      0.0      res = big_lst</span><br><span class="line">    25     20000       7026.0      0.4      0.1      <span class="keyword">for</span> ele <span class="keyword">in</span> small_lst:</span><br><span class="line">    26     19999    9792981.0    489.7     99.8          <span class="keyword">if</span> ele not <span class="keyword">in</span> res:</span><br><span class="line">    27     13333       8285.0      0.6      0.1              res.append(ele)</span><br><span class="line">    28</span><br><span class="line">    29         1          0.0      0.0      0.0      <span class="built_in">return</span> res</span><br></pre></td></tr></table></figure><p>6, memory_profiler<br>å‰é¢çš„å·¥å…·éƒ½æ˜¯æµ‹é‡ç¨‹åºè¿è¡Œè€—æ—¶çš„ï¼Œè¿™ä¸ªå·¥å…·ç”¨æ¥æµ‹é‡å†…å­˜å ç”¨æƒ…å†µã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">python -m memory_profiler problem1.py</span><br><span class="line"></span><br><span class="line">Filename: problem1.py</span><br><span class="line"></span><br><span class="line">Line <span class="comment">#    Mem usage    Increment   Line Contents</span></span><br><span class="line">================================================</span><br><span class="line">    20   30.691 MiB   30.691 MiB   @timefn</span><br><span class="line">    21                             @profile</span><br><span class="line">    22                             def merge_two_list(small_lst, big_lst):</span><br><span class="line">    23                                 <span class="string">""</span><span class="string">" merge two list into one, remove duplicate elements "</span><span class="string">""</span></span><br><span class="line">    24   30.695 MiB    0.004 MiB       res = big_lst</span><br><span class="line">    25   30.977 MiB    0.000 MiB       <span class="keyword">for</span> ele <span class="keyword">in</span> small_lst:</span><br><span class="line">    26   30.977 MiB    0.168 MiB           <span class="keyword">if</span> ele not <span class="keyword">in</span> res:</span><br><span class="line">    27   30.977 MiB    0.004 MiB               res.append(ele)</span><br><span class="line">    28</span><br><span class="line">    29   30.977 MiB    0.000 MiB       <span class="built_in">return</span> res</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰å…¶å®ƒå·¥å…·è¿™é‡Œå°†ä¸èµ˜è¿°ã€‚</p><h3 id="å®éªŒ"><a href="#å®éªŒ" class="headerlink" title="å®éªŒ"></a>å®éªŒ</h3><p>ä»1wä¸ªç”µå½±titleä¸­æ‰¾å‡ºé‡å¤çš„titleå¹¶æ‰“å°å‡ºæ¥ï¼Œæ•°æ®å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Carmencita</span><br><span class="line">Le clown et ses chiens</span><br><span class="line">Pauvre Pierrot</span><br><span class="line">Un bon bock</span><br><span class="line">Blacksmith Scene</span><br><span class="line">Chinese Opium Den</span><br><span class="line">Corbett and Courtney Before the Kinetograph</span><br><span class="line">Edison Kinetoscopic Record of a Sneeze</span><br><span class="line">Miss Jerry</span><br><span class="line">Exiting the Factory</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><a href="/img/titles_1w.txt">titles_1w.txt</a></p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_movies</span><span class="params">(src)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(src) <span class="keyword">as</span> fd:</span><br><span class="line">        <span class="keyword">return</span> fd.read().splitlines()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_duplicate</span><span class="params">(needle, haystack)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> movie <span class="keyword">in</span> haystack:</span><br><span class="line">        <span class="keyword">if</span> needle.lower() == movie.lower():</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_duplicate_movies</span><span class="params">(src=<span class="string">"titles_1w.txt"</span>)</span>:</span></span><br><span class="line">    movies = read_movies(src)</span><br><span class="line">    duplicates = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> movies:</span><br><span class="line">        movie = movies.pop()</span><br><span class="line">        <span class="keyword">if</span> movie <span class="keyword">in</span> movies:</span><br><span class="line">            duplicates.append(movie)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> duplicates</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    res = find_duplicate_movies()</span><br><span class="line">    <span class="keyword">print</span> res</span><br></pre></td></tr></table></figure><p>è¿è¡Œä¸Šé¢çš„è„šæœ¬å‘ç°è€—æ—¶35ç§’</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">python -m cProfile find_duplicate_movies.py</span><br><span class="line"></span><br><span class="line">         97560705 <span class="keyword">function</span> calls <span class="keyword">in</span> 35.499 seconds</span><br><span class="line"></span><br><span class="line">   Ordered by: standard name</span><br><span class="line"></span><br><span class="line">   ncalls  tottime  percall  cumtime  percall filename:lineno(<span class="keyword">function</span>)</span><br><span class="line">        1    0.000    0.000   35.499   35.499 find_duplicate_movies.py:1(&lt;module&gt;)</span><br><span class="line">        1    0.000    0.000    0.001    0.001 find_duplicate_movies.py:1(read_movies)</span><br><span class="line">        1    0.013    0.013   35.499   35.499 find_duplicate_movies.py:13(find_duplicate_movies)</span><br><span class="line">    10001   12.619    0.001   35.482    0.004 find_duplicate_movies.py:6(is_duplicate)</span><br><span class="line">      376    0.000    0.000    0.000    0.000 &#123;method <span class="string">'append'</span> of <span class="string">'list'</span> objects&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;method <span class="string">'disable'</span> of <span class="string">'_lsprof.Profiler'</span> objects&#125;</span><br><span class="line"> 97540320   22.863    0.000   22.863    0.000 &#123;method <span class="string">'lower'</span> of <span class="string">'str'</span> objects&#125;</span><br><span class="line">    10001    0.004    0.000    0.004    0.000 &#123;method <span class="string">'pop'</span> of <span class="string">'list'</span> objects&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;method <span class="string">'read'</span> of <span class="string">'file'</span> objects&#125;</span><br><span class="line">        1    0.001    0.001    0.001    0.001 &#123;method <span class="string">'splitlines'</span> of <span class="string">'str'</span> objects&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;open&#125;</span><br></pre></td></tr></table></figure><p>åˆ†æcProfileçš„ç»“æœï¼Œå¯ä»¥çœ‹å‡ºè€—æ—¶å‘ç”Ÿåœ¨ä¸¤ä¸ªå‡½æ•°è°ƒç”¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ncalls  tottime  percall  cumtime  percall filename:lineno(<span class="keyword">function</span>)</span><br><span class="line">10001   12.619    0.001   35.482    0.004 find_duplicate_movies.py:6(is_duplicate)</span><br><span class="line">97540320   22.863    0.000   22.863    0.000 &#123;method <span class="string">'lower'</span> of <span class="string">'str'</span> objects&#125;</span><br></pre></td></tr></table></figure><h4 id="ç¬¬ä¸€æ¬¡ä¼˜åŒ–"><a href="#ç¬¬ä¸€æ¬¡ä¼˜åŒ–" class="headerlink" title="ç¬¬ä¸€æ¬¡ä¼˜åŒ–"></a>ç¬¬ä¸€æ¬¡ä¼˜åŒ–</h4><p>å¯¹åº”ä»£ç ä¸­çš„å‡½æ•°ï¼š<code>is_duplicate</code> å’Œ build-in: <code>lower</code>ï¼Œå¯ä»¥çœ‹å‡ºstringçš„<code>lower</code>å‡½æ•°æ¯”è¾ƒè€—è´¹æ—¶é—´ï¼ŒèŠ±è´¹äº†<strong>22.863</strong>ç§’ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¯»å…¥movie titleåç›´æ¥è½¬åŒ–æˆlower caseï¼Œè¿›è€Œé˜²æ­¢åœ¨<code>is_duplicate</code>ä¸­2æ¬¡è°ƒç”¨<code>lower</code>ã€‚æ”¹è¿›åçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_movies</span><span class="params">(src)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(src) <span class="keyword">as</span> fd:</span><br><span class="line">        <span class="keyword">return</span> fd.read().splitlines()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_duplicate</span><span class="params">(needle, haystack)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> movie <span class="keyword">in</span> haystack:</span><br><span class="line">        <span class="keyword">if</span> needle == movie:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_duplicate_movies</span><span class="params">(src=<span class="string">"titles_1w.txt"</span>)</span>:</span></span><br><span class="line">    movies = read_movies(src)</span><br><span class="line">    movies = [movie.lower() <span class="keyword">for</span> movie <span class="keyword">in</span> movies]</span><br><span class="line">    duplicates = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> movies:</span><br><span class="line">        movie = movies.pop()</span><br><span class="line">        <span class="keyword">if</span> is_duplicate(movie, movies):</span><br><span class="line">            duplicates.append(movie)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> duplicates</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    res = find_duplicate_movies()</span><br><span class="line">    <span class="keyword">print</span> res[<span class="number">0</span>:<span class="number">5</span>]</span><br></pre></td></tr></table></figure><p>è¿è¡Œæ”¹è¿›åçš„ç¨‹åºï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">python -m cProfile find_duplicate_movies.py</span><br><span class="line"></span><br><span class="line">         30386 <span class="keyword">function</span> calls <span class="keyword">in</span> 1.175 seconds</span><br><span class="line"></span><br><span class="line">   Ordered by: standard name</span><br><span class="line"></span><br><span class="line">   ncalls  tottime  percall  cumtime  percall filename:lineno(<span class="keyword">function</span>)</span><br><span class="line">        1    0.000    0.000    1.175    1.175 find_duplicate_movies.py:1(&lt;module&gt;)</span><br><span class="line">        1    0.000    0.000    0.001    0.001 find_duplicate_movies.py:1(read_movies)</span><br><span class="line">        1    0.006    0.006    1.175    1.175 find_duplicate_movies.py:13(find_duplicate_movies)</span><br><span class="line">    10001    1.163    0.000    1.163    0.000 find_duplicate_movies.py:6(is_duplicate)</span><br><span class="line">      376    0.000    0.000    0.000    0.000 &#123;method <span class="string">'append'</span> of <span class="string">'list'</span> objects&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;method <span class="string">'disable'</span> of <span class="string">'_lsprof.Profiler'</span> objects&#125;</span><br><span class="line">    10001    0.003    0.000    0.003    0.000 &#123;method <span class="string">'lower'</span> of <span class="string">'str'</span> objects&#125;</span><br><span class="line">    10001    0.001    0.000    0.001    0.000 &#123;method <span class="string">'pop'</span> of <span class="string">'list'</span> objects&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;method <span class="string">'read'</span> of <span class="string">'file'</span> objects&#125;</span><br><span class="line">        1    0.001    0.001    0.001    0.001 &#123;method <span class="string">'splitlines'</span> of <span class="string">'str'</span> objects&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;open&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œæ€»è€—æ—¶ä¸‹é™åˆ°<strong>1.175</strong>ç§’ã€‚</p><h4 id="ç¬¬äºŒæ¬¡ä¼˜åŒ–"><a href="#ç¬¬äºŒæ¬¡ä¼˜åŒ–" class="headerlink" title="ç¬¬äºŒæ¬¡ä¼˜åŒ–"></a>ç¬¬äºŒæ¬¡ä¼˜åŒ–</h4><p>ä»ä¸Šé¢profilingç»“æœå¯ä»¥çœ‹å‡ºä¸»è¦è€—æ—¶å‡½æ•°ä¸ºï¼š<code>is_duplicate</code>ã€‚è¿™é‡Œå»æ‰is_duplicate å‡½æ•°è°ƒç”¨ï¼Œç›´æ¥åœ¨<code>find_duplicate_movies</code>ä¸­åˆ¤æ–­å½“å‰movieæ˜¯å¦åœ¨å‰©ä½™moviesä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_movies</span><span class="params">(src)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(src) <span class="keyword">as</span> fd:</span><br><span class="line">        <span class="keyword">return</span> fd.read().splitlines()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_duplicate_movies</span><span class="params">(src=<span class="string">"titles_1w.txt"</span>)</span>:</span></span><br><span class="line">    movies = read_movies(src)</span><br><span class="line">    movies = [movie.lower() <span class="keyword">for</span> movie <span class="keyword">in</span> movies]</span><br><span class="line">    duplicates = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> movies:</span><br><span class="line">        movie = movies.pop()</span><br><span class="line">        <span class="keyword">if</span> movie <span class="keyword">in</span> movies:</span><br><span class="line">            duplicates.append(movie)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> duplicates</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    res = find_duplicate_movies()</span><br><span class="line">    <span class="keyword">print</span> res[<span class="number">0</span>:<span class="number">5</span>]</span><br></pre></td></tr></table></figure><p>è¿è¡Œæ”¹è¿›åçš„ç¨‹åºï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">python -m cProfile find_duplicate_movies.py</span><br><span class="line"></span><br><span class="line">         20385 <span class="keyword">function</span> calls <span class="keyword">in</span> 0.463 seconds</span><br><span class="line"></span><br><span class="line">   Ordered by: standard name</span><br><span class="line"></span><br><span class="line">   ncalls  tottime  percall  cumtime  percall filename:lineno(<span class="keyword">function</span>)</span><br><span class="line">        1    0.000    0.000    0.463    0.463 find_duplicate_movies.py:1(&lt;module&gt;)</span><br><span class="line">        1    0.000    0.000    0.001    0.001 find_duplicate_movies.py:1(read_movies)</span><br><span class="line">        1    0.457    0.457    0.463    0.463 find_duplicate_movies.py:13(find_duplicate_movies)</span><br><span class="line">      376    0.000    0.000    0.000    0.000 &#123;method <span class="string">'append'</span> of <span class="string">'list'</span> objects&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;method <span class="string">'disable'</span> of <span class="string">'_lsprof.Profiler'</span> objects&#125;</span><br><span class="line">    10001    0.003    0.000    0.003    0.000 &#123;method <span class="string">'lower'</span> of <span class="string">'str'</span> objects&#125;</span><br><span class="line">    10001    0.001    0.000    0.001    0.000 &#123;method <span class="string">'pop'</span> of <span class="string">'list'</span> objects&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;method <span class="string">'read'</span> of <span class="string">'file'</span> objects&#125;</span><br><span class="line">        1    0.001    0.001    0.001    0.001 &#123;method <span class="string">'splitlines'</span> of <span class="string">'str'</span> objects&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;open&#125;</span><br></pre></td></tr></table></figure><p>æ€»è€—æ—¶ä¸‹é™åˆ°<strong>0.463</strong>ç§’ã€‚</p><h4 id="ç¬¬ä¸‰æ¬¡ä¼˜åŒ–"><a href="#ç¬¬ä¸‰æ¬¡ä¼˜åŒ–" class="headerlink" title="ç¬¬ä¸‰æ¬¡ä¼˜åŒ–"></a>ç¬¬ä¸‰æ¬¡ä¼˜åŒ–</h4><p>ä¸Šè¿°åˆ¤æ–­æ˜¯å¦é‡å¤æ˜¯é€šè¿‡popå‡ºä¸€ä¸ªtitleåï¼Œç„¶åæ£€æŸ¥titleæ˜¯å¦åœ¨å‰©ä½™çš„listä¸­ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ›´é«˜æ•ˆçš„æ–¹æ³•ï¼Œå…ˆå°†listæ’åºï¼Œé‚£ä¹ˆç›¸åŒçš„titleå°†ä¼šåœ¨listä¸­ç´§æŒ¨ç€ï¼Œè¿™ä¸ªæ—¶å€™åªè¦å¾ªç¯æ’åºåçš„æ•°ç»„ï¼Œæ¯”è¾ƒidxå’Œidx+1çš„å…ƒç´ å³å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_movies</span><span class="params">(src)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(src) <span class="keyword">as</span> fd:</span><br><span class="line">        <span class="keyword">return</span> fd.read().splitlines()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_duplicate_movies</span><span class="params">(src=<span class="string">"titles_1w.txt"</span>)</span>:</span></span><br><span class="line">    movies = read_movies(src)</span><br><span class="line">    movies = [movie.lower() <span class="keyword">for</span> movie <span class="keyword">in</span> movies]</span><br><span class="line">    movies.sort()</span><br><span class="line">    duplicates = []</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> range(len(movies) - <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> movies[idx] == movies[idx + <span class="number">1</span>]:</span><br><span class="line">            duplicates.append(movies[idx])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> duplicates</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    res = find_duplicate_movies()</span><br><span class="line">    <span class="keyword">print</span> res[<span class="number">0</span>:<span class="number">5</span>]</span><br></pre></td></tr></table></figure><p>è¿è¡Œæ”¹è¿›åçš„ç¨‹åºï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">python -m cProfile find_duplicate_movies.py</span><br><span class="line"></span><br><span class="line">         10387 <span class="keyword">function</span> calls <span class="keyword">in</span> 0.010 seconds</span><br><span class="line"></span><br><span class="line">   Ordered by: standard name</span><br><span class="line"></span><br><span class="line">   ncalls  tottime  percall  cumtime  percall filename:lineno(<span class="keyword">function</span>)</span><br><span class="line">        1    0.000    0.000    0.010    0.010 find_duplicate_movies.py:1(&lt;module&gt;)</span><br><span class="line">        1    0.000    0.000    0.001    0.001 find_duplicate_movies.py:1(read_movies)</span><br><span class="line">        1    0.002    0.002    0.010    0.010 find_duplicate_movies.py:13(find_duplicate_movies)</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;len&#125;</span><br><span class="line">      376    0.000    0.000    0.000    0.000 &#123;method <span class="string">'append'</span> of <span class="string">'list'</span> objects&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;method <span class="string">'disable'</span> of <span class="string">'_lsprof.Profiler'</span> objects&#125;</span><br><span class="line">    10001    0.003    0.000    0.003    0.000 &#123;method <span class="string">'lower'</span> of <span class="string">'str'</span> objects&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;method <span class="string">'read'</span> of <span class="string">'file'</span> objects&#125;</span><br><span class="line">        1    0.003    0.003    0.003    0.003 &#123;method <span class="string">'sort'</span> of <span class="string">'list'</span> objects&#125;</span><br><span class="line">        1    0.001    0.001    0.001    0.001 &#123;method <span class="string">'splitlines'</span> of <span class="string">'str'</span> objects&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;open&#125;</span><br><span class="line">        1    0.000    0.000    0.000    0.000 &#123;range&#125;</span><br></pre></td></tr></table></figure><p>æ€»è€—æ—¶ä¸‹é™åˆ°<strong>0.010</strong>ç§’ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¤§å­¦æ—¶çœ‹åˆ°ä¸‹é¢çš„è¯´æ³•ï¼Œæ·±ä»¥ä¸ºç„¶ï¼Œå› æ­¤ä¸€ç›´å†™ä»£ç å¾ˆå°‘ä¼˜åŒ–ã€‚é‚£ä¸ªæ—¶å€™è€ƒè™‘æ›´å¤šçš„æ˜¯å¦‚ä½•è·‘èµ·æ¥å’Œè·‘æ­£ç¡®çš„é—®é¢˜ï¼Œå¾ˆå°‘æ¶‰åŠè·‘çš„æ›´å¿«æ›´å¥½çš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;è¿‡æ—©çš„ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æº â€“ã€Šè®¡ç®—æœºç¨‹åºè®¾è®¡è‰ºæœ¯ã€‹&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¦‚ä»Šå› ä¸ºå·¥ä½œå…³ç³»ï¼Œæˆ‘ä¸å¾—ä¸è€ƒè™‘å¦‚ä½•è·‘çš„æ›´å¿«ï¼Œè·‘çš„æ›´å¥½äº†ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
      <category term="Optimization" scheme="http://yoursite.com/tags/Optimization/"/>
    
      <category term="Profiling" scheme="http://yoursite.com/tags/Profiling/"/>
    
  </entry>
  
  <entry>
    <title>Cache For Software Engineer</title>
    <link href="http://yoursite.com/2020/01/17/Cache-For-Software-Engineer/"/>
    <id>http://yoursite.com/2020/01/17/Cache-For-Software-Engineer/</id>
    <published>2020-01-17T07:00:00.000Z</published>
    <updated>2020-09-23T17:55:12.026Z</updated>
    
    <content type="html"><![CDATA[<p>In this post i am gonna talk about cache, specifically on application level, will not cover the internals of cache such as Redis/Memcache implementation etc. will cover following topics:  </p><ul><li>What is cache</li><li>Usage senarios</li><li>Cache Types</li><li>Cache Patterns</li><li>3 major problems and solutions in cache world<a id="more"></a></li></ul><h3 id="What-is-cache"><a href="#What-is-cache" class="headerlink" title="What is cache"></a>What is cache</h3><blockquote><p>cache is data redundancy, to achieve higher data access speed.</p></blockquote><p>normally we use memory in current process or use Redis/Memcache to store data instead of directly access DB or other data source to retrieve data. as we all know that memory is much faster than disk or network IO. so use memory as a cache storage is a reasonable choice.</p><h3 id="Usage-senarios"><a href="#Usage-senarios" class="headerlink" title="Usage senarios"></a>Usage senarios</h3><p>whatâ€™s good senarios with cahce and bad with cache?</p><p>Good<br>1, low real-time requirements data<br>2, high concurrency, like home page for ecomerce website<br>3, hot zone data, like most viewed products<br>4, low consitency requirements  </p><p>Bad<br>1, high consistency requirements, like wallet withdraw<br>2, rarelly accessed data<br>3, data size too big, like the data is about 50M<br>4, admin api</p><h3 id="Cache-Types"><a href="#Cache-Types" class="headerlink" title="Cache Types"></a>Cache Types</h3><p>To summarize, there are following cache types:</p><pre><code>+------------------------------+   |                              |   |        Browser Cache         |   |                              |   +------------------------------+   +-----------------------------+    |                             |    |             CDN             |    |                             |    +-----------------------------+    +-----------------------------+    |                             |    |      Proxy Cache(Nginx)     |    |                             |    +-----------------------------+    +-----------------------------+    |                             |    |  Distributed Cache(Redis)   |    |                             |    +-----------------------------+    +-----------------------------+    |                             |    |      In Memory Cache        |    |                             |    +-----------------------------+    +-----------------------------+    |                             |    |         Database            |    |                             |    +-----------------------------+     </code></pre><p>As a back end developer, mostly we focus on <code>Distributed Cache</code> and <code>In memory cache</code>.</p><h3 id="cache-Patterns"><a href="#cache-Patterns" class="headerlink" title="cache Patterns"></a>cache Patterns</h3><h4 id="Cache-aside"><a href="#Cache-aside" class="headerlink" title="Cache aside"></a>Cache aside</h4><p>Application will operate DB and cache the same time. as following fig shows:<br><img src="/img/cache_aside.png" alt="cache aside"><br>1st, application first query cache, if hit, then use the data from cache<br>2nd, if 1st step not hit, query database directly, return the data<br>3rd, after 2nd step, set the cache with data from database to cache</p><p><img src="/img/cache_aside_read_write.png" alt="cache aside read write"></p><h4 id="Read-Write-through"><a href="#Read-Write-through" class="headerlink" title="Read/Write through"></a>Read/Write through</h4><p>normally application only interact with cache, it is the cache proxyâ€™s responsibility to sync data between cache and database.</p><p><img src="/img/read_write_through.png" alt="read write through"></p><h4 id="Write-behind"><a href="#Write-behind" class="headerlink" title="Write behind"></a>Write behind</h4><p>different from read/write through, data is sync to db from cache through cron job or message queue.</p><p><img src="/img/write_back.png" alt="write back"></p><p>For read-heavy task, <code>cache aside</code> and <code>read/write through</code> is a better choice, for write heavy task, <code>write behind</code> is a better choice.</p><h3 id="3-major-problems-and-solutions-in-cache-world"><a href="#3-major-problems-and-solutions-in-cache-world" class="headerlink" title="3 major problems and solutions in cache world"></a>3 major problems and solutions in cache world</h3><p>1, cache avalance<br>massive cache keys are expired or cache system down, thus lots of cache missing, then goes to database.<br>set different ttl for different keys, or deploy cache system as cluster.</p><p>2, cache breakdown<br>a cache key didnâ€™t hit, thus goes to database. sometimes this key will corresponds to high concurrency. thus lots of query goes to database.<br>set a gloable lock when query database for same key to gaurateen only a query goes to database.</p><p>3, cache penetration<br>the key not existing in cache, thus whenever you query, it will miss.<br>set this key to cache with value None.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;In this post i am gonna talk about cache, specifically on application level, will not cover the internals of cache such as Redis/Memcache implementation etc. will cover following topics:  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;What is cache&lt;/li&gt;
&lt;li&gt;Usage senarios&lt;/li&gt;
&lt;li&gt;Cache Types&lt;/li&gt;
&lt;li&gt;Cache Patterns&lt;/li&gt;
&lt;li&gt;3 major problems and solutions in cache world
    
    </summary>
    
      <category term="Cache" scheme="http://yoursite.com/categories/Cache/"/>
    
      <category term="Software Engineer" scheme="http://yoursite.com/categories/Cache/Software-Engineer/"/>
    
    
      <category term="Cache" scheme="http://yoursite.com/tags/Cache/"/>
    
      <category term="Backend" scheme="http://yoursite.com/tags/Backend/"/>
    
      <category term="Software Engineer" scheme="http://yoursite.com/tags/Software-Engineer/"/>
    
      <category term="Devlopper" scheme="http://yoursite.com/tags/Devlopper/"/>
    
  </entry>
  
  <entry>
    <title>Template Engine Internal</title>
    <link href="http://yoursite.com/2017/07/09/Template-Engine-Internal/"/>
    <id>http://yoursite.com/2017/07/09/Template-Engine-Internal/</id>
    <published>2017-07-09T08:38:28.000Z</published>
    <updated>2020-09-23T17:55:12.030Z</updated>
    
    <content type="html"><![CDATA[<ul><li>How template engine works? the basic principle behind this.</li><li>Implement a template engine</li><li>What about Jinjia2?<a id="more"></a></li></ul><h4 id="Basic-principle"><a href="#Basic-principle" class="headerlink" title="Basic principle"></a>Basic principle</h4><h5 id="Why-we-need-a-template-or-template-engine"><a href="#Why-we-need-a-template-or-template-engine" class="headerlink" title="Why we need a template or template engine?"></a>Why we need a template or template engine?</h5><p>Most programs contains lots of logic but little bit of textual data, and programming languages like Python, Java are designed to do this kind of job. but some programming tasks requires little logic but lots of textual data processing, for this kind of task, we need a better tool that suite for text-heavy problems â€“ such a tool named Template(Engine).<br>Note: you may wonder that you can still use programming languages like Clang processing text-heavy tasks, like assembling the html source code for the client. i will say that is okay but not efficient, plus your code will be a messy with statements and string literals. donâ€™t we programmers like modualize everything and make programming easier afterwards?</p><h5 id="Template-the-big-picture"><a href="#Template-the-big-picture" class="headerlink" title="Template: the big picture"></a>Template: the big picture</h5><p>Template is suite for text heavy tasks, especially where web server application need to return HTML page to the client. so basiclly it need to turn following template into a html string:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>Template<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>Hello &#123;&#123;username&#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>Template<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>Hello archer<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>How can we achieve this? there are two basic ways:</p><ul><li>with string substitution</li><li>code execution</li></ul><p>If chose string substitution, then we can use Pythonâ€™s format() replace the username with the value we want as follows:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line">Template_Page = <span class="string">"""</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">  &lt;head&gt;&lt;title&gt;Template&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">  &lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;h3&gt;Hello &#123;&#123;username&#125;&#125;&lt;/h3&gt;</span></span><br><span class="line"><span class="string">  &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">html = Template_Page.format(username=<span class="string">'string substitution'</span>)</span><br></pre></td></tr></table></figure><p>Here is the output of the variable html:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;&lt;title&gt;Template&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h3&gt;Hello string substitution&lt;/h3&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>If we chose to use code execution, then we need to convert this template html into a corresponding Python function, then we call this function with right parameters.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># string format</span></span><br><span class="line">fuck_str = <span class="string">"""</span></span><br><span class="line"><span class="string">def render_function(context):</span></span><br><span class="line"><span class="string">    c_person = context['username']</span></span><br><span class="line"><span class="string">    result = []</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    result.append('&lt;html&gt;\n&lt;head&gt;&lt;title&gt;Template&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;h3&gt;')</span></span><br><span class="line"><span class="string">    result.append(str(c_person))</span></span><br><span class="line"><span class="string">    result.append('&lt;/h3&gt;\n&lt;/body&gt;\n&lt;/html&gt;')</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return ''.join(result)</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">namespace = &#123;&#125;</span><br><span class="line">exec(fuck_str, namespace) <span class="comment"># will put render_function as a function into namespace, like JS's evil eval which will execute a string as a statements</span></span><br><span class="line">html = namespace.get(<span class="string">'render_function'</span>)(&#123;<span class="string">'username'</span>: <span class="string">'code execution'</span>&#125;)</span><br><span class="line"><span class="keyword">print</span> html</span><br></pre></td></tr></table></figure><p>Should got this</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>Template<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>Hello code execution<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>As you can see from upper, code execution tries to take templateâ€™s username as a Python variable and will use itâ€™s value instead of the variable name when assembling the html string.</p><p>A template file is like a programming source file, and template engine are like programming interpreter or a compiler. it takes template file in and produce the corresponding html. normally a template contains two parts, Static Part and Dynamic Part, template engine will interpret Dynamic Part with real data, like in upper example will replace username with its real value.</p><p>What u just saw is a very simple illustration? there are a lot of things need to take into consideration when you want to totally understand the Template Engine. like how to interpret or support loop controls, what about if else? these are very often used statements in Programming languages like Python.</p><p>Some engine just use string substitution, some use code execution totally, some mixed them up, so all engines sits between these two basic techs as following shows:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">code execution                                                   string substitution</span><br><span class="line">&lt;---------------------------------------|-------------------------------------------&gt;</span><br><span class="line">moko                       Jinja2 | Django | etc ...           .format(**kwargs)</span><br></pre></td></tr></table></figure><h4 id="Implementation-Detail"><a href="#Implementation-Detail" class="headerlink" title="Implementation Detail"></a>Implementation Detail</h4><p>The goal is turn following template(html mixed string) into real html string as you see in Jinja2. so question is how can we do this conversion? especially how can we interpret the variables, control statements?</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  Hello, &#123;&#123; username &#125;&#125;!</span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    &#123;% for job in job_list %&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123; job &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  Hello, archer!</span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>engineer<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>qa<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>pm<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>In an interpretation model, parsing produces a data structure representing the structure of the template. The rendering phase walks that data structure, assembling the result text based on the instructions it finds. For a real-world example, the Django template engine uses this approach.</p><p>In a compilation model, parsing produces some form of directly executable code. The rendering phase executes that code, producing the result. Jinja2 and Mako are two examples of template engines that use the compilation approach.</p><p>In this article, we use the compilation model, i.e in parsing phase, we will parse the template from string directly into Python code, i.e Python objects. and in rendering phase, we will execute the code and get the results.</p><p>Here is the design: class Templite responsible two things, first, parsing phase, accept template string, parse it and turn it into a render_func object, second, render phase, invoke and execute the render_func object.</p><p>In parsing phase, process template line by line, if met normal string literals, use CodeBuilder.add_line append this to the CodeBuilder.code list, especially in render_funcâ€™s result list. so you should see this:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CodeBuilder.add_line(<span class="string">'result.apend("&lt;html&gt;\nHello ") '</span>)</span><br></pre></td></tr></table></figure><p>If it is a expression, should append this variable into render_funcâ€™s result list, as follows:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CodeBuilder.add_line(str(username))</span><br></pre></td></tr></table></figure><p>when it finished parsing, CodeBuilder.code should contains all string code of the render_func, if you join them together, you will got following string:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">def render_function(context, do_dots):</span></span><br><span class="line"><span class="string">    c_username = context['username']</span></span><br><span class="line"><span class="string">    c_job_list = context['job_list']</span></span><br><span class="line"><span class="string">    result = []</span></span><br><span class="line"><span class="string">    append_result = result.append</span></span><br><span class="line"><span class="string">    extend_result = result.extend</span></span><br><span class="line"><span class="string">    to_str = str</span></span><br><span class="line"><span class="string">    extend_result(['\n&lt;html&gt;\n  Hello, ', to_str(c_username), '!\n  &lt;ul&gt;\n    '])</span></span><br><span class="line"><span class="string">    for c_job in c_job_list:</span></span><br><span class="line"><span class="string">        extend_result(['\n      &lt;li&gt;', to_str(c_job), '&lt;/li&gt;\n    '])</span></span><br><span class="line"><span class="string">    append_result('\n  &lt;/ul&gt;\n&lt;/html&gt;\n')</span></span><br><span class="line"><span class="string">    return ''.join(result)</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure><p>then use Pythonâ€™s exec turn this string into a real Python function object.</p><p>In render phase, you call render function, actually, it executes the render_func returned in parsing phase, and thus you got the real html.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Templite</span><span class="params">(object)</span>:</span></span><br><span class="line">  <span class="string">""" Template Engine Implmentation """</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, template)</span>:</span></span><br><span class="line">    <span class="string">""" responsible turn template from string into Python code object through CodeBuilder """</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">render</span><span class="params">(self, context)</span>:</span></span><br><span class="line">    <span class="string">""" run the code object prepared by __init__ with context data, will return the interpreted template in html format """</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CodeBuilder</span><span class="params">(object)</span>:</span></span><br><span class="line">  <span class="string">""" responsible for build a string representation of the render_function, and method that will return the string representation function to a Python code object """</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, indent = <span class="number">0</span>)</span>:</span></span><br><span class="line">    self.code = []</span><br><span class="line">    self.indent_level = indent</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">add_line</span><span class="params">(self, line)</span>:</span></span><br><span class="line">    <span class="string">""" add a line into code with right indentation """</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_render_fun</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">""" get render function in Python object """</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>Here is the data flow:<br>1st, input following template</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  Hello, &#123;&#123; person.username &#125;&#125;!</span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    &#123;% for job in job_list %&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123; job &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2nd, Templite.<strong>init</strong> will accept this template as input, and parse it, if necessary invoke CodeBuilder<br>3rd, CodeBuiler will receive the following phrase from Templite.<strong>init</strong></p><ul><li>html string literal</li><li>expressions</li><li>controll tags</li></ul><p>append each line into a code object after parse and conversion</p><p>append each line into a code object after parse and conversion<br>4th, here is what code object looks like</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line"><span class="string">'def render_function(context, do_dots):'</span>, <span class="string">'\n'</span>,</span><br><span class="line"><span class="string">'    '</span>, <span class="string">'result = []'</span>, <span class="string">'\n'</span>,</span><br><span class="line"><span class="string">'    '</span>, <span class="string">'append_result = result.append'</span>, <span class="string">'\n'</span>,</span><br><span class="line"><span class="string">'    '</span>, <span class="string">'extend_result = result.extend'</span>, <span class="string">'\n'</span>,</span><br><span class="line"><span class="string">'    '</span>, <span class="string">'to_str = str'</span>, <span class="string">'\n'</span>,</span><br><span class="line"><span class="string">'    '</span>, <span class="string">"extend_result(['\\n&lt;html&gt;\\n  Hello, ', to_str(c_username), '!\\n  &lt;ul&gt;\\n    '])"</span>, <span class="string">'\n'</span>,</span><br><span class="line"><span class="string">'    '</span>, <span class="string">'for c_job in c_job_list:'</span>, <span class="string">'\n'</span>,</span><br><span class="line"><span class="string">'        '</span>, <span class="string">"extend_result(['\\n      &lt;li&gt;', to_str(c_job), '&lt;/li&gt;\\n    '])"</span>, <span class="string">'\n'</span>,</span><br><span class="line"> <span class="string">'    '</span>, <span class="string">"append_result('\\n  &lt;/ul&gt;\\n&lt;/html&gt;\\n')"</span>, <span class="string">'\n'</span>,</span><br><span class="line"> <span class="string">'    '</span>, <span class="string">"return ''.join(result)"</span>, <span class="string">'\n'</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>5th, in render function, get the render function from code object through exec and  stringify</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_function</span><span class="params">(context, do_dots)</span>:</span></span><br><span class="line">    c_username = context[<span class="string">'username'</span>]</span><br><span class="line">    c_job_list = context[<span class="string">'job_list'</span>]</span><br><span class="line">    result = []</span><br><span class="line">    append_result = result.append</span><br><span class="line">    extend_result = result.extend</span><br><span class="line">    to_str = str</span><br><span class="line">    extend_result([<span class="string">'\n&lt;html&gt;\n  Hello, '</span>, to_str(c_username), <span class="string">'!\n  &lt;ul&gt;\n    '</span>])</span><br><span class="line">    <span class="keyword">for</span> c_job <span class="keyword">in</span> c_job_list:</span><br><span class="line">        extend_result([<span class="string">'\n      &lt;li&gt;'</span>, to_str(c_job), <span class="string">'&lt;/li&gt;\n    '</span>])</span><br><span class="line">    append_result(<span class="string">'\n  &lt;/ul&gt;\n&lt;/html&gt;\n'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(result)</span><br></pre></td></tr></table></figure><p>6th, run this render function with the context data you provide</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  Hello, archer!</span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>engineer<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>qa<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>pm<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>for detailed implementation, refer <a href="https://github.com/csrgxtu/TemplateEngine/blob/500lines/templite.py" target="_blank" rel="noopener">TemplateEngine</a></p>]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;How template engine works? the basic principle behind this.&lt;/li&gt;
&lt;li&gt;Implement a template engine&lt;/li&gt;
&lt;li&gt;What about Jinjia2?
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Poems</title>
    <link href="http://yoursite.com/2017/07/06/Poems/"/>
    <id>http://yoursite.com/2017/07/06/Poems/</id>
    <published>2017-07-06T14:23:20.000Z</published>
    <updated>2020-09-23T17:55:12.026Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ç¿»è¯‘æ–‡ç« çš„è¿‡ç¨‹ä¸­å¿½é‡å¦‚ä¸‹å¤è¯—å¥ï¼Œå°±æ‘˜å½•ä¸‹æ¥ï¼Œä»¥åæ•™ç»™å„¿å­ã€‚</p><a id="more"></a><blockquote><p>å°‘å°ç¦»å®¶è€å¤§å›ï¼Œå®‰èƒ½è¾©æˆ‘æ˜¯é›Œé›„ã€‚</p></blockquote><p>å‘½è‹¦çš„äººå•Šï¼Œä¸çŸ¥é“åœ¨åŒ—ä¸Šå¹¿ç»å†äº†ç¥é©¬ã€‚</p><blockquote><p>çº¢é…¥æ‰‹ï¼Œé»„è—¤é…’ï¼Œä¸¤ä¸ªé»„é¹‚åç¿ æŸ³ã€‚é•¿äº­å¤–ï¼Œå¤é“è¾¹ï¼Œä¸€è¡Œç™½é¹­ä¸Šæ™´å¤©ã€‚</p></blockquote><p>è¿™ä¸ªæ„å¢ƒå¾ˆç¾</p><blockquote><p>å¤œæ·±å¿½æ¢¦å°‘å¹´äº‹ï¼ŒæƒŸæ¢¦é—²äººä¸æ¢¦å›ã€‚</p></blockquote><p>åº”è¯¥å’Œâ€œå›â€æœ‰ä»‡ï¼Œæ•…æ„å›é¿ã€‚</p><blockquote><p>å€Ÿé—®é…’å®¶ä½•å¤„æœ‰ï¼Œå§‘è‹åŸå¤–å¯’å±±å¯ºã€‚</p></blockquote><p>çè¯´</p><blockquote><p>æ´›é˜³äº²å‹å¦‚ç›¸é—®ï¼Œè½»èˆŸå·²è¿‡ä¸‡é‡å±±ã€‚</p></blockquote><p>æ¬ å€ºé€ƒè·‘</p><blockquote><p>çˆ·å¨˜é—»å¥³æ¥ï¼Œä¸¾èº«èµ´æ¸…æ± ï¼›é˜¿å§Šé—»å¦¹æ¥ï¼Œè‡ªæŒ‚ä¸œå—æï¼›å°å¼Ÿé—»å§Šæ¥ï¼Œçµç¶å£°åœæ¬²è¯­è¿Ÿã€‚</p></blockquote><p>äººå“çœŸå·®ï¼Œè¿äº²äººéƒ½å›é¿</p><blockquote><p>åœ¨å¤©æ„¿åšæ¯”ç¿¼é¸Ÿï¼Œå¤§éš¾ä¸´å¤´å„è‡ªé£ã€‚</p></blockquote><p>å¦‚ä»Šçš„éƒ¨åˆ†çœŸå®å†™çœŸ</p><blockquote><p>ç¾äººå·ç å¸˜ï¼Œä¸‡å¾„äººè¸ªç­ã€‚ä¸¤å²¸çŒ¿å£°å•¼ä¸ä½ï¼ŒæƒŠèµ·è›™å£°ä¸€ç‰‡ã€‚</p></blockquote><p>è¿™æ˜¯ä¸ªç¾äººå—</p><blockquote><p>åŠå›æ›´å°½ä¸€æ¯é…’ï¼Œä»æ­¤è§éƒæ˜¯è·¯äººã€‚</p></blockquote><p>å¦‚æ­¤ç»æƒ…å‘€</p><blockquote><p>é¥æƒ³å…¬è°¨å½“å¹´ï¼Œå°ä¹”åˆå«äº†ï¼Œä½¿æˆ‘ä¸å¾—å¼€å¿ƒé¢œï¼</p></blockquote><p>æˆ‘å¿ƒçˆ±çš„ç”·é“¶å«ç»™äº†ä¸€ä¸ªå¥³çš„</p><blockquote><p>å‚æ­»ç—…ä¸­æƒŠåèµ·ï¼Œç¬‘é—®å®¢ä»ä½•å¤„æ¥</p></blockquote><p>å›å…‰è¿”ç…§</p><blockquote><p>è½¦è¾šè¾šï¼Œé©¬è§è§ï¼ŒäºŒæœˆæ˜¥é£ä¼¼å‰ªåˆ€ã€‚</p></blockquote><p>è´¾åºœæœ¬å¤ªæ‚²è§‚</p><blockquote><p>æ»¡å ‚èŠ±é†‰ä¸‰åƒå®¢ï¼Œæ›´æ— ä¸€äººæ˜¯çŸ¥éŸ³ã€‚</p></blockquote><p>å¤©æ‰æ˜¯å­¤ç‹¬çš„</p><blockquote><p>å‚æ­»ç—…ä¸­æƒŠåèµ·ï¼Œå¤œæ·±è¿˜è¿‡å¥³å«±æ¥ã€‚</p></blockquote><p>æƒ³åˆ°äº†ç™½å­æ–‡</p><blockquote><p>è¸ç ´é“é‹æ— è§…å¤„ï¼Œé‚£äººå´åœ¨ç¯ç«é˜‘çŠå¤„ã€‚</p></blockquote><p>çœ‹æˆ‘ä¸é”¤æ­»ä½ </p><blockquote><p>é—®å›èƒ½æœ‰å‡ å¤šæ„ï¼Œåˆ«æ˜¯ä¸€ç•ªæ»‹å‘³åœ¨å¿ƒå¤´ã€‚</p></blockquote><p>åæ­£è¨€è¯­ä¸æ¸…</p><blockquote><p>é£æµç›´ä¸‹ä¸‰åƒå°ºï¼Œä¸åŠæ±ªä¼¦é€æˆ‘æƒ…ã€‚</p></blockquote><p>æ±ªä¼¦æŠŠä½ å’‹äº†</p><blockquote><p>è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œå£®å£«ä¸€å»å…®ä¸å¤è¿”ï¼</p></blockquote><p>å³æœ‰ç§¯æï¼Œåˆæœ‰æ‚²è§‚</p><blockquote><p>å¹½å·å¸é©¬é’è¡«æ¹¿ï¼Œå¹¶å·å¤ªå®ˆçŸ¥ä¸çŸ¥ã€‚</p></blockquote><p>æ˜¯çŸ¥éŸ³è¿˜æ˜¯æœºæƒ…</p><blockquote><p>å¤©è‹è‹ï¼Œé‡èŒ«èŒ«ï¼Œä¸€æ ‘æ¢¨èŠ±å‹æµ·æ£ ã€‚</p></blockquote><p>æ˜¥å…‰ä¹æ³„</p><blockquote><p>æ˜¥å®µä¸€åˆ»å€¼åƒé‡‘ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œã€‚<br>åå®«ä½³ä¸½ä¸‰åƒäººï¼Œé“æµç£¨æˆç»£èŠ±é’ˆã€‚</p></blockquote><p>â€“</p><blockquote><p>åºŠå‰æ˜æœˆå…‰ï¼Œå¯¹å½±æˆä¸‰äººã€‚</p></blockquote><p>å¬è¯´æç™½å¾ˆæµªè¡</p><blockquote><p>äººç”Ÿå¾—æ„é¡»å°½æ¬¢ï¼Œä»æ­¤å›ç‹ä¸æ—©æœã€‚<br>æœ•ä¸å…ˆç”Ÿè§£æˆ˜è¢ï¼ŒèŠ™è“‰å¸æš–åº¦æ˜¥å®µã€‚</p></blockquote><p>å›ç‹ä¹Ÿå¾ˆè‹¦</p><blockquote><p>å”§å”§å¤å”§å”§ï¼Œç›¸ç…ä½•å¤ªæ€¥<br>ç™½æ—¥ä¾å±±å°½ï¼Œå¤§æ¼ å­¤çƒŸç›´ã€‚<br>ä¸¤å²¸çŒ¿å£°å•¼ä¸ä½ï¼Œä¸€æçº¢æå‡ºå¢™æ¥<br>ä½†ä½¿é£é¾™å°†å†›åœ¨ï¼Œå…­å®«ç²‰é»›æ— é¢œè‰²<br>æ˜¥æ±Ÿæ°´æš–é¸­å…ˆçŸ¥ï¼Œå®£åŸå¤ªå®ˆçŸ¥ä¸çŸ¥<br>è½¦åˆ°å±±å‰å¿…æœ‰è·¯ï¼Œåƒé‡‘æ•£å°½è¿˜å¤æ¥ã€‚<br>é˜¿å§Šé—»å¦¹æ¥ï¼Œå½“æˆ·ç†çº¢å¦†ï¼Œå°å¼Ÿé—»å§æ¥ï¼Œç£¨åˆ€åš¯åš¯å‘çˆ¹å¨˜<br>æ¾ä¸‹é—®ç«¥å­ è‡ªæŒ‚ä¸œå—æ<br>å¬å›ä¸€å¸­è¯ï¼Œè‡ªæŒ‚ä¸œå—æ<br>ä»Šæ—¥å¬å›æ­Œä¸€æ›²ï¼Œæ˜æœè‡ªæŒ‚ä¸œå—æ<br>äººç”Ÿå¾—æ„é¡»å°½æ¬¢,ä¸åŠæ±ªä¼¦é€æˆ‘æƒ…<br>æˆ‘è‡ªæ¨ªåˆ€å‘å¤©ç¬‘ æ— äººçŸ¥æ˜¯è”ææ¥<br>æœ•ä¸å…ˆç”Ÿè§£æˆ˜è¢ï¼Œå®£åŸå¤ªå®ˆçŸ¥ä¸çŸ¥  </p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ç¿»è¯‘æ–‡ç« çš„è¿‡ç¨‹ä¸­å¿½é‡å¦‚ä¸‹å¤è¯—å¥ï¼Œå°±æ‘˜å½•ä¸‹æ¥ï¼Œä»¥åæ•™ç»™å„¿å­ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤è¯—" scheme="http://yoursite.com/tags/%E5%8F%A4%E8%AF%97/"/>
    
  </entry>
  
</feed>
